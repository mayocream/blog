<!doctype html><html lang=zh-hans><head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<title>WAF æºç åˆ†æ - Mayo's Blog</title>
<meta name=description content="æºç åˆ†æä¸»è¦é’ˆå¯¹è§„åˆ™å¼•æ“éƒ¨åˆ†è¿›è¡Œè§£æï¼Œä»¥æ›´å¥½åœ°ç†è§£ WAF è§„åˆ™çš„åŠ è½½å’Œæ‰§è¡Œè¿‡ç¨‹ï¼Œå¹³å°è®¾è®¡æ—¶èƒ½å¤Ÿæœ‰æ›´ä¸°å¯Œçš„æ€è€ƒã€‚æœªé˜…è¯»çš„æºç éƒ¨åˆ†è¿˜åŒ…å« Perl è„šæœ¬å¯¹ ModSecurity è§„åˆ™">
<meta name=author content>
<link rel=preconnect href=https://cdn.jsdelivr.net>
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css?family=Crimson+Text:400,700|Press+Start+2P" rel=stylesheet>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400&family=Noto+Sans+JP:wght@300;400&family=Noto+Sans+SC:wght@300;400&family=Noto+Serif:wght@300;400&family=Noto+Serif+JP:wght@300;400&family=Noto+Serif+SC:wght@300;400&family=Source+Code+Pro:wght@300;400" rel=stylesheet>
<link rel=stylesheet href="/bundle.css?v=1636177403" media=all>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/tocbot/dist/tocbot.css>
<link rel=icon href=https://github.com/mayocream.png><meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://shoujo.ink/2021/11/waf-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-JKVXF5HSKT','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<meta property="og:title" content="WAF æºç åˆ†æ">
<meta property="og:description" content="æºç åˆ†æä¸»è¦é’ˆå¯¹è§„åˆ™å¼•æ“éƒ¨åˆ†è¿›è¡Œè§£æï¼Œä»¥æ›´å¥½åœ°ç†è§£ WAF è§„åˆ™çš„åŠ è½½å’Œæ‰§è¡Œè¿‡ç¨‹ï¼Œå¹³å°è®¾è®¡æ—¶èƒ½å¤Ÿæœ‰æ›´ä¸°å¯Œçš„æ€è€ƒã€‚æœªé˜…è¯»çš„æºç éƒ¨åˆ†è¿˜åŒ…å« Perl è„šæœ¬å¯¹ ModSecurity è§„åˆ™">
<meta property="og:type" content="article">
<meta property="og:url" content="https://shoujo.ink/2021/11/waf-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-11-06T13:40:00+08:00">
<meta property="article:modified_time" content="2021-11-06T13:40:00+08:00"><meta property="og:site_name" content="Mayo's Blog">
</head>
</html>
<body><script src=https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js></script>
<script>const opts={bottom:'32px',right:'unset',left:'32px',time:'0.3s',mixColor:'#fff',backgroundColor:'#fff',buttonColorDark:'#100f2c',buttonColorLight:'#fff',saveInCookies:!0,label:'ğŸŒ“',autoMatchOsTheme:!0};let darkmode;window.matchMedia('only screen and (min-width: 680px)').matches?(darkmode=new Darkmode(opts),darkmode.showWidget()):(localStorage.removeItem('darkmode'),darkmode=new Darkmode(opts)),window.darkmode=darkmode,document.addEventListener('DOMContentLoaded',function(){document.body.style.opacity=1})</script>
<main class=page-content aria-label=Content>
<div class=wrapper><nav class=site-nav>
<a class=page-link href=/posts/>Posts</a>
<a class=page-link href=/about/>About</a>
</nav><header class=post-header>
<a class=site-title href=https://shoujo.ink>Mayo's Blog</a>
<h1 class="post-title baseline-fix typeface-sans" lang=zh-hans itemprop="name headline">WAF æºç åˆ†æ</h1>
</header>
<div class=post-cover aria-label=Cover>
<div class=post-cover-wrapper>
<img src alt>
</div>
<div class=cover-meta></div>
</div>
<div class=post-layout>
<article class="post typeface-sans" lang=zh-hans itemscope itemtype=http://schema.org/BlogPosting>
<div class=post-content itemprop=articleBody>
<blockquote>
<p>æºç åˆ†æä¸»è¦é’ˆå¯¹è§„åˆ™å¼•æ“éƒ¨åˆ†è¿›è¡Œè§£æï¼Œä»¥æ›´å¥½åœ°ç†è§£ WAF è§„åˆ™çš„åŠ è½½å’Œæ‰§è¡Œè¿‡ç¨‹ï¼Œå¹³å°è®¾è®¡æ—¶èƒ½å¤Ÿæœ‰æ›´ä¸°å¯Œçš„æ€è€ƒã€‚æœªé˜…è¯»çš„æºç éƒ¨åˆ†è¿˜åŒ…å« Perl è„šæœ¬å¯¹ ModSecurity è§„åˆ™è½¬æ¢å’Œ Test::Nginx å•å…ƒæµ‹è¯•éƒ¨åˆ†ã€‚</p>
</blockquote>
<h2 id=1-è§„åˆ™å¼•æ“>1. è§„åˆ™å¼•æ“</h2>
<p>åº”ç”¨ç½‘ç»œé˜²ç«å¢™ï¼ˆWAFï¼‰çš„æ ¸å¿ƒæ˜¯è§„åˆ™å¼•æ“ï¼Œè§„åˆ™å¼•æ“å®ç°äº†è§„åˆ™é›†çš„ç¼–æ’ã€è®¡ç®—ï¼ŒåŸºäºè§„åˆ™é›†èƒ½å¤Ÿå®ç°ä¸°å¯Œçš„æ‹¦æˆªç­–ç•¥ã€‚</p>
<p>å•†ä¸š WAF äº§å“çš„è§„åˆ™é›†åŒ…å«ï¼š</p>
<ol>
<li><strong>OWASP ModSecurity æ ¸å¿ƒè§„åˆ™é›†</strong></li>
<li><strong>å¹³å°æ‰˜ç®¡è§„åˆ™é›†</strong></li>
<li><strong>ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™</strong></li>
</ol>
<h3 id=11-è§„åˆ™é›†>1.1. è§„åˆ™é›†</h3>
<h4 id=111-owasp-modsecurity-æ ¸å¿ƒè§„åˆ™é›†>1.1.1. OWASP ModSecurity æ ¸å¿ƒè§„åˆ™é›†</h4>
<blockquote>
<p>OWASP ModSecurity æ ¸å¿ƒè§„åˆ™é›†åŒ…å«æ¥è‡ªäº OWASP é¡¹ç›®çš„è‹¥å¹²è§„åˆ™ã€‚å¹³å°ä¸ç¼–å†™æˆ–ç®¡ç† OWASP è§„åˆ™ã€‚</p>
</blockquote>
<p><strong>OWASP ModSecurity æ ¸å¿ƒè§„åˆ™é›†</strong>æ ¹æ®è§¦å‘çš„ OWASP è§„åˆ™æ•°é‡ä¸ºæ¯ä¸ªè¯·æ±‚æŒ‡å®šä¸€ä¸ªåˆ†æ•°ã€‚æŸäº› OWASP è§„åˆ™çš„æ•æ„Ÿåº¦åˆ†æ•°é«˜äºå…¶ä»–è§„åˆ™ã€‚åœ¨ OWASP è¯„ä¼°è¯·æ±‚åï¼ŒCloudflare ä¼šå°†æœ€ç»ˆåˆ†æ•°ä¸ä¸ºè¯¥åŸŸåé…ç½®çš„<strong>å±é™©é˜ˆå€¼</strong>è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœåˆ†æ•°è¶…è¿‡<strong>å±é™©é˜ˆå€¼</strong>ï¼Œåˆ™æ ¹æ® <strong>OWASP ModSecurity æ ¸å¿ƒè§„åˆ™é›†</strong>ä¸­é…ç½®çš„<strong>æ“ä½œ</strong>æ¥å¤„ç†è¿™ä¸ªè¯·æ±‚ã€‚</p>
<ul>
<li>é˜»æ­¢ - è¯·æ±‚è¢«ä¸¢å¼ƒã€‚</li>
<li>è®°å½• - æ”¾è¡Œè¯·æ±‚ï¼Œåªè®°å½•å®¡è®¡æ—¥å¿—ã€‚</li>
</ul>
<p>å¯¹äºå…·ä½“çš„<strong>å±é™©é˜ˆå€¼</strong>ï¼Œè§¦å‘ WAF æ‰€éœ€çš„æ•æ„Ÿåº¦å¾—åˆ†å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä½ - 60 åŠä»¥ä¸Š</li>
<li>ä¸­ - 40 åŠä»¥ä¸Š</li>
<li>é«˜ - 25 åŠä»¥ä¸Š</li>
</ul>
<p>
<figure class=image>
<img src=/2021/11/waf-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/images/https://s3-us-west-2.amazonaws.com/secure.notion-static.com/6db60e1d-1a01-4fa6-95d0-f977c72acd90/Untitled.png alt=img loading=lazy>
<figcaption>img</figcaption>
</figure></p>
<h4 id=112-å¹³å°æ‰˜ç®¡è§„åˆ™é›†>1.1.2. å¹³å°æ‰˜ç®¡è§„åˆ™é›†</h4>
<blockquote>
<p>å¹³å°æ‰˜ç®¡è§„åˆ™é›†åŒ…å«ç”±å¹³å°æ–¹ç¼–å†™å’Œç®¡ç†çš„å®‰å…¨è§„åˆ™ã€‚</p>
</blockquote>
<p>é’ˆå¯¹ MSP å¹³å°æ‰˜ç®¡çš„æœåŠ¡å¤§å¤šæ•°ä¸ºå‰åç«¯åˆ†ç¦»ï¼ŒAPI è°ƒç”¨çš„æ¨¡å¼ï¼Œé’ˆå¯¹å¹³å°æœåŠ¡å®šåˆ¶ã€‚</p>
<p><strong>æ‰˜ç®¡è§„åˆ™é›†</strong>å†…å„æ¡è§„åˆ™å¯ç”¨çš„<strong>æ¨¡å¼</strong>åŒ…æ‹¬ï¼š</p>
<ul>
<li>é»˜è®¤ - é‡‡å–æŸ¥çœ‹å…·ä½“è§„åˆ™æ—¶åˆ—åœ¨ä¸‹çš„é»˜è®¤æ“ä½œã€‚</li>
<li>ç¦ç”¨ - ä¸å¯ç”¨è§„åˆ™é›†ã€‚</li>
<li>é˜»æ­¢ - è¯·æ±‚è¢«ä¸¢å¼ƒã€‚</li>
<li>è®°å½• - æ”¾è¡Œè¯·æ±‚ï¼Œåªè®°å½•å®¡è®¡æ—¥å¿—ã€‚</li>
</ul>
<h4 id=113-ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™é›†>1.1.3. ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™é›†</h4>
<p>å…è®¸ç”¨æˆ·å¯¹äºè·¯ç”±çº§åˆ«å¯ç”¨ WAF åŠŸèƒ½ï¼Œè®¾å®šè‡ªå®šä¹‰çš„ WAF è§„åˆ™ã€‚</p>
<p>ä½¿ç”¨é€šç”¨çš„ WAF è®¾ç½®è¯­æ³•ï¼Œå¹³å°æä¾›ç»Ÿä¸€çš„ç•Œé¢å¯è§†åŒ–æ“ä½œã€‚</p>
<p>
<figure class=image>
<img src=/2021/11/waf-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/images/https://s3-us-west-2.amazonaws.com/secure.notion-static.com/28dde025-7113-42f0-ac31-0bced664f089/Untitled.png alt=img loading=lazy>
<figcaption>img</figcaption>
</figure></p>
<h3 id=12-è§„åˆ™ç¼–å†™>1.2. è§„åˆ™ç¼–å†™</h3>
<p>ç½®äº Kong ç½‘å…³çš„ WAF æ¨¡å—æ˜¯åŸºäº Lua è„šæœ¬ï¼ˆlua-resty-coreï¼‰ç»“åˆ C æ¨¡å— FFI è°ƒç”¨çš„é«˜æ€§èƒ½ WAF åº“äºŒæ¬¡å¼€å‘çš„ã€‚</p>
<p>å…¶å†…ç½®çš„è§„åˆ™å¼•æ“ä½¿ç”¨ JSON ç¼–å†™ï¼Œæä¾›å¤šç§çµæ´»çš„æ“ä½œå’Œç»„åˆã€‚</p>
<h4 id=121-è§„åˆ™ç¤ºä¾‹>1.2.1. è§„åˆ™ç¤ºä¾‹</h4>
<pre><code class=language-json>{
   // è¡¨ç¤ºåœ¨ Nginx ä¸­è¯·æ±‚çš„ Access é˜¶æ®µè¿è¡Œ
   &quot;access&quot; : [ // è§„åˆ™é›†ä½¿ç”¨æ•°ç»„, æŒ‰é¡ºåºç¼–æ’
      {
         // æ“ä½œç±»å‹
         &quot;actions&quot; : {
            &quot;disrupt&quot; : &quot;CHAIN&quot; // é“¾å¼æ¡ä»¶ç»„åˆ, æœ¬èº«ä¸æ‰§è¡Œä»»ä½•åŠ¨ä½œ
         },
         &quot;id&quot; : 11001, // è§„åˆ™çš„ ID, ä¼šåœ¨å®¡è®¡æ—¥å¿—ä¸­ä½¿ç”¨
         &quot;msg&quot; : &quot;Ignore passive requests with no arguments&quot;, // è§„åˆ™çš„æè¿°
         &quot;operator&quot; : &quot;REFIND&quot;, // è§„åˆ™çš„è¿ç®—ç¬¦ï¼ŒREFIND ä»£è¡¨ ngx.re.find, é€šä¿—æ¥è¯´æ˜¯ Match è¿ç®—
         &quot;opts&quot; : {
            &quot;nolog&quot; : true // ä¸è®°å½•æ—¥å¿—
         },
         &quot;pattern&quot; : &quot;^(?:GET|HEAD)$&quot;, // åŒ¹é…å€¼çš„æ­£åˆ™è¡¨è¾¾å¼, åŒ¹é… GET æˆ– HEAD
         &quot;vars&quot; : [ 
            {
               &quot;type&quot; : &quot;METHOD&quot; // åŒ¹é…è¯·æ±‚çš„å­—æ®µå, è¿™é‡Œä¸º HTTP Method
            }
         ]
      },
      {
         &quot;actions&quot; : {
            &quot;disrupt&quot; : &quot;ACCEPT&quot; // æ“ä½œç±»å‹ä¸ºå…è®¸
         },
         &quot;id&quot; : 11002,
         &quot;msg&quot; : &quot;Ignore passive requests with no arguments&quot;,
         &quot;op_negated&quot; : 1, // è¡¨ç¤ºå–å, å³ä¸ç­‰äº
         &quot;operator&quot; : &quot;REFIND&quot;,
         &quot;opts&quot; : {
            &quot;nolog&quot; : true // ä¸è®°å½•æ—¥å¿—
         },
         &quot;pattern&quot; : &quot;.*&quot;, // åŒ¹é…ä»»ä½•å€¼
         &quot;vars&quot; : [
            {
               &quot;parse&quot; : [ // è¡¨ç¤ºè§£ææ‰€æœ‰å­—ç¬¦ä¸²
                  &quot;all&quot;,
                  1
               ],
               &quot;type&quot; : &quot;REQUEST_ARGS&quot; // åŒ¹é…è¯·æ±‚çš„å­—æ®µ, è¿™é‡Œä¸º URI æŸ¥è¯¢å­—ç¬¦ä¸²
            }
         ]
      }
   ]
}
</code></pre>
<p>ä¸Šè¿°çš„ç¤ºä¾‹è§„åˆ™è¡¨ç¤ºï¼šå½“ä¼ å…¥çš„è¯·æ±‚ â€œHTTP è¯·æ±‚æ–¹æ³•â€ <em>æ­£åˆ™åŒ¹é…</em> <code>^(GET/HEAD)$</code> ï¼Œä¸” &ldquo;URI æŸ¥è¯¢å­—ç¬¦ä¸²&rdquo; ä¸ºç©ºæ—¶ï¼Œ<em>å…è®¸</em> è¯¥è¯·æ±‚ã€‚</p>
<h4 id=122-è§„åˆ™å¤„ç†æ¦‚è¿°>1.2.2. è§„åˆ™å¤„ç†æ¦‚è¿°</h4>
<p>
<figure class=image>
<img src=/2021/11/waf-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/images/https://s3-us-west-2.amazonaws.com/secure.notion-static.com/14fa86e6-413f-45b4-9b5a-cb9e5000a44d/Untitled.png alt=è§„åˆ™è§£æ loading=lazy>
<figcaption>è§„åˆ™è§£æ</figcaption>
</figure></p>
<h3 id=13-è§„åˆ™ç¼–æ’>1.3. è§„åˆ™ç¼–æ’</h3>
<p>è§„åˆ™ç¼–æ’åœ¨ lua-resty-waf ä¸­ç§°ä½œ <em><strong>è§„åˆ™é¢„å¤„ç†</strong></em>ï¼Œåœ¨ <code>rule_calc.lua</code> æ–‡ä»¶ä¸­ï¼Œä¸»è¦çš„è¡Œä¸ºåŒ…å«ï¼š</p>
<ol>
<li>è§„åˆ™ä¸»é”®æ¡ç›®å”¯ä¸€ KEY æ„å»º</li>
<li>è§„åˆ™ç»„æ„å»ºï¼ˆç´¢å¼•ä¼˜åŒ–ï¼‰</li>
</ol>
<h4 id=131-è§„åˆ™ä¸»é”®è®¡ç®—>1.3.1. è§„åˆ™ä¸»é”®è®¡ç®—</h4>
<p>ä¸ºæ¯ä¸€è¡Œè§„åˆ™ç”Ÿæˆ KEYï¼Œä½œä¸ºç¼“å­˜ KEY ä½¿ç”¨ã€‚</p>
<p>å°†è§„åˆ™ä¸­ Lua Table å¹³é“ºä¸º Stringã€‚</p>
<pre><code class=language-lua>-- ç”Ÿæˆ transform çš„ KEY
local function _transform_collection_key(transform)
	if not transform then
		return nil
	end

	if type(transform) ~= 'table' then
		return tostring(transform)
	else
		return table_concat(transform, ',')
	end
end

-- è®¡ç®—è§„åˆ™ä¸»é”® (KEY)
local function _build_collection_key(var, transform)
	local key = {}
	-- TYPE ä¸ºè§„åˆ™æŸ¥è¯¢çš„å˜é‡å
	key[1] = tostring(var.type)

	if var.parse ~= nil then
		table_insert(key, tostring(var.parse[1]))
		table_insert(key, tostring(var.parse[2]))
	end

	if var.ignore ~= nil then
		table_insert(key, tostring(_ignore_collection_key(var.ignore)))
	end

	table_insert(key, tostring(_transform_collection_key(transform)))

	return table_concat(key, &quot;|&quot;)
end
</code></pre>
<p><code>transform</code> ç¼“å­˜åœ¨ Lua Tableï¼Œè§„åˆ™ä¸»é”®ä½œä¸º KEY å¿«é€ŸæŸ¥æ‰¾ã€‚</p>
<pre><code class=language-lua>local function _build_collection(self, rule, var, collections, ctx, opts)
    ...

	-- è§„åˆ™ä¸»é”®
	local collection_key = var.collection_key
	local collection

	--_LOG_&quot;Checking for collection_key &quot; .. collection_key

	if not var.storage and not ctx.transform_key[collection_key] then
		--_LOG_&quot;Collection cache miss&quot;
		-- è·å–è§„åˆ™éœ€è¦çš„æ‰€æœ‰æ•°æ®
		-- å•ä¸ªå€¼æˆ–è€…æ•°ç»„
		collection = _parse_collection(self, collections[var.type], var)

		-- å¯¹æ•°æ®é›†è¿›è¡Œè½¬æ¢
		if opts.transform then
			collection = _do_transform(self, collection, opts.transform)
		end

		-- Lua table ç¼“å­˜å·²è½¬æ¢çš„æ•°æ®é›†
		ctx.transform[collection_key]     = collection
		ctx.transform_key[collection_key] = true
	elseif var.storage then
		--_LOG_&quot;Forcing cache miss&quot;
		collection = _parse_collection(self, collections[var.type], var)
	else
		--_LOG_&quot;Collection cache hit!&quot;
		collection = ctx.transform[collection_key]
	end

    ...

	return collection
end
</code></pre>
<h4 id=132-è§„åˆ™é¢„å¤„ç†>1.3.2. è§„åˆ™é¢„å¤„ç†</h4>
<p>è§„åˆ™å¼•æ“å¯¹äºè§„åˆ™åŒ¹é…æ˜¯éå†æ“ä½œï¼Œé¢„å¤„ç†ä¸­ä¸ºè§„åˆ™åŒ¹é…æˆåŠŸæˆ–å¤±è´¥çš„åç»­è¡Œä¸ºåšå‡ºåˆ¤æ–­ï¼Œåœ¨è§„åˆ™æ¡ç›®ä¸­å¢åŠ  <code>offset_match</code> å’Œ <code>offset_nomatch</code> ä¸¤ä¸ªå€¼ã€‚</p>
<pre><code class=language-lua>-- æ·»åŠ é“¾è§„åˆ™ offset 
-- æ¥æ”¶å‚æ•°  [è§„åˆ™é“¾, æ€»è§„åˆ™æ•°, è§„åˆ™é“¾èµ·å§‹ index]
local function _write_chain_offsets(chain, max, cur_offset)
	-- è§„åˆ™é“¾é•¿åº¦
	local chain_length = #chain
	-- å€’å™éå† index
	local offset = chain_length

	-- éå†è§„åˆ™
	for i = 1, chain_length do
		local rule = chain[i]

		-- å½“å‰ chain æ˜¯å¦åœ¨æœ€æœ«å°¾
		if offset + cur_offset &gt;= max then -- TODO è¿™ä¸ªè¡¨è¾¾å¼å¯ä»¥ç®€åŒ–
			rule.offset_nomatch = nil -- é»˜è®¤, æ²¡æœ‰ä¸‹ä¸€æ¡è§„åˆ™é“¾äº†
			if rule.actions.disrupt == &quot;CHAIN&quot; then
				rule.offset_match = 1 -- ä¸‹æ¬¡æ‰§è¡Œå¢åŠ  1
			else
				rule.offset_match = nil -- æ²¡æœ‰ä¸‹ä¸€æ¡è§„åˆ™é“¾äº†
			end
		else
			rule.offset_nomatch = offset -- è·³è¿‡å½“å‰çš„å‰©ä½™è§„åˆ™, æ‰§è¡Œä¸‹ä¸€ç»„è§„åˆ™
			rule.offset_match = 1
		end

		cur_offset = cur_offset + 1
		offset = offset - 1
	end
end
</code></pre>
<p>åœ¨è§„åˆ™éå†æ—¶ï¼Œå¼•æ“ä¼šæ ¹æ®è§„åˆ™çš„ <code>offset</code> å†³å®šä¸‹ä¸€è¡Œè§„åˆ™çš„ç´¢å¼•ï¼Œè·³è¿‡ä¸å¿…è¦çš„è§„åˆ™æ‰§è¡Œï¼Œæå‡æ•ˆç‡ã€‚</p>
<pre><code class=language-lua>-- è§„åˆ™é›†ç¼–æ’
function _M.calculate(ruleset, meta_lookup)
	-- è§„åˆ™æ¡ç›®æ•°
	local max = #ruleset
	-- å‚¨å­˜ä¸€æ¡è§„åˆ™é“¾
	local chain = {}

	-- éå†è§„åˆ™é›†
	for i = 1, max do
		-- å•æ¡è§„åˆ™
		local rule = ruleset[i]

		-- æ˜¯å¦æœ‰å•ç‹¬çš„é…ç½®é¡¹
		if not rule.opts then rule.opts = {} end

		-- å‚¨å­˜å½“å‰è§„åˆ™é“¾
		chain[#chain + 1] = rule

		-- VAR é€šå¸¸åªæœ‰ä¸€ä¸ªå…ƒç´ 
		for i in ipairs(rule.vars) do
			local var = rule.vars[i]
			-- è®¡ç®—è§„åˆ™ä¸»é”®
			var.collection_key = _build_collection_key(var, rule.opts.transform)
		end

		-- è§„åˆ™çš„åŠ¨ä½œé CHAIN, å¯èƒ½æ˜¯ [ACCEPT,DENY,DROP,IGNORE]
		if rule.actions.disrupt ~= &quot;CHAIN&quot; then
			-- è®¡ç®—è§„åˆ™é“¾å¢åŠ çš„ step
			-- ä¼ å…¥å‚æ•° [è§„åˆ™é“¾, æ€»è§„åˆ™æ•°, è§„åˆ™é“¾èµ·å§‹ index]
			_write_chain_offsets(chain, max, i - #chain)

			if rule.skip then
				-- è·³è¿‡ä¸€ç»„è§„åˆ™
				_write_skip_offset(rule, max, i)
			elseif rule.skip_after then
				...
			end

			-- è·³å‡ºå½“å‰è§„åˆ™é“¾
			chain = {}
		end

		...
	end
end
</code></pre>
<p>ç¤ºæ„å›¾ï¼š</p>
<p>
<figure class=image>
<img src=/2021/11/waf-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/images/image-20210813182139716.png alt=image-20210813182139716 loading=lazy>
<figcaption>image-20210813182139716</figcaption>
</figure></p>
<h3 id=14-æ•°æ®ç»‘å®š>1.4. æ•°æ®ç»‘å®š</h3>
<h4 id=141-æ•°æ®é›†æ„å»º>1.4.1. æ•°æ®é›†æ„å»º</h4>
<p>è§„åˆ™å¼•æ“åœ¨æ¯æ¬¡å¤„ç†è¯·æ±‚æ—¶ï¼Œéƒ½è¦è¿›è¡Œæ•°æ®é›†çš„æ„å»ºï¼Œæ•°æ®é›†åŒ…å«äº† Nginx è¯·æ±‚çš„åŸºæœ¬ä¿¡æ¯ï¼Œä¾‹å¦‚ HTTP Headerï¼ŒURIï¼ŒURI æŸ¥è¯¢å­—ç¬¦ä¸²ç­‰ã€‚</p>
<p>è§„åˆ™å¼•æ“ä¼šæ ¹æ®æ¯ä¸ªæ‰§è¡Œé˜¶æ®µï¼ˆPhaseï¼‰åŠ è½½å¯¹äºçš„ç¯å¢ƒå˜é‡ã€‚</p>
<pre><code class=language-lua>-- è§„åˆ™è§£æ, æ•°æ®ç»‘å®š, TODO åªåŠ è½½å¿…è¦çš„æ•°æ®
_M.lookup = {
	access = function(waf, collections, ctx)
		local request_headers     = ngx.req.get_headers()
		local request_var         = ngx.var.request
		local request_method      = ngx.req.get_method()
		local request_uri_args    = ngx.req.get_uri_args()
		local request_uri         = request.request_uri()
		local request_uri_raw     = request.request_uri_raw(request_var, request_method)
		local request_basename    = request.basename(waf, ngx.var.uri)
		local request_body        = request.parse_request_body(waf, request_headers, collections)
		local request_cookies     = request.cookies() or {}
		local request_common_args = request.common_args({ request_uri_args, request_body, request_cookies })
		local query_string        = ngx.var.query_string

		local query_str_size = query_string and #query_string or 0
		local body_size = ngx.var.http_content_length and tonumber(ngx.var.http_content_length) or 0

		collections.REMOTE_ADDR       = ngx.var.remote_addr
		collections.HTTP_VERSION      = ngx.req.http_version()
		collections.METHOD            = request_method
		collections.URI               = ngx.var.uri
		collections.URI_ARGS          = request_uri_args
		collections.QUERY_STRING      = query_string
		collections.REQUEST_URI       = request_uri
		collections.REQUEST_URI_RAW   = request_uri_raw
		collections.REQUEST_BASENAME  = request_basename
		collections.REQUEST_HEADERS   = request_headers
		collections.COOKIES           = request_cookies
		collections.REQUEST_BODY      = request_body
		collections.REQUEST_ARGS      = request_common_args
		collections.REQUEST_LINE      = request_var
		collections.PROTOCOL          = ngx.var.server_protocol
		collections.TX                = ctx.storage[&quot;TX&quot;]
		collections.NGX_VAR           = ngx.var
		collections.MATCHED_VARS      = {}
		collections.MATCHED_VAR_NAMES = {}
		collections.SCORE_THRESHOLD   = waf._score_threshold -- å±é™©é˜ˆå€¼
        ...
	end,
	header_filter = function(waf, collections)
		local response_headers = ngx.resp.get_headers()

		collections.RESPONSE_HEADERS = response_headers
		collections.STATUS           = ngx.status
	end,
	body_filter = function(waf, collections, ctx)
		...
	end,
	log = function() end
}
</code></pre>
<h4 id=142-æ•°æ®è½¬æ¢>1.4.2. æ•°æ®è½¬æ¢</h4>
<p>WAF çš„è§„åˆ™ä¸­é€šå¸¸ä¼šæä¾›å¤šç§å¸¸ç”¨çš„è¿ç®—å‡½æ•°ï¼Œä¾‹å¦‚ <code>tonumber()</code>, <code>lowercase()</code> ç­‰ï¼Œä¹Ÿä¼šæä¾›å¸¸è§„å˜é‡ä½¿ç”¨ï¼Œä¾‹å¦‚ <code>${geo_ip}</code> ã€‚</p>
<p>è§„åˆ™å¼•æ“éœ€è¦å¯¹å…¶è¿›è¡Œè½¬æ¢ï¼ŒåŠ¨æ€è§£æå‡ºçœŸå®çš„å˜é‡ï¼Œä»¥ä¾¿åç»­è¿›è¡Œè¿ç®—æ“ä½œã€‚</p>
<p>é¡¹ç›®æä¾›çš„å¸¸ç”¨çš„ <em>è½¬æ¢å‡½æ•°</em> æœ‰ï¼š</p>
<pre><code class=language-lua>_M.lookup = {
	base64_decode = function(waf, value)
		--_LOG_&quot;Decoding from base64: &quot; .. tostring(value)
		-- ä½¿ç”¨ lua-resty-core è§£ç  base64
		local t_val = ngx.decode_base64(tostring(value))
		if t_val then
			--_LOG_&quot;Decode successful, decoded value is &quot; .. t_val
			return t_val
		else
			--_LOG_&quot;Decode unsuccessful, returning original value &quot; .. value
			return value
		end
	end,
	base64_encode = function(waf, value)
		--_LOG_&quot;Encoding to base64: &quot; .. tostring(value)
		local t_val = ngx.encode_base64(value)
		--_LOG_&quot;Encoded value is &quot; .. t_val
		return t_val
	end,
	-- æ›¿æ¢ç©ºç™½å­—ç¬¦, æ­£åˆ™åŒ¹é…å°†å¤šä¸ªç©ºæ ¼å­—ç¬¦ (ç©ºæ ¼/tab) è½¬æ¢ä¸ºå•ä¸ªç©ºæ ¼
	compress_whitespace = function(waf, value)
		return ngx.re.gsub(value, [=[\s+]=], ' ', waf._pcre_flags)
	end,
	-- htmlentities åŒ…, é’ˆå¯¹ API è¾ƒå¤šçš„æƒ…å†µåº”è¯¥é¿å…è§£æ HTML
	html_decode = function(waf, value)
		local str = hdec.decode(value)
		--_LOG_&quot;html decoded value is &quot; .. str
		return str
	end,
	-- [ç»å¸¸ä½¿ç”¨]
	lowercase = function(waf, value)
		return string_lower(tostring(value))
	end,
	
    --- æ­¤å¤„çœç•¥ä¸å¸¸ç”¨çš„è½¬æ¢å‡½æ•°...
    
	-- [ç»å¸¸ä½¿ç”¨]
	uri_decode = function(waf, value)
		return ngx.unescape_uri(value)
	end,
}
</code></pre>
<p>å¯¹æ•°æ®é›†è¿›è¡Œè½¬æ¢ï¼Œè¾“å‡ºè½¬æ¢åçš„æ•°æ®é›†ï¼š</p>
<pre><code class=language-lua>-- transform collection values based on rule opts
local function _do_transform(self, collection, transform)
	local t = {}

	-- transform å‡½æ•°å¯èƒ½æ˜¯æ•°ç»„
	if type(transform) == &quot;table&quot; then
		t = collection

		for k, v in ipairs(transform) do
			-- å¯¹æ•°æ®é›†æ‰§è¡Œè½¬æ¢å‡½æ•°
			t = _do_transform(self, t, transform[k])
		end
	else
		-- æ‰§è¡Œå•ä¸ªè½¬æ¢å‡½æ•°ï¼Œé€’å½’æ‰§è¡Œ
		if type(collection) == &quot;table&quot; then
			for k, v in pairs(collection) do
				t[k] = _do_transform(self, collection[k], transform)
			end
		else
			if not collection then
				return collection
			end

			return transform_t.lookup[transform](self, collection)
		end
	end

	return t
end
</code></pre>
<p>åœ¨è§„åˆ™å¤„ç†ä¸­åŠ¨æ€è§£æå˜é‡ï¼š</p>
<pre><code class=language-lua>-- åŠ¨æ€è·å–è¦å¯¹æ¯”çš„å€¼
if opts.parsepattern then
    --_LOG_&quot;Parsing dynamic pattern: &quot; .. pattern
    pattern = util.parse_dynamic_value(self, pattern, collections)
end
</code></pre>
<p>ä»æ•°æ®é›†ä¸­åŠ¨æ€è·å–å˜é‡ï¼š</p>
<pre><code class=language-lua>-- pick out dynamic data from storage key definitions
function _M.parse_dynamic_value(waf, key, collections)
	local lookup = function(macro)
		local val, specific
		-- cheat on the start index
		local dot = string_find(macro, &quot;%.&quot;, 5)
		if dot then
			val = string_sub(macro, 3, dot - 1)
			specific = string_sub(macro, dot + 1, -2)
		else
			val = string_sub(macro, 3, -2)
		end

		local lval = collections[val]

		if type(lval) == &quot;table&quot; then
			if specific then
				return lval[specific] and tostring(lval[specific]) or
					tostring(lval[string.lower(specific)])
			else
				return val
			end
		else
			return lval
		end
	end

	local str = string_gsub(key, &quot;%%%b{}&quot;, lookup)

	--_LOG_&quot;Parsed dynamic value is &quot; .. str

	return tonumber(str) and tonumber(str) or str
end
</code></pre>
<h3 id=15-è§„åˆ™è¿ç®—>1.5. è§„åˆ™è¿ç®—</h3>
<p>WAF è§„åˆ™è¿ç®—ç¬¦é€šå¸¸åŒ…å« <em>ç­‰äºã€ä¸ç­‰äºã€åŒ…å«ã€ä¸åŒ…å«ã€æ­£åˆ™åŒ¹é…</em> ç­‰ç¬¦å·ã€‚</p>
<p>è§„åˆ™å¼•æ“å…·ä½“é€šè¿‡ lua-resty-coreã€lua-nginx-moduleã€Lua JIT æä¾›çš„æ–¹æ³•è¿›è¡Œæ•°æ®æ¯”è¾ƒï¼Œè¯¥é¡¹ç›®ä¸­ä¹Ÿç”¨åˆ°äº†ç¬¬ä¸‰æ–¹åº“ï¼Œæœ‰ç”¨ä½œå­—ç¬¦ä¸²å¤šæ¨¡å¼åŒ¹é…çš„ <a href=https://github.com/cloudflare/lua-aho-corasick/>AC è‡ªåŠ¨æœº Lua FFI åº“</a>ï¼ˆC å®ç°ï¼‰ï¼Œå’Œæ£€æµ‹ SQL æ³¨å…¥å’Œ XSS çš„ <a href=https://github.com/client9/libinjection>libinjection</a> åº“ï¼ˆC å®ç°ï¼‰ã€‚</p>
<p>è¾ƒä¸ºå¸¸ç”¨çš„æœ‰æ­£åˆ™åŒ¹é…çš„ <code>ngx.re.match</code> å’Œ <code>ngx.re.find</code> å‡½æ•°ï¼Œä¸¤è€…éƒ½ç”¨äº† PCRE ä¼˜åŒ–çš„å‚æ•° <code>jio</code>ï¼Œè¡¨ç¤ºç¼–è¯‘ç»“æœç¼“å­˜ã€å¯ç”¨ Lua JIT ä¼˜åŒ–ã€å¤§å°å†™ä¸æ•æ„Ÿï¼Œåè€…ç›¸æ¯” match å‡½æ•°ï¼Œåªè¿”å›åŒ¹é…å­—ç¬¦ä¸²çš„ç´¢å¼•ï¼Œæ›´ä¸ºé«˜æ•ˆã€‚</p>
<pre><code class=language-lua>-- match æ­£åˆ™åŒ¹é…
---@return boolean, string[] 
function _M.regex(waf, subject, pattern)
	-- Lua JIT ä¼˜åŒ–å‚æ•°
	local opts = waf._pcre_flags
	local captures, err, match

	if type(subject) == &quot;table&quot; then
		for _, v in ipairs(subject) do
			match, captures = _M.regex(waf, v, pattern)

			if match then
				break
			end
		end
	else
		captures, err = ngx.re.match(subject, pattern, opts)

		if err then
			logger.warn(waf, &quot;error in ngx.re.match: &quot; .. err)
		end

		if captures then
			match = true
		end
	end

	return match, captures
end

-- æ­£åˆ™åŒ¹é… ngx.re.find, åªè¿”å›åŒ¹é…å­—ç¬¦ä¸²çš„ index
---@return boolean, number
function _M.refind(waf, subject, pattern)
	local opts = waf._pcre_flags
	local from, to, err, match

	if type(subject) == &quot;table&quot; then
		for _, v in ipairs(subject) do
			match, from = _M.refind(waf, v, pattern)

			if match then
				break
			end
		end
	else
		from, to, err = ngx.re.find(subject, pattern, opts)

		if err then
			logger.warn(waf, &quot;error in ngx.re.find: &quot; .. err)
		end

		if from then
			match = true
		end
	end

	return match, from
end
</code></pre>
<p>AC è‡ªåŠ¨æœºè¿›è¡Œå­—ç¬¦ä¸²åŒ¹é…ï¼Œé¦–å…ˆåˆ›å»º Trie å‰ç¼€æ ‘å’Œ Fail æŒ‡é’ˆï¼Œæ„å»ºç»“æœç¼“å­˜åœ¨ Lua Table ä¸­ï¼Œé¿å…é‡å¤åˆ›å»ºçš„æ€§èƒ½æŸè€—ï¼Œåœ¨é¡¹ç›®ç¤ºä¾‹è§„åˆ™é›†ä¸­ï¼Œä¸»è¦ç”¨äº user-agent çš„åŒ¹é…ã€‚</p>
<pre><code class=language-lua>
-- AC è‡ªåŠ¨æœºå­—ç¬¦ä¸²æŸ¥æ‰¾
---@return boolean, string
function _M.ac_lookup(needle, haystack, ctx)
	local id = ctx.id
	local match, _ac, value

	-- dictionary creation is expensive, so we use the id of
	-- the rule as the key to cache the created dictionary
	-- ä½¿ç”¨ Lua Table ç¼“å­˜å­—å…¸
	if not _ac_dicts[id] then
		_ac = ac.create_ac(haystack)
		_ac_dicts[id] = _ac
	else
		_ac = _ac_dicts[id]
	end

	if type(needle) == &quot;table&quot; then
		for _, v in ipairs(needle) do
			match, value = _M.ac_lookup(v, haystack, ctx)

			if match then
				break
			end
		end
	else
		match = ac.match(_ac, needle)

		if match then
			match = true
			value = needle
		end
	end

	return match, value
end
</code></pre>
<p>å¸¸ç”¨çš„è§„åˆ™è¿ç®—ç¬¦å¦‚ä¸‹ï¼Œè¿”å› <em>æ˜¯å¦åŒ¹é…æˆåŠŸï¼ŒåŒ¹é…çš„ç»“æœ</em>ã€‚</p>
<pre><code class=language-lua>-- æ“ä½œç¬¦
-- æ¥æ”¶å‚æ•° [waf å®ä¾‹, æ•°æ®é›†, åŒ¹é…å‚æ•°]
---@return boolean, string|number
_M.lookup = {
	REGEX        = function(waf, collection, pattern) return _M.regex(waf, collection, pattern) end,
	REFIND       = function(waf, collection, pattern) return _M.refind(waf, collection, pattern) end,
	EQUALS       = function(waf, collection, pattern) return _M.equals(collection, pattern) end,
	GREATER      = function(waf, collection, pattern) return _M.greater(collection, pattern) end,
	LESS         = function(waf, collection, pattern) return _M.less(collection, pattern) end,
	GREATER_EQ   = function(waf, collection, pattern) return _M.greater_equals(collection, pattern) end,
	LESS_EQ      = function(waf, collection, pattern) return _M.less_equals(collection, pattern) end,
	EXISTS       = function(waf, collection, pattern) return _M.exists(collection, pattern) end,
	CONTAINS     = function(waf, collection, pattern) return _M.contains(collection, pattern) end,
	STR_EXISTS   = function(waf, collection, pattern) return _M.str_find(waf, pattern, collection) end,
	STR_CONTAINS = function(waf, collection, pattern) return _M.str_find(waf, collection, pattern) end,
	-- AC è‡ªåŠ¨æœºåŒ¹é…
	PM           = function(waf, collection, pattern, ctx) return _M.ac_lookup(collection, pattern, ctx) end,
	CIDR_MATCH   = function(waf, collection, pattern) return _M.cidr_match(collection, pattern) end,
	RBL_LOOKUP   = function(waf, collection, pattern, ctx) return _M.rbl_lookup(waf, collection, pattern, ctx) end,
	DETECT_SQLI  = function(waf, collection, pattern) return _M.detect_sqli(collection) end,
	DETECT_XSS   = function(waf, collection, pattern) return _M.detect_xss(collection) end,
	STR_MATCH    = function(waf, collection, pattern) return _M.str_match(collection, pattern) end,
	VERIFY_CC    = function(waf, collection, pattern) return _M.verify_cc(waf, collection, pattern) end,
}
</code></pre>
<h3 id=16-æ‰§è¡ŒåŠ¨ä½œ>1.6. æ‰§è¡ŒåŠ¨ä½œ</h3>
<h4 id=161-éæ•°æ®æ“ä½œç±»å‹>1.6.1. éæ•°æ®æ“ä½œç±»å‹</h4>
<p>è§„åˆ™å¼•æ“çš„æ“ä½œé€šå¸¸æœ‰ <em>å…è®¸ã€é˜»æ­¢ã€å¿½ç•¥ã€è®°å½•</em>ã€‚</p>
<blockquote>
<p>Cloudflare æœ‰é¢å¤–çš„æ‰§è¡ŒåŠ¨ä½œï¼šè´¨è¯¢ï¼Œæˆ‘ä»¬ç»å¸¸å¯è§çš„ CF äº”ç§’ç›¾åçš„éªŒè¯ç å°±æ˜¯è¯¥åŠ¨ä½œã€‚</p>
</blockquote>
<pre><code class=language-lua>-- æ•°æ®æ“ä½œç±»å‹, åŒºåˆ«äº ACCEPT, CHAIN, IGNORE
_M.alter_actions = {
	DENY   = true,
	DROP   = true,
}

_M.disruptive_lookup = {
	ACCEPT = function(waf, ctx)
		--_LOG_&quot;Rule action was ACCEPT, so ending this phase with ngx.OK&quot;
		if waf._mode == &quot;ACTIVE&quot; then
			-- TODO å…è®¸æ“ä½œä»ç„¶è¿”å›åç«¯çŠ¶æ€ç 
			ngx.exit(ngx.OK)
		end
	end,
	CHAIN = function(waf, ctx)
		--_LOG_&quot;Chaining (pre-processed)&quot;
	end,
	DENY = function(waf, ctx)
		--_LOG_&quot;Rule action was DENY, so telling nginx to quit&quot;
		if waf._mode == &quot;ACTIVE&quot; then
			ngx.exit(ctx.rule_status or waf._deny_status)
		end
	end,
	DROP = function(waf, ctx)
		--_LOG_&quot;Rule action was DROP, ending eith ngx.HTTP_CLOSE&quot;
		if waf._mode == &quot;ACTIVE&quot; then
			ngx.exit(ngx.HTTP_CLOSE)
		end
	end,
	IGNORE = function(waf)
		--_LOG_&quot;Ignoring rule for now&quot;
	end,
	-- SCORE ç±»å‹åºŸå¼ƒï¼Œä½¿ç”¨ TX è®¾ç½®å±é™©åˆ†æ•°
	SCORE = function(waf, ctx)
		--_LOG_&quot;Score isn't a thing anymore, see TX.anomaly_score&quot;
	end,
}
</code></pre>
<h4 id=162-æ•°æ®æ“ä½œç±»å‹>1.6.2. æ•°æ®æ“ä½œç±»å‹</h4>
<p>OWASP ModSecurity è§„åˆ™ä¸­æœ‰å˜é‡çš„æ“ä½œï¼Œä¾‹å¦‚ <code>set_var</code> ä»¥åŠå¢åŠ å¨èƒåˆ†æ•°çš„æ“ä½œï¼Œéƒ½æ˜¯å±äºæ•°æ®æ“ä½œç±»å‹ã€‚</p>
<pre><code class=language-lua>-- é¢å¤–æ“ä½œç±»å‹
_M.nondisruptive_lookup = {
	deletevar = function(waf, data, ctx, collections)
		storage.delete_var(waf, ctx, data)
	end,
	expirevar = function(waf, data, ctx, collections)
		local time = util.parse_dynamic_value(waf, data.time, collections)

		storage.expire_var(waf, ctx, data, time)
	end,
	initcol = function(waf, data, ctx, collections)
		local col    = data.col
		local value  = data.value
		local parsed = util.parse_dynamic_value(waf, value, collections)

		--_LOG_&quot;Initializing &quot; .. col .. &quot; as &quot; .. parsed

		storage.initialize(waf, ctx.storage, parsed)
		ctx.col_lookup[col] = parsed
		collections[col]    = ctx.storage[parsed]
	end,
	setvar = function(waf, data, ctx, collections)
		data.key    = util.parse_dynamic_value(waf, data.key, collections)
		local value = util.parse_dynamic_value(waf, data.value, collections)

		storage.set_var(waf, ctx, data, value)
	end,
	...
}
</code></pre>
<p>æ•°æ®æ“ä½œç±»å‹é€šå¸¸ä¼šè®¾ç½®å˜é‡ï¼Œlua-resty-waf ä¸­æ”¯æŒåœ¨ Nginx å…±äº«å†…å­˜å’Œ Redis ä¸­è®¾ç½®å…¨å±€å˜é‡ï¼Œåœ¨è§„åˆ™è®¡ç®—ä¸­ä½¿ç”¨ã€‚</p>
<h3 id=17-å¾…ä¼˜åŒ–>1.7. å¾…ä¼˜åŒ–</h3>
<p>è§„åˆ™å¼•æ“ä¸­æœ‰éƒ¨åˆ†æ“ä½œæ˜æ˜¾å¯ä»¥ä¼˜åŒ–ï¼Œæ­¤å¤„åŒ…å«ï¼š</p>
<ol>
<li>æ•°æ®é›†æ„å»ºï¼Œå¼•æ“åªéœ€è¦è§„åˆ™å®šä¹‰ä¸­åŒ…å«çš„å­—æ®µï¼Œé™¤æ­¤ä»¥å¤–çš„æ•°æ®è·å–æ˜¯æ— æ•ˆçš„</li>
<li>IPDR åŒ¹é…ï¼Œçº¯ Lua æ¯”è¾ƒç›¸æ¯” C åº“ FFI è°ƒç”¨æ•ˆç‡è¾ƒä¸ºä½æ•ˆ</li>
</ol>
</div>
<footer class=post-footer>
<div class=post-meta>
<time datetime=" 2021-11-06" itemprop=datePublished>Nov 6, 2021</time>
</div>
</footer>
</article>
<script src=https://cdn.jsdelivr.net/npm/tocbot/dist/tocbot.min.js></script>
<aside class=typeface-sans lang=zh-hans>
<nav class=toc></nav>
</aside>
<script>tocbot.init({tocSelector:'.toc',contentSelector:'article',headingSelector:'h1, h2, h3, h4, h5',hasInnerContainers:!0,collapseDepth:"3",positionFixedSelector:".toc",headingsOffset:10})</script>
</div><script src=https://cdn.jsdelivr.net/npm/prismjs@1.24.1/prism.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/prismjs@1.24.1/plugins/filter-highlight-all/prism-filter-highlight-all.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/prismjs@1.24.1/plugins/autoloader/prism-autoloader.min.js></script>
<script>Prism.plugins.filterHighlightAll.add(function(a){return a.language!=="mermaid"})</script>
<script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script>
<script>mermaid.init({startOnLoad:!0},"pre code.language-mermaid",function(){const a=document.querySelectorAll('code.language-mermaid');for(const c of a){c.style.backgroundColor='initial';const b=c.parentNode;b.style.border='none',b.style.textAlign='center',window.darkmode&&!window.darkmode.isActivated()&&(b.style.backgroundColor='initial')}})</script>
</div>
</main><footer class=site-footer>
<div class=wrapper>
<div class=social-links>
<a class="social-link social-github" href=https://github.com/mayocream><svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="currentcolor" d="M12 2A10 10 0 002 12c0 4.42 2.87 8.17 6.84 9.5C9.34 21.58 9.5 21.27 9.5 21 9.5 20.77 9.5 20.14 9.5 19.31 6.73 19.91 6.14 17.97 6.14 17.97c-.46-1.16-1.11-1.47-1.11-1.47C4.12 15.88 5.1 15.9 5.1 15.9 6.1 15.97 6.63 16.93 6.63 16.93 7.5 18.45 8.97 18 9.54 17.76 9.63 17.11 9.89 16.67 10.17 16.42c-2.22-.25-4.55-1.11-4.55-4.92.0-1.11.38-2 1.03-2.71C6.55 8.54 6.2 7.5 6.75 6.15c0 0 .84-.27 2.75 1.02C10.29 6.95 11.15 6.84 12 6.84s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02C17.8 7.5 17.45 8.54 17.35 8.79 18 9.5 18.38 10.39 18.38 11.5c0 3.82-2.34 4.66-4.57 4.91C14.17 16.72 14.5 17.33 14.5 18.26c0 1.34.0 2.42.0 2.74.0.27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0012 2z"/></svg>
</a>
<a class="social-link social-rss" href=/index.xml target=_blank><svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="currentcolor" d="M6.18 15.64a2.18 2.18.0 012.18 2.18C8.36 19 7.38 20 6.18 20 5 20 4 19 4 17.82a2.18 2.18.0 012.18-2.18M4 4.44A15.56 15.56.0 0119.56 20H16.73A12.73 12.73.0 004 7.27V4.44M4 10.1A9.9 9.9.0 0113.9 20H11.07A7.07 7.07.0 004 12.93V10.1z"/></svg>
</a>
</div>
<div class=credits>
Theme KAGAMI by Kamikat
</div>
</div>
</footer><script>(function(a){for(var a=Array.prototype.slice.call(document.getElementsByClassName('baseline-fix')),b=0,c;b!=a.length;b++)c=a[b],c.innerHTML=c.innerHTML.replace(/[\u2000-\u206eâ¸€-\u2e7eâº€-\u2efeâ¼€-\u2fdeâ¿°-\u2ffe\u3000-ã€¾\u3040-ã‚ã‚ -ãƒ¾\u3100-\u312e\u3130-ã†ã†-ã†ã† -\u31beã‡€-\u31eeã‡°-ã‡¾ãˆ€-ã‹¾ãŒ€-ã¾ã€-\u4dbeä¸€-\u9ffe\ua960-\ua97eê°€-\ud7ae\ud7b0-\ud7feï¤€-\ufafeï¸°-ï¹\uff00-ï¿®]|[\ud840-\ud868\ud86a-\ud86c][\udc00-\udfff]|\ud82c[\udc00-\udcfe]|\ud869[\udc00-\udede\udf00-\udfff]|\ud86d[\udc00-\udf3e\udf40-\udfff]|\ud86e[\udc00-\udc1e]|\ud87e[\udc00-\ude1e]/g,function(a){return'<span class="baseline-fix-block">'+a+'<'+'/span>'}),c.classList.remove('baseline-fix')})(Array.prototype.slice.call(document.getElementsByClassName('baseline-fix')))</script>
<script type=text/javascript>const resize=function(){this.width=.5*(this.naturalWidth||this.width)};Array.prototype.forEach.call(document.querySelectorAll('.half-size, .retina2x'),function(a){a.naturalWidth?resize.call(a):a.onload=resize})</script>
<script src=https://cdn.jsdelivr.net/npm/twemoji@13.1.0/dist/twemoji.min.js></script>
<script>twemoji.parse(document.body,{folder:'svg',ext:'.svg'})</script>
</body>