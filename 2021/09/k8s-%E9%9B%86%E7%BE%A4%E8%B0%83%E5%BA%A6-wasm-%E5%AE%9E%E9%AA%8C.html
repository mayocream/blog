<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/_next/static/css/c3b55921f92a131e.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-072f062dc024cc52.js"/><script src="/_next/static/chunks/f4f1b8d9-0107da81548bf985.js" async=""></script><script src="/_next/static/chunks/435-d305dd8b5fb158de.js" async=""></script><script src="/_next/static/chunks/main-app-3958e659bb0a464b.js" async=""></script><title>Mayo Rocks!</title><meta name="description" content="Mayo&#x27;s Blog"/><link rel="icon" href="/icon.png?14d5a92fbe70e82a" type="image/png" sizes="460x460"/><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="antialiased"><article><p>Webassemblyï¼ˆWASMï¼‰æ˜¯ Next-Generation çš„è½¯ä»¶åˆ†å‘æ–¹å¼ï¼Œå…·æœ‰è·¨è¯­è¨€ã€è·¨å¹³å°ã€è‡ªå¸¦è¿è¡Œæ—¶çš„æ— æ•Œå±æ€§<sup><a href="#user-content-fn-1" id="user-content-fnref-1" data-footnote-ref aria-describedby="footnote-label">1</a></sup>ã€‚çŸ¥æ™“äº†å®ƒçš„ç¾å¦™ä¹‹å¤„ï¼Œæˆ‘ä»¬è‡ªç„¶ä¼šæƒ³æ‹¥æœ‰æ¬¡ä¸–ä»£çš„ä½“éªŒï¼Œæœ¬æ–‡æè¿°å°è¯•å°†è½»é‡çº§ WASM ç”¨ç±» OCI æ‰“åŒ…æ–¹å¼è°ƒåº¦åˆ° K8s é›†ç¾¤ä¸­è¿è¡Œçš„è¿‡ç¨‹ï¼Œä»¥åŠå…¶ä¸­çš„è‰°è¾›ä¹‹å¤„ã€‚</p>
<p>WASM åœ¨å½“å‰é˜¶æ®µè¿˜å¾ˆå°´å°¬ï¼ŒWASIï¼ˆWebAssembly System Interfaceï¼‰è¿˜å¤„äº<a href="https://github.com/WebAssembly/WASI/milestone/1">æ—©æœŸé˜¶æ®µ</a>ï¼ŒWASM è¿è¡Œæ—¶é¡¹ç›® <a href="https://github.com/wasmerio/wasmer">Wasmer</a> ä¸ <a href="https://github.com/bytecodealliance/wasmtime">wasmtime</a> å¯¹äºå¤šè¯­è¨€çš„æ”¯æŒè¿˜ä¸è¶³ï¼Œäº‘å‚å•†ä¾‹å¦‚ Cloudflare ä¸ AWS Lambda@Edge éƒ½ä¸æ˜¯åŸç”Ÿæ”¯æŒ WASMï¼ŒWASM çš„æ‰§è¡Œæ€§èƒ½ä¹Ÿå¯èƒ½æ¯”ä¸ä¸Š Google çš„ v8 JavaScript å¼•æ“ã€‚</p>
<p>å½“æˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†ä¸€äº›å¸Œæœ›ï¼šGo å®˜æ–¹ä¹Ÿè®¸ä¼š<a href="https://github.com/golang/go/issues/31105">æ”¯æŒ WASI</a>ã€APISIX å‡†å¤‡<a href="https://github.com/apache/apisix/issues/157">ä½¿ç”¨ Wamser ä½œä¸º WASM è¿è¡Œæ—¶</a>ã€‚</p>
<p>æˆ‘å½“å‰åœ¨è¿›è¡Œçš„å¦ä¸€ä¸ªé¡¹ç›®ä¹Ÿé€šè¿‡åœ¨æµè§ˆå™¨ä¸­åŠ è½½ WASM å®ç° X.509 è¯ä¹¦è§£æã€ç­¾åä¸ ACME ç”³è¯·è¯ä¹¦ï¼Œè¯¥é¡¹ç›®è¿˜ä¼šä½¿ç”¨ Serverless æŠ€æœ¯è¿›è¡Œæµé‡ä»£ç†ï¼Œä¸è¿‡è¿™ä¸ªå‘ä½•æ—¶èƒ½å¡«å®Œå°±æ²¡æœ‰äººçŸ¥é“äº† ğŸ’€ã€‚</p>
<h2>1. Krustlet è°ƒåº¦ WASM</h2>
<blockquote>
<p>Krustlet ä»‹ç»ï¼š<a href="https://www.infoq.cn/article/oumc77mjsl67m39lqgtg">ä½¿ç”¨ Rust å¼€å‘çš„ kubeletï¼Œç”¨äºè¿è¡Œ WASM å·¥ä½œè´Ÿè½½</a></p>
</blockquote>
<p>æ¦‚è¿°ï¼šKrustlet çš„å·¥ä½œæ–¹å¼ç±»ä¼¼äº Kubeletï¼Œæ˜¯åœ¨ K8s é›†ç¾¤å·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡Œçš„åå°ç¨‹åºï¼Œè´Ÿè´£ä¸ŠæŠ¥èŠ‚ç‚¹çŠ¶æ€ä»¥åŠè¿è¡Œå·¥ä½œè´Ÿè½½ï¼ˆWASMï¼‰ã€‚</p>
<p>ç›®å‰ä¸æ”¯æŒ CNI ç½‘ç»œã€‚</p>
<h3>1.1. éƒ¨ç½²å®‰è£…</h3>
<h4>1.1.1. æµ‹è¯•ç¯å¢ƒ</h4>
<ul>
<li>é˜¿é‡Œäº‘æµ‹è¯•é›†ç¾¤ - <code>192.168.33.161</code> æœºå™¨ï¼ˆ2c 8gï¼‰</li>
</ul>
<h4>1.1.2. å®‰è£… Krustlet</h4>
<pre><code class="language-bash">#!/bin/bash

wget https://krustlet.blob.core.windows.net/releases/krustlet-v0.7.0-linux-amd64.tar.gz -O /tmp/krustlet.tar.gz
tar zxvf /tmp/krustlet.tar.gz &#x26;&#x26; mv krustlet-wasi /usr/local/bin/
</code></pre>
<h4>1.1.3. èŠ‚ç‚¹åˆå§‹åŒ–</h4>
<blockquote>
<p>æ ¹æ®å®˜æ–¹æ–‡æ¡£è¿›è¡ŒèŠ‚ç‚¹åˆå§‹åŒ–: <a href="https://docs.krustlet.dev/intro/quickstart/">quickstart</a>ã€‚</p>
</blockquote>
<p>æ­¥éª¤ï¼š</p>
<ol>
<li>
<p>èŠ‚ç‚¹ä¸Šå®‰è£… Kubectl å¹¶é…ç½®æœ‰åœ¨ <code>kube-system</code> ä¸‹åˆ›å»º CSR èµ„æºçš„å‡­è¯</p>
</li>
<li>
<p>æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬</p>
<pre><code class="language-bash">bash &#x3C;(curl https://raw.githubusercontent.com/deislabs/krustlet/master/docs/howto/assets/bootstrap.sh)
</code></pre>
</li>
<li>
<p>åˆ›å»º Systemd æ–‡ä»¶ <code>/etc/systemd/system/krustlet.service</code></p>
<pre><code class="language-bash">[Unit]
Description=Krustlet, a kubelet implementation for running WASM

[Service]
Restart=on-failure
RestartSec=5s
Environment=KUBECONFIG=/root/.kube/config
ExecStart=/usr/local/bin/krustlet-wasi
User=root
Group=root

[Install]
WantedBy=multi-user.target
</code></pre>
<pre><code class="language-bash">systemctl daemon-reload
systemctl enable krustlet.service
systemctl start krustlet.service
</code></pre>
</li>
<li>
<p>å®¡æ ¸ CSR ç”³è¯·</p>
<pre><code class="language-bash">kubectl certificate approve ${HOSTNAME}-tls
</code></pre>
</li>
</ol>
<h4>1.1.4. èŠ‚ç‚¹çŠ¶æ€</h4>
<p><img src="/images/2021-09-01-18.png" alt="ç­‰å¾…æ‰‹åŠ¨ Approve"></p>
<p><img src="/images/2021-09-01-14.png" alt="ç¨‹åºæ­£å¸¸å¯åŠ¨"></p>
<p><img src="/images/2021-09-01-15.png" alt="Krustlet èŠ‚ç‚¹å·²åŠ å…¥é›†ç¾¤"></p>
<ul>
<li>
<p>Krustlet èŠ‚ç‚¹è¯¦æƒ… <code>kubectl describe node ${HOSTNAME}</code></p>
<pre><code class="language-bash">Name:               izuf6cc5ecqwtuhm1p2rcaz
Roles:              &#x3C;none>
Labels:             beta.kubernetes.io/arch=wasm32-wasi
                    beta.kubernetes.io/os=wasm32-wasi
                    kubernetes.io/arch=wasm32-wasi
                    kubernetes.io/hostname=iZuf6cc5ecqwtuhm1p2rcaZ
                    kubernetes.io/os=wasm32-wasi
                    type=krustlet
Annotations:        node.alpha.kubernetes.io/ttl: 0
                    volumes.kubernetes.io/controller-managed-attach-detach: true
CreationTimestamp:  Thu, 08 Jul 2021 14:45:26 +0800
Taints:             kubernetes.io/arch=wasm32-wasi:NoExecute
                    kubernetes.io/arch=wasm32-wasi:NoSchedule
Unschedulable:      false
Lease:
  HolderIdentity:  izuf6cc5ecqwtuhm1p2rcaz
  AcquireTime:     Thu, 08 Jul 2021 14:49:37 +0800
  RenewTime:       Thu, 08 Jul 2021 14:49:37 +0800
Conditions:
  Type        Status  LastHeartbeatTime                 LastTransitionTime                Reason                     Message
  ----        ------  -----------------                 ------------------                ------                     -------
  Ready       True    Thu, 08 Jul 2021 14:49:37 +0800   Thu, 08 Jul 2021 14:45:26 +0800   KubeletReady               kubelet is posting ready status
  OutOfDisk   False   Thu, 08 Jul 2021 14:45:26 +0800   Thu, 08 Jul 2021 14:45:26 +0800   KubeletHasSufficientDisk   kubelet has sufficient disk space available
Addresses:
  InternalIP:  192.168.33.161
  Hostname:    iZuf6cc5ecqwtuhm1p2rcaZ
Capacity:
  cpu:                4
  ephemeral-storage:  61255492Ki
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             4032800Ki
  pods:               110
Allocatable:
  cpu:                4
  ephemeral-storage:  61255492Ki
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             4032800Ki
  pods:               110
System Info:
  Machine ID:
  System UUID:
  Boot ID:
  Kernel Version:
  OS Image:
  Operating System:           linux
  Architecture:               wasm-wasi
  Container Runtime Version:  mvp
  Kubelet Version:            0.7.0
  Kube-Proxy Version:         v1.17.0
PodCIDR:                      10.244.0.0/24
PodCIDRs:                     10.244.0.0/24
Non-terminated Pods:          (3 in total)
  Namespace                   Name                   CPU Requests  CPU Limits  Memory Requests  Memory Limits  Age
  ---------                   ----                   ------------  ----------  ---------------  -------------  ---
  kruise-system               kruise-daemon-v9nfh    0 (0%)        50m (1%)    0 (0%)           64Mi (1%)      4m17s
  kube-system                 calico-node-m4d67      150m (3%)     300m (7%)   64M (1%)         500M (12%)     4m17s
  kube-system                 nodelocaldns-k5kd2     100m (2%)     0 (0%)      70Mi (1%)        170Mi (4%)     4m17s
Allocated resources:
  (Total limits may be over 100 percent, i.e., overcommitted.)
  Resource           Requests        Limits
  --------           --------        ------
  cpu                250m (6%)       350m (8%)
  memory             137400320 (3%)  745366784 (18%)
  ephemeral-storage  0 (0%)          0 (0%)
  hugepages-1Gi      0 (0%)          0 (0%)
  hugepages-2Mi      0 (0%)          0 (0%)
Events:              &#x3C;none>
</code></pre>
</li>
</ul>
<p>èŠ‚ç‚¹å¸¦æœ‰ä¸¤ä¸ªæ±¡ç‚¹ï¼š</p>
<pre><code class="language-bash">Taints:             kubernetes.io/arch=wasm32-wasi:NoExecute
                    kubernetes.io/arch=wasm32-wasi:NoSchedule
</code></pre>
<h3>1.2. WASM OCI</h3>
<p>Krustlet ä½¿ç”¨ <a href="https://github.com/engineerd/wasm-to-oci">wasm-to-oci</a> æ‰“åŒ… WASM ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶åˆ°é•œåƒä»“åº“ã€‚</p>
<h4>1.2.1. æ¨é€é•œåƒ</h4>
<p>å®‰è£… wasm-to-oci CLI</p>
<pre><code class="language-bash">wget https://github.com/engineerd/wasm-to-oci/releases/download/v0.1.2/linux-amd64-wasm-to-oci -O /usr/local/bin/wasm-to-oci \
&#x26;&#x26; chmod +x /usr/local/bin/wasm-to-oci
</code></pre>
<ul>
<li>
<p><code>wasm-to-oci</code> Usage</p>
<pre><code class="language-bash">Usage:
  wasm-to-oci [command]

Available Commands:
  help        Help about any command
  pull        Pulls a WASM module from an OCI registry
  push        Pushes a WASM module from an OCI registry

Flags:
  -d, --dir string         Directory where the trust data is persisted to (default "/root/.wasm-to-oci")
  -h, --help               help for wasm-to-oci
      --insecure           allow connections to SSL registry without certs
      --log string         Set the logging level ("debug"|"info"|"warn"|"error"|"fatal") (default "info")
      --server string      The trust server used (default "https://notary.docker.io")
  -t, --timeout string     Timeout for the trust server (default "5s")
      --tlscacert string   Trust certs signed only by this CA
      --use-http           use plain http and not https
</code></pre>
</li>
</ul>
<p>æ‰“åŒ…ç¤ºä¾‹ WASMï¼ˆäºŒè¿›åˆ¶ç¼–è¯‘åçš„æ–‡ä»¶ï¼‰</p>
<pre><code class="language-bash">wget https://github.com/engineerd/wasm-to-oci/raw/master/testdata/hello.wasm
wasm-to-oci push hello.wasm harbor.domain.dev/bifrost/hello-wasm:v1
</code></pre>
<blockquote>
<p>Docker éœ€è¦æœ‰ Registry çš„å‡­è¯ <code>~/.docker/config.json</code></p>
</blockquote>
<p>Push è¾“å‡ºï¼š</p>
<pre><code class="language-bash">INFO[0001] Pushed: harbor.domain.dev/bifrost/hello-wasm:v1
INFO[0001] Size: 1624962
INFO[0001] Digest: sha256:a01f32cc647abe49bb34727cc2c520e6e304e3049d669f53e2d30d49ee2ed9c7
</code></pre>
<p>wasm-oci ä½¿ç”¨äº†è‡ªå®šä¹‰çš„ OCI Layerï¼Œå±äºéæ ‡å‡†ç±»å‹ã€‚</p>
<blockquote>
<p><a href="https://radu-matei.com/blog/wasm-oci-tuf/">Securely distributing and signing WebAssembly modules using OCI and TUF</a></p>
</blockquote>
<pre><code class="language-json">{
  "schemaVersion": 2,
  "config": {
    "mediaType": "application/vnd.wasm.config.v1+json",
    "digest": "sha256:44136fa355b3678a1146ad16f7e8649e94fb4fc21fe77e8310c060f61caaff8a",
    "size": 2
  },
  "layers": [
    {
      "mediaType": "application/vnd.wasm.content.layer.v1+wasm",
      "digest": "sha256:4c7915b4c1f9b0c13f962998e4199ceb00db39a4a7fa4554f40ae0bed83d9510",
      "size": 1624962
    }
  ]
}
</code></pre>
<h4>1.2.2. æ‹‰å–é•œåƒ</h4>
<p>ç”±äºæ˜¯éæ ‡å‡†æ ¼å¼çš„ OCI é•œåƒï¼Œç›´æ¥ä½¿ç”¨ Docker CLI æ‹‰å–ä¼šå‡ºé”™ï¼š</p>
<pre><code class="language-bash">v1: Pulling from bifrost/hello-wasm
4c7915b4c1f9: Pulling fs layer
invalid rootfs in image configuration
</code></pre>
<h4>1.2.3. WASM module ä¸å®¹å™¨åŒºåˆ«</h4>
<p><a href="https://github.com/deislabs/krustlet/issues/624#issuecomment-855607557">Krustlet-tutorial pod get stuck in init:regitered status Â· Issue #624 Â· deislabs/krustlet</a></p>
<ul>
<li>WASM OCI ä¸æ˜¯ Docker å®¹å™¨</li>
<li>WASM OCI ä¸èƒ½ä½¿ç”¨ Docker pull</li>
</ul>
<h3>1.3. WASM Pod è°ƒåº¦</h3>
<p>WASM è°ƒåº¦çš„æœ€å°å•å…ƒæ˜¯ Podï¼ŒPod å®šä¹‰ä¸­å¿…é¡»åŒ…å« WASM èŠ‚ç‚¹çš„ tolerationsã€‚</p>
<h4>1.3.1. Pod è°ƒåº¦</h4>
<p>ç¤ºä¾‹ Podï¼š</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: wasm-hello
spec:
  containers:
    - name: wasm-hello
      image: harbor.domain.dev/bifrost/hello-wasm:v1
  tolerations:
    - key: "kubernetes.io/arch"
      operator: "Equal"
      value: "wasm32-wasi"
      effect: "NoExecute"
    - key: "kubernetes.io/arch"
      operator: "Equal"
      value: "wasm32-wasi"
      effect: "NoSchedule"
</code></pre>
<pre><code class="language-bash">> k apply -f wasm-hello.yaml
pod/wasm-hello created
</code></pre>
<ul>
<li>
<p>å°æ’æ›²</p>
<p>è¯•éªŒè¿‡ç¨‹ä¸­å‘ç°ä½¿ç”¨ wasm-to-oci æ¨é€é•œåƒåˆ°è‡ªå»ºçš„ Harbor é•œåƒä»“åº“åï¼Œæ‹‰å–é•œåƒæ—¶ä¼šæŠ¥é”™ã€‚</p>
<p><a href="https://github.com/deislabs/krustlet/issues/624">Krustlet-tutorial pod get stuck in init:regitered status Â· Issue #624 Â· deislabs/krustlet</a></p>
<p>å…³è”åˆ°ä¸€ä¸ª Issueï¼Œéƒ¨åˆ† Registry ä¼šæ— æ³•æ‹‰å–é•œåƒï¼ŒæŠ¥é”™ï¼š</p>
<pre><code class="language-bash">krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG hyper::proto::h1::conn] incoming body is content-length (950 bytes)
krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG hyper::proto::h1::conn] incoming body completed
krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG hyper::client::pool] pooling idle connection for ("https", harbor....)
krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG reqwest::async_impl::client] response '200 OK' for https://harbor..../service/token?scope=repository%3Abifrost%2Fhello-wasm%3Apull&#x26;service=harbor-registry
krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG oci_distribution::client] Received response from auth request: {"token":"...","access_token":"","expires_in":1800,"issued_at":"2021-07-08T08:31:46Z"}
krustlet-wasi[20706]: [2021-07-08T08:31:46Z ERROR kubelet::state::common::image_pull] Failed to decode registry token from auth request
krustlet-wasi[20706]:
krustlet-wasi[20706]:     Caused by:
krustlet-wasi[20706]:         duplicate field `token` at line 1 column 1129
krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG krator::state] State::status
krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG krator::state] Applying status patch to object. name=wasm-hello patch={"metadata":{"resourceVersion":""},"status":{"phase":"Pending","message":"ImagePullBackoff","reason":"ImagePullBackoff"}}
</code></pre>
<p>å°†é•œåƒæ›¿æ¢ä¸º <a href="http://webassembly.azurecr.io/hello-world-wasi-rust:v0.1.0"><code>webassembly.azurecr.io/hello-world-wasi-rust:v0.1.0</code></a> å¯æ­£å¸¸è¿è¡Œã€‚</p>
</li>
</ul>
<h4>1.3.2. Pod è¿è¡Œæ—¶</h4>
<p>æŸ¥çœ‹ Pod è¿è¡ŒçŠ¶æ€ï¼š</p>
<pre><code class="language-bash">> k get pod -n ns-msp | grep wasm
wasm-hello        0/1     ExitCode:0         0          13m
</code></pre>
<p>Pod è¢«è°ƒåº¦åç«‹åˆ»è¢«æ‰§è¡Œï¼Œè¿”å› ExitCode 0ã€‚</p>
<pre><code class="language-bash">> k logs -n ns-msp -f wasm-hello
hello from stdout!
hello from stderr!
Args are: []
</code></pre>
<p>kubectl æŸ¥çœ‹ä¸è¿è¡Œæ—¥å¿—ã€‚</p>
<ul>
<li>
<p>Pod YAML</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: "2021-07-08T08:37:39Z"
  name: wasm-hello
  namespace: ns-msp
  resourceVersion: "543645433"
  selfLink: /api/v1/namespaces/ns-msp/pods/wasm-hello
  uid: 09f74071-fd90-45be-be7d-466ef211043a
spec:
  containers:
  - image: webassembly.azurecr.io/hello-world-wasi-rust:v0.1.0
    imagePullPolicy: IfNotPresent
    name: wasm-hello
    resources: {}
    terminationMessagePath: /dev/termination-log
    terminationMessagePolicy: File
    volumeMounts:
    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
      name: default-token-h8q2z
      readOnly: true
  dnsPolicy: ClusterFirst
  enableServiceLinks: true
  nodeName: izuf6cc5ecqwtuhm1p2rcaz
  priority: 0
  restartPolicy: Always
  schedulerName: default-scheduler
  securityContext: {}
  serviceAccount: default
  serviceAccountName: default
  terminationGracePeriodSeconds: 30
  tolerations:
  - effect: NoExecute
    key: kubernetes.io/arch
    operator: Equal
    value: wasm32-wasi
  - effect: NoSchedule
    key: kubernetes.io/arch
    operator: Equal
    value: wasm32-wasi
  - effect: NoExecute
    key: node.kubernetes.io/not-ready
    operator: Exists
    tolerationSeconds: 300
  - effect: NoExecute
    key: node.kubernetes.io/unreachable
    operator: Exists
    tolerationSeconds: 300
  volumes:
  - name: default-token-h8q2z
    secret:
      defaultMode: 420
      secretName: default-token-h8q2z
status:
  conditions:
  - lastProbeTime: null
    lastTransitionTime: "2021-07-08T08:37:39Z"
    status: "True"
    type: PodScheduled
  containerStatuses:
  - image: ""
    imageID: ""
    lastState: {}
    name: wasm-hello
    ready: false
    restartCount: 0
    started: true
    state:
      terminated:
        exitCode: 0
        finishedAt: "2021-07-08T08:37:52Z"
        message: Module run completed
        startedAt: null
  message: Completed
  phase: Succeeded
  qosClass: BestEffort
  reason: Completed
</code></pre>
</li>
</ul>
<h2>2. Containerd æ’ä»¶è°ƒåº¦ WASM</h2>
<blockquote>
<p>containerd-wasm å¯ä»¥è®© containerd æ”¯æŒ WASM containerï¼Œå¹¶ä¸”å¯ä»¥åˆ©ç”¨ Kubernetes é›†ç¾¤ç®¡ç†å’Œè°ƒåº¦ WASM containerã€‚</p>
</blockquote>
<blockquote>
<p>æ³¨ï¼šè¿™ä¸ªé¡¹ç›®æ›´å¤šæ˜¯æ¦‚å¿µéªŒè¯ï¼Œè¿›ç¨‹ç®¡ç†ã€èµ„æºé™åˆ¶ï¼Œæ€§èƒ½ä¼˜åŒ–ç­‰çš„ç»†èŠ‚å¹¶æ²¡æœªå®Œæ•´å®ç°ã€‚</p>
</blockquote>
<p><img src="/images/2021-09-01-16.png" alt=""></p>
<p>â€œcontainer-shim-wasm-v1â€ ä½œä¸º Containerd çš„æ’ä»¶ï¼Œåˆ©ç”¨ wasmer ä½œä¸º WASM åº”ç”¨è¿è¡Œæ—¶ç¯å¢ƒï¼ŒåŒæ—¶å°†å…¶æ³¨å†Œä¸º K8s çš„ä¸€ä¸ª RuntimeClass ï¼Œåˆ©ç”¨ K8s è°ƒåº¦ WASMã€‚</p>
<h3>2.1. éƒ¨ç½²å®‰è£…</h3>
<blockquote>
<p>ä½¿ç”¨é¡¹ç›®ï¼š<a href="https://github.com/dippynark/containerd-shim-wasm">https://github.com/dippynark/containerd-shim-wasm</a></p>
</blockquote>
<p>éªŒè¯éœ€è¦ä¸€ä¸ªä½¿ç”¨ Containerd çš„ K8s é›†ç¾¤ç¯å¢ƒï¼Œä½¿ç”¨ Kind éƒ¨ç½²é›†ç¾¤ã€‚</p>
<pre><code class="language-yaml">kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraMounts:
  - hostPath: config/containerd.toml
    containerPath: /etc/containerd/config.toml
  - hostPath: bin/containerd-shim-wasm-v1
    containerPath: /usr/local/bin/containerd-shim-wasm-v1
  - hostPath: bin/wasmer
    containerPath: /usr/local/bin/wasmer
</code></pre>
<p>Containerd çš„é…ç½®ä¸­é…ç½® wasm Runtimeï¼š</p>
<pre><code class="language-yaml"># Custom configuration
# https://github.com/containerd/cri/blob/master/docs/config.md
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.wasm]
  runtime_type = "io.containerd.wasm.v1"
</code></pre>
<blockquote>
<p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.kubernetes.org.cn/7185.html">ç†è§£ RuntimeClass ä¸ä½¿ç”¨å¤šå®¹å™¨è¿è¡Œæ—¶</a></p>
</blockquote>
<p><img src="/images/2021-09-01-17.png" alt=""></p>
<p>Containerd çš„ Runtime ä¼šå¯¹åº”åˆ° K8s çš„ RuntimeClassã€‚</p>
<pre><code class="language-yaml">apiVersion: node.k8s.io/v1beta1
kind: RuntimeClass
metadata:
  name: wasm
handler: wasm
</code></pre>
<p>æ³¨å†Œ K8s RuntimeClass èµ„æºã€‚</p>
<h3>2.2. WASM Runtime è°ƒåº¦</h3>
<h4>2.2.1. ç¼–è¯‘ WASM Module</h4>
<p>ä½¿ç”¨ target ä¸º <code>wasi/wasm</code> è¿›è¡Œç¼–è¯‘ï¼Œæœ€ç»ˆä¼šä½¿ç”¨ <code>wasm32-wasi-clang</code> è¿›è¡Œç¼–è¯‘ã€‚</p>
<pre><code class="language-docker">FROM --platform=$BUILDPLATFORM tonistiigi/xx:llvm AS builder
ARG TARGETPLATFORM
WORKDIR /src
COPY hello-wasm/main.c .
RUN clang -static -o /hello-wasm main.c

FROM scratch
COPY --from=builder /hello-wasm .
CMD ["/hello-wasm"]
</code></pre>
<p>è™½ç„¶ Dockerfile é‡Œå†™äº† <code>CMD</code> ï¼Œä½†æ˜¯å¦‚æœç›´æ¥åœ¨æ“ä½œç³»ç»Ÿä¸Šæ‰§è¡Œå‘½ä»¤ï¼Œä¼šæŠ¥é”™ï¼š</p>
<pre><code class="language-bash">> ./bin/hello-wasm
zsh: exec format error: ./bin/hello-wasm
</code></pre>
<p>æ¨æµ‹ <a href="https://github.com/dmcgowan/containerd-wasm"><code>github.com/dmcgowan/containerd-wasm</code></a> åº“å®é™…ä¸Šä¼šè§£æ Container æ–‡ä»¶ç³»ç»Ÿï¼Œæå–å‡ºè¦æ‰§è¡Œçš„ WASM moduleï¼Œæœ€åè°ƒç”¨è¿è¡Œæ—¶ï¼ˆwasmtime/wasmerï¼‰è¿è¡Œ WASMã€‚</p>
<p>æˆ‘ä»¬å®é™…ä½¿ç”¨ä»»æ„çš„ WASM module æ‰“åŒ…è¿› Docker å®¹å™¨ä¸­ï¼š</p>
<pre><code class="language-docker">FROM scratch
COPY ./hello.wasm .
CMD ["/hello.wasm"]
</code></pre>
<h4>2.2.2. è°ƒåº¦ Pod</h4>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-wasm
spec:
  selector:
    matchLabels:
      app: hello-wasm
  template:
    metadata:
      labels:
        app: hello-wasm
    spec:
      runtimeClassName: wasm
      containers:
      - name: hello-wasm
        ## WASM ç¼–è¯‘æ‰“åŒ…çš„ Docker é•œåƒ
        image: harbor.domain.dev/bifrost/hello-wasm2:v1
        imagePullPolicy: Always
</code></pre>
<p>Pod è¿è¡ŒçŠ¶æ€ï¼š</p>
<pre><code class="language-yaml">default  hello-wasm-86db957848-cgvdj     0/1     Completed     0      7s
</code></pre>
<p>Pod è¾“å‡ºæ—¥å¿—ï¼š</p>
<pre><code class="language-bash">> kubectl logs hello-wasm-86db957848-cgvdj
Hello from WebAssembly!
</code></pre>
<h3>2.3. å¯¹æ¯” Krustlet</h3>
<blockquote>
<p>One difficulty with this shim implementation is that the shim API assumes a container runtime (as that's what it was designed for), but this doens't align as well with running WebAssmebly modules (for example currently you can't exec into a WebAssmebly module as you would a container). The Krustlet project implements a Kubelet replacement that treats wasi/wasm modules as first class citizens.</p>
</blockquote>
<p>ä½œä¸º Containerd æ’ä»¶çš„ WASM Runtime å®ç°èµ·æ¥è¾ƒä¸ºç®€å•ï¼ŒåŒæ—¶ä»£ç ä¸­æœ‰å¤§é‡çš„ TODOã€‚</p>
<p>ä½†æ˜¯å‚ç…§å…¶å®ç°çš„æ¨¡å¼ï¼Œå…¬å¸å†…éƒ¨ä¹Ÿå¯è‡ªè¡Œå®è¡Œä¸€å¥— WASM æ¨¡å—åˆ†å‘æœºåˆ¶ï¼Œè¿è¡Œæ—¶åªéœ€åŠ è½½å¯¹åº”æ¨¡å—ï¼Œè°ƒç”¨ï¼ˆwasmtime/wasmerï¼‰è¿è¡Œå³å¯ã€‚</p>
<section data-footnotes class="footnotes"><h2 class="sr-only" id="footnote-label">Footnotes</h2>
<ol>
<li id="user-content-fn-1">
<p>Webassembly åœ¨å„ç±»æ–‡ç« ä¸­è¢«æ§ä¸Šå¤©ï¼Œä½†æ˜¯æˆªè‡³ 2021 å¹´å®ƒçš„ä½¿ç”¨åœºæ™¯è¿˜ååˆ†å±€é™ã€‚ <a href="#user-content-fnref-1" data-footnote-backref="" aria-label="Back to reference 1" class="data-footnote-backref">â†©</a></p>
</li>
</ol>
</section></article><script src="/_next/static/chunks/webpack-072f062dc024cc52.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[5803,[],\"\"]\n3:I[695,[],\"\"]\n5:I[2576,[],\"OutletBoundary\"]\n7:I[2576,[],\"MetadataBoundary\"]\n9:I[2576,[],\"ViewportBoundary\"]\nb:I[7614,[],\"\"]\n:HL[\"/_next/static/css/c3b55921f92a131e.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"n66w3jQXdD0TOkFlxRfSe\",\"p\":\"\",\"c\":[\"\",\"2021\",\"09\",\"k8s-%25E9%259B%2586%25E7%25BE%25A4%25E8%25B0%2583%25E5%25BA%25A6-wasm-%25E5%25AE%259E%25E9%25AA%258C\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"(posts)\",{\"children\":[[\"year\",\"2021\",\"d\"],{\"children\":[[\"month\",\"09\",\"d\"],{\"children\":[[\"slug\",\"k8s-%25E9%259B%2586%25E7%25BE%25A4%25E8%25B0%2583%25E5%25BA%25A6-wasm-%25E5%25AE%259E%25E9%25AA%258C\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/c3b55921f92a131e.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"children\":[\"$\",\"body\",null,{\"className\":\"antialiased\",\"children\":[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[],[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]}]]}],{\"children\":[\"(posts)\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(posts)\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[],[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":\"$0:f:0:1:1:props:children:1:props:children:props:children:props:notFound:1:1:props:style\",\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":\"$0:f:0:1:1:props:children:1:props:children:props:children:props:notFound:1:1:props:children:props:children:1:props:style\",\"children\":404}],[\"$\",\"div\",null,{\"style\":\"$0:f:0:1:1:props:children:1:props:children:props:children:props:notFound:1:1:props:children:props:children:2:props:style\",\"children\":[\"$\",\"h2\",null,{\"style\":\"$0:f:0:1:1:props:children:1:props:children:props:children:props:notFound:1:1:props:children:props:children:2:props:children:props:style\",\"children\":\"This page could not be found.\"}]}]]}]}]]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"year\",\"2021\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(posts)\",\"children\",\"$0:f:0:1:2:children:2:children:0\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"month\",\"09\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(posts)\",\"children\",\"$0:f:0:1:2:children:2:children:0\",\"children\",\"$0:f:0:1:2:children:2:children:2:children:0\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"slug\",\"k8s-%25E9%259B%2586%25E7%25BE%25A4%25E8%25B0%2583%25E5%25BA%25A6-wasm-%25E5%25AE%259E%25E9%25AA%258C\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(posts)\",\"children\",\"$0:f:0:1:2:children:2:children:0\",\"children\",\"$0:f:0:1:2:children:2:children:2:children:0\",\"children\",\"$0:f:0:1:2:children:2:children:2:children:2:children:0\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[\"$L4\",null,[\"$\",\"$L5\",null,{\"children\":\"$L6\"}]]}],{},null,false]},null,false]},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"ET2qBR-ovXfdg7Mfzzcy0\",{\"children\":[[\"$\",\"$L7\",null,{\"children\":\"$L8\"}],[\"$\",\"$L9\",null,{\"children\":\"$La\"}],null]}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$b\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"a:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n8:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Mayo Rocks!\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"Mayo's Blog\"}],[\"$\",\"link\",\"3\",{\"rel\":\"icon\",\"href\":\"/icon.png?14d5a92fbe70e82a\",\"type\":\"image/png\",\"sizes\":\"460x460\"}]]\n"])</script><script>self.__next_f.push([1,"6:null\n"])</script><script>self.__next_f.push([1,"c:T517c,"])</script><script>self.__next_f.push([1,"\u003cp\u003eWebassemblyï¼ˆWASMï¼‰æ˜¯ Next-Generation çš„è½¯ä»¶åˆ†å‘æ–¹å¼ï¼Œå…·æœ‰è·¨è¯­è¨€ã€è·¨å¹³å°ã€è‡ªå¸¦è¿è¡Œæ—¶çš„æ— æ•Œå±æ€§\u003csup\u003e\u003ca href=\"#user-content-fn-1\" id=\"user-content-fnref-1\" data-footnote-ref aria-describedby=\"footnote-label\"\u003e1\u003c/a\u003e\u003c/sup\u003eã€‚çŸ¥æ™“äº†å®ƒçš„ç¾å¦™ä¹‹å¤„ï¼Œæˆ‘ä»¬è‡ªç„¶ä¼šæƒ³æ‹¥æœ‰æ¬¡ä¸–ä»£çš„ä½“éªŒï¼Œæœ¬æ–‡æè¿°å°è¯•å°†è½»é‡çº§ WASM ç”¨ç±» OCI æ‰“åŒ…æ–¹å¼è°ƒåº¦åˆ° K8s é›†ç¾¤ä¸­è¿è¡Œçš„è¿‡ç¨‹ï¼Œä»¥åŠå…¶ä¸­çš„è‰°è¾›ä¹‹å¤„ã€‚\u003c/p\u003e\n\u003cp\u003eWASM åœ¨å½“å‰é˜¶æ®µè¿˜å¾ˆå°´å°¬ï¼ŒWASIï¼ˆWebAssembly System Interfaceï¼‰è¿˜å¤„äº\u003ca href=\"https://github.com/WebAssembly/WASI/milestone/1\"\u003eæ—©æœŸé˜¶æ®µ\u003c/a\u003eï¼ŒWASM è¿è¡Œæ—¶é¡¹ç›® \u003ca href=\"https://github.com/wasmerio/wasmer\"\u003eWasmer\u003c/a\u003e ä¸ \u003ca href=\"https://github.com/bytecodealliance/wasmtime\"\u003ewasmtime\u003c/a\u003e å¯¹äºå¤šè¯­è¨€çš„æ”¯æŒè¿˜ä¸è¶³ï¼Œäº‘å‚å•†ä¾‹å¦‚ Cloudflare ä¸ AWS Lambda@Edge éƒ½ä¸æ˜¯åŸç”Ÿæ”¯æŒ WASMï¼ŒWASM çš„æ‰§è¡Œæ€§èƒ½ä¹Ÿå¯èƒ½æ¯”ä¸ä¸Š Google çš„ v8 JavaScript å¼•æ“ã€‚\u003c/p\u003e\n\u003cp\u003eå½“æˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†ä¸€äº›å¸Œæœ›ï¼šGo å®˜æ–¹ä¹Ÿè®¸ä¼š\u003ca href=\"https://github.com/golang/go/issues/31105\"\u003eæ”¯æŒ WASI\u003c/a\u003eã€APISIX å‡†å¤‡\u003ca href=\"https://github.com/apache/apisix/issues/157\"\u003eä½¿ç”¨ Wamser ä½œä¸º WASM è¿è¡Œæ—¶\u003c/a\u003eã€‚\u003c/p\u003e\n\u003cp\u003eæˆ‘å½“å‰åœ¨è¿›è¡Œçš„å¦ä¸€ä¸ªé¡¹ç›®ä¹Ÿé€šè¿‡åœ¨æµè§ˆå™¨ä¸­åŠ è½½ WASM å®ç° X.509 è¯ä¹¦è§£æã€ç­¾åä¸ ACME ç”³è¯·è¯ä¹¦ï¼Œè¯¥é¡¹ç›®è¿˜ä¼šä½¿ç”¨ Serverless æŠ€æœ¯è¿›è¡Œæµé‡ä»£ç†ï¼Œä¸è¿‡è¿™ä¸ªå‘ä½•æ—¶èƒ½å¡«å®Œå°±æ²¡æœ‰äººçŸ¥é“äº† ğŸ’€ã€‚\u003c/p\u003e\n\u003ch2\u003e1. Krustlet è°ƒåº¦ WASM\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003eKrustlet ä»‹ç»ï¼š\u003ca href=\"https://www.infoq.cn/article/oumc77mjsl67m39lqgtg\"\u003eä½¿ç”¨ Rust å¼€å‘çš„ kubeletï¼Œç”¨äºè¿è¡Œ WASM å·¥ä½œè´Ÿè½½\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eæ¦‚è¿°ï¼šKrustlet çš„å·¥ä½œæ–¹å¼ç±»ä¼¼äº Kubeletï¼Œæ˜¯åœ¨ K8s é›†ç¾¤å·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡Œçš„åå°ç¨‹åºï¼Œè´Ÿè´£ä¸ŠæŠ¥èŠ‚ç‚¹çŠ¶æ€ä»¥åŠè¿è¡Œå·¥ä½œè´Ÿè½½ï¼ˆWASMï¼‰ã€‚\u003c/p\u003e\n\u003cp\u003eç›®å‰ä¸æ”¯æŒ CNI ç½‘ç»œã€‚\u003c/p\u003e\n\u003ch3\u003e1.1. éƒ¨ç½²å®‰è£…\u003c/h3\u003e\n\u003ch4\u003e1.1.1. æµ‹è¯•ç¯å¢ƒ\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003eé˜¿é‡Œäº‘æµ‹è¯•é›†ç¾¤ - \u003ccode\u003e192.168.33.161\u003c/code\u003e æœºå™¨ï¼ˆ2c 8gï¼‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4\u003e1.1.2. å®‰è£… Krustlet\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e#!/bin/bash\n\nwget https://krustlet.blob.core.windows.net/releases/krustlet-v0.7.0-linux-amd64.tar.gz -O /tmp/krustlet.tar.gz\ntar zxvf /tmp/krustlet.tar.gz \u0026#x26;\u0026#x26; mv krustlet-wasi /usr/local/bin/\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4\u003e1.1.3. èŠ‚ç‚¹åˆå§‹åŒ–\u003c/h4\u003e\n\u003cblockquote\u003e\n\u003cp\u003eæ ¹æ®å®˜æ–¹æ–‡æ¡£è¿›è¡ŒèŠ‚ç‚¹åˆå§‹åŒ–: \u003ca href=\"https://docs.krustlet.dev/intro/quickstart/\"\u003equickstart\u003c/a\u003eã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eæ­¥éª¤ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eèŠ‚ç‚¹ä¸Šå®‰è£… Kubectl å¹¶é…ç½®æœ‰åœ¨ \u003ccode\u003ekube-system\u003c/code\u003e ä¸‹åˆ›å»º CSR èµ„æºçš„å‡­è¯\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eæ‰§è¡Œåˆå§‹åŒ–è„šæœ¬\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003ebash \u0026#x3C;(curl https://raw.githubusercontent.com/deislabs/krustlet/master/docs/howto/assets/bootstrap.sh)\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eåˆ›å»º Systemd æ–‡ä»¶ \u003ccode\u003e/etc/systemd/system/krustlet.service\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e[Unit]\nDescription=Krustlet, a kubelet implementation for running WASM\n\n[Service]\nRestart=on-failure\nRestartSec=5s\nEnvironment=KUBECONFIG=/root/.kube/config\nExecStart=/usr/local/bin/krustlet-wasi\nUser=root\nGroup=root\n\n[Install]\nWantedBy=multi-user.target\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003esystemctl daemon-reload\nsystemctl enable krustlet.service\nsystemctl start krustlet.service\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eå®¡æ ¸ CSR ç”³è¯·\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003ekubectl certificate approve ${HOSTNAME}-tls\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch4\u003e1.1.4. èŠ‚ç‚¹çŠ¶æ€\u003c/h4\u003e\n\u003cp\u003e\u003cimg src=\"/images/2021-09-01-18.png\" alt=\"ç­‰å¾…æ‰‹åŠ¨ Approve\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/2021-09-01-14.png\" alt=\"ç¨‹åºæ­£å¸¸å¯åŠ¨\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/2021-09-01-15.png\" alt=\"Krustlet èŠ‚ç‚¹å·²åŠ å…¥é›†ç¾¤\"\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eKrustlet èŠ‚ç‚¹è¯¦æƒ… \u003ccode\u003ekubectl describe node ${HOSTNAME}\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003eName:               izuf6cc5ecqwtuhm1p2rcaz\nRoles:              \u0026#x3C;none\u003e\nLabels:             beta.kubernetes.io/arch=wasm32-wasi\n                    beta.kubernetes.io/os=wasm32-wasi\n                    kubernetes.io/arch=wasm32-wasi\n                    kubernetes.io/hostname=iZuf6cc5ecqwtuhm1p2rcaZ\n                    kubernetes.io/os=wasm32-wasi\n                    type=krustlet\nAnnotations:        node.alpha.kubernetes.io/ttl: 0\n                    volumes.kubernetes.io/controller-managed-attach-detach: true\nCreationTimestamp:  Thu, 08 Jul 2021 14:45:26 +0800\nTaints:             kubernetes.io/arch=wasm32-wasi:NoExecute\n                    kubernetes.io/arch=wasm32-wasi:NoSchedule\nUnschedulable:      false\nLease:\n  HolderIdentity:  izuf6cc5ecqwtuhm1p2rcaz\n  AcquireTime:     Thu, 08 Jul 2021 14:49:37 +0800\n  RenewTime:       Thu, 08 Jul 2021 14:49:37 +0800\nConditions:\n  Type        Status  LastHeartbeatTime                 LastTransitionTime                Reason                     Message\n  ----        ------  -----------------                 ------------------                ------                     -------\n  Ready       True    Thu, 08 Jul 2021 14:49:37 +0800   Thu, 08 Jul 2021 14:45:26 +0800   KubeletReady               kubelet is posting ready status\n  OutOfDisk   False   Thu, 08 Jul 2021 14:45:26 +0800   Thu, 08 Jul 2021 14:45:26 +0800   KubeletHasSufficientDisk   kubelet has sufficient disk space available\nAddresses:\n  InternalIP:  192.168.33.161\n  Hostname:    iZuf6cc5ecqwtuhm1p2rcaZ\nCapacity:\n  cpu:                4\n  ephemeral-storage:  61255492Ki\n  hugepages-1Gi:      0\n  hugepages-2Mi:      0\n  memory:             4032800Ki\n  pods:               110\nAllocatable:\n  cpu:                4\n  ephemeral-storage:  61255492Ki\n  hugepages-1Gi:      0\n  hugepages-2Mi:      0\n  memory:             4032800Ki\n  pods:               110\nSystem Info:\n  Machine ID:\n  System UUID:\n  Boot ID:\n  Kernel Version:\n  OS Image:\n  Operating System:           linux\n  Architecture:               wasm-wasi\n  Container Runtime Version:  mvp\n  Kubelet Version:            0.7.0\n  Kube-Proxy Version:         v1.17.0\nPodCIDR:                      10.244.0.0/24\nPodCIDRs:                     10.244.0.0/24\nNon-terminated Pods:          (3 in total)\n  Namespace                   Name                   CPU Requests  CPU Limits  Memory Requests  Memory Limits  Age\n  ---------                   ----                   ------------  ----------  ---------------  -------------  ---\n  kruise-system               kruise-daemon-v9nfh    0 (0%)        50m (1%)    0 (0%)           64Mi (1%)      4m17s\n  kube-system                 calico-node-m4d67      150m (3%)     300m (7%)   64M (1%)         500M (12%)     4m17s\n  kube-system                 nodelocaldns-k5kd2     100m (2%)     0 (0%)      70Mi (1%)        170Mi (4%)     4m17s\nAllocated resources:\n  (Total limits may be over 100 percent, i.e., overcommitted.)\n  Resource           Requests        Limits\n  --------           --------        ------\n  cpu                250m (6%)       350m (8%)\n  memory             137400320 (3%)  745366784 (18%)\n  ephemeral-storage  0 (0%)          0 (0%)\n  hugepages-1Gi      0 (0%)          0 (0%)\n  hugepages-2Mi      0 (0%)          0 (0%)\nEvents:              \u0026#x3C;none\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eèŠ‚ç‚¹å¸¦æœ‰ä¸¤ä¸ªæ±¡ç‚¹ï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003eTaints:             kubernetes.io/arch=wasm32-wasi:NoExecute\n                    kubernetes.io/arch=wasm32-wasi:NoSchedule\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003e1.2. WASM OCI\u003c/h3\u003e\n\u003cp\u003eKrustlet ä½¿ç”¨ \u003ca href=\"https://github.com/engineerd/wasm-to-oci\"\u003ewasm-to-oci\u003c/a\u003e æ‰“åŒ… WASM ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶åˆ°é•œåƒä»“åº“ã€‚\u003c/p\u003e\n\u003ch4\u003e1.2.1. æ¨é€é•œåƒ\u003c/h4\u003e\n\u003cp\u003eå®‰è£… wasm-to-oci CLI\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003ewget https://github.com/engineerd/wasm-to-oci/releases/download/v0.1.2/linux-amd64-wasm-to-oci -O /usr/local/bin/wasm-to-oci \\\n\u0026#x26;\u0026#x26; chmod +x /usr/local/bin/wasm-to-oci\n\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003ewasm-to-oci\u003c/code\u003e Usage\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003eUsage:\n  wasm-to-oci [command]\n\nAvailable Commands:\n  help        Help about any command\n  pull        Pulls a WASM module from an OCI registry\n  push        Pushes a WASM module from an OCI registry\n\nFlags:\n  -d, --dir string         Directory where the trust data is persisted to (default \"/root/.wasm-to-oci\")\n  -h, --help               help for wasm-to-oci\n      --insecure           allow connections to SSL registry without certs\n      --log string         Set the logging level (\"debug\"|\"info\"|\"warn\"|\"error\"|\"fatal\") (default \"info\")\n      --server string      The trust server used (default \"https://notary.docker.io\")\n  -t, --timeout string     Timeout for the trust server (default \"5s\")\n      --tlscacert string   Trust certs signed only by this CA\n      --use-http           use plain http and not https\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eæ‰“åŒ…ç¤ºä¾‹ WASMï¼ˆäºŒè¿›åˆ¶ç¼–è¯‘åçš„æ–‡ä»¶ï¼‰\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003ewget https://github.com/engineerd/wasm-to-oci/raw/master/testdata/hello.wasm\nwasm-to-oci push hello.wasm harbor.domain.dev/bifrost/hello-wasm:v1\n\u003c/code\u003e\u003c/pre\u003e\n\u003cblockquote\u003e\n\u003cp\u003eDocker éœ€è¦æœ‰ Registry çš„å‡­è¯ \u003ccode\u003e~/.docker/config.json\u003c/code\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003ePush è¾“å‡ºï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003eINFO[0001] Pushed: harbor.domain.dev/bifrost/hello-wasm:v1\nINFO[0001] Size: 1624962\nINFO[0001] Digest: sha256:a01f32cc647abe49bb34727cc2c520e6e304e3049d669f53e2d30d49ee2ed9c7\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ewasm-oci ä½¿ç”¨äº†è‡ªå®šä¹‰çš„ OCI Layerï¼Œå±äºéæ ‡å‡†ç±»å‹ã€‚\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003ca href=\"https://radu-matei.com/blog/wasm-oci-tuf/\"\u003eSecurely distributing and signing WebAssembly modules using OCI and TUF\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cpre\u003e\u003ccode class=\"language-json\"\u003e{\n  \"schemaVersion\": 2,\n  \"config\": {\n    \"mediaType\": \"application/vnd.wasm.config.v1+json\",\n    \"digest\": \"sha256:44136fa355b3678a1146ad16f7e8649e94fb4fc21fe77e8310c060f61caaff8a\",\n    \"size\": 2\n  },\n  \"layers\": [\n    {\n      \"mediaType\": \"application/vnd.wasm.content.layer.v1+wasm\",\n      \"digest\": \"sha256:4c7915b4c1f9b0c13f962998e4199ceb00db39a4a7fa4554f40ae0bed83d9510\",\n      \"size\": 1624962\n    }\n  ]\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4\u003e1.2.2. æ‹‰å–é•œåƒ\u003c/h4\u003e\n\u003cp\u003eç”±äºæ˜¯éæ ‡å‡†æ ¼å¼çš„ OCI é•œåƒï¼Œç›´æ¥ä½¿ç”¨ Docker CLI æ‹‰å–ä¼šå‡ºé”™ï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003ev1: Pulling from bifrost/hello-wasm\n4c7915b4c1f9: Pulling fs layer\ninvalid rootfs in image configuration\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4\u003e1.2.3. WASM module ä¸å®¹å™¨åŒºåˆ«\u003c/h4\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/deislabs/krustlet/issues/624#issuecomment-855607557\"\u003eKrustlet-tutorial pod get stuck in init:regitered status Â· Issue #624 Â· deislabs/krustlet\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eWASM OCI ä¸æ˜¯ Docker å®¹å™¨\u003c/li\u003e\n\u003cli\u003eWASM OCI ä¸èƒ½ä½¿ç”¨ Docker pull\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003e1.3. WASM Pod è°ƒåº¦\u003c/h3\u003e\n\u003cp\u003eWASM è°ƒåº¦çš„æœ€å°å•å…ƒæ˜¯ Podï¼ŒPod å®šä¹‰ä¸­å¿…é¡»åŒ…å« WASM èŠ‚ç‚¹çš„ tolerationsã€‚\u003c/p\u003e\n\u003ch4\u003e1.3.1. Pod è°ƒåº¦\u003c/h4\u003e\n\u003cp\u003eç¤ºä¾‹ Podï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-yaml\"\u003eapiVersion: v1\nkind: Pod\nmetadata:\n  name: wasm-hello\nspec:\n  containers:\n    - name: wasm-hello\n      image: harbor.domain.dev/bifrost/hello-wasm:v1\n  tolerations:\n    - key: \"kubernetes.io/arch\"\n      operator: \"Equal\"\n      value: \"wasm32-wasi\"\n      effect: \"NoExecute\"\n    - key: \"kubernetes.io/arch\"\n      operator: \"Equal\"\n      value: \"wasm32-wasi\"\n      effect: \"NoSchedule\"\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e\u003e k apply -f wasm-hello.yaml\npod/wasm-hello created\n\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eå°æ’æ›²\u003c/p\u003e\n\u003cp\u003eè¯•éªŒè¿‡ç¨‹ä¸­å‘ç°ä½¿ç”¨ wasm-to-oci æ¨é€é•œåƒåˆ°è‡ªå»ºçš„ Harbor é•œåƒä»“åº“åï¼Œæ‹‰å–é•œåƒæ—¶ä¼šæŠ¥é”™ã€‚\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/deislabs/krustlet/issues/624\"\u003eKrustlet-tutorial pod get stuck in init:regitered status Â· Issue #624 Â· deislabs/krustlet\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eå…³è”åˆ°ä¸€ä¸ª Issueï¼Œéƒ¨åˆ† Registry ä¼šæ— æ³•æ‹‰å–é•œåƒï¼ŒæŠ¥é”™ï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003ekrustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG hyper::proto::h1::conn] incoming body is content-length (950 bytes)\nkrustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG hyper::proto::h1::conn] incoming body completed\nkrustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG hyper::client::pool] pooling idle connection for (\"https\", harbor....)\nkrustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG reqwest::async_impl::client] response '200 OK' for https://harbor..../service/token?scope=repository%3Abifrost%2Fhello-wasm%3Apull\u0026#x26;service=harbor-registry\nkrustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG oci_distribution::client] Received response from auth request: {\"token\":\"...\",\"access_token\":\"\",\"expires_in\":1800,\"issued_at\":\"2021-07-08T08:31:46Z\"}\nkrustlet-wasi[20706]: [2021-07-08T08:31:46Z ERROR kubelet::state::common::image_pull] Failed to decode registry token from auth request\nkrustlet-wasi[20706]:\nkrustlet-wasi[20706]:     Caused by:\nkrustlet-wasi[20706]:         duplicate field `token` at line 1 column 1129\nkrustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG krator::state] State::status\nkrustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG krator::state] Applying status patch to object. name=wasm-hello patch={\"metadata\":{\"resourceVersion\":\"\"},\"status\":{\"phase\":\"Pending\",\"message\":\"ImagePullBackoff\",\"reason\":\"ImagePullBackoff\"}}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå°†é•œåƒæ›¿æ¢ä¸º \u003ca href=\"http://webassembly.azurecr.io/hello-world-wasi-rust:v0.1.0\"\u003e\u003ccode\u003ewebassembly.azurecr.io/hello-world-wasi-rust:v0.1.0\u003c/code\u003e\u003c/a\u003e å¯æ­£å¸¸è¿è¡Œã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4\u003e1.3.2. Pod è¿è¡Œæ—¶\u003c/h4\u003e\n\u003cp\u003eæŸ¥çœ‹ Pod è¿è¡ŒçŠ¶æ€ï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e\u003e k get pod -n ns-msp | grep wasm\nwasm-hello        0/1     ExitCode:0         0          13m\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ePod è¢«è°ƒåº¦åç«‹åˆ»è¢«æ‰§è¡Œï¼Œè¿”å› ExitCode 0ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e\u003e k logs -n ns-msp -f wasm-hello\nhello from stdout!\nhello from stderr!\nArgs are: []\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ekubectl æŸ¥çœ‹ä¸è¿è¡Œæ—¥å¿—ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003ePod YAML\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-yaml\"\u003eapiVersion: v1\nkind: Pod\nmetadata:\n  creationTimestamp: \"2021-07-08T08:37:39Z\"\n  name: wasm-hello\n  namespace: ns-msp\n  resourceVersion: \"543645433\"\n  selfLink: /api/v1/namespaces/ns-msp/pods/wasm-hello\n  uid: 09f74071-fd90-45be-be7d-466ef211043a\nspec:\n  containers:\n  - image: webassembly.azurecr.io/hello-world-wasi-rust:v0.1.0\n    imagePullPolicy: IfNotPresent\n    name: wasm-hello\n    resources: {}\n    terminationMessagePath: /dev/termination-log\n    terminationMessagePolicy: File\n    volumeMounts:\n    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount\n      name: default-token-h8q2z\n      readOnly: true\n  dnsPolicy: ClusterFirst\n  enableServiceLinks: true\n  nodeName: izuf6cc5ecqwtuhm1p2rcaz\n  priority: 0\n  restartPolicy: Always\n  schedulerName: default-scheduler\n  securityContext: {}\n  serviceAccount: default\n  serviceAccountName: default\n  terminationGracePeriodSeconds: 30\n  tolerations:\n  - effect: NoExecute\n    key: kubernetes.io/arch\n    operator: Equal\n    value: wasm32-wasi\n  - effect: NoSchedule\n    key: kubernetes.io/arch\n    operator: Equal\n    value: wasm32-wasi\n  - effect: NoExecute\n    key: node.kubernetes.io/not-ready\n    operator: Exists\n    tolerationSeconds: 300\n  - effect: NoExecute\n    key: node.kubernetes.io/unreachable\n    operator: Exists\n    tolerationSeconds: 300\n  volumes:\n  - name: default-token-h8q2z\n    secret:\n      defaultMode: 420\n      secretName: default-token-h8q2z\nstatus:\n  conditions:\n  - lastProbeTime: null\n    lastTransitionTime: \"2021-07-08T08:37:39Z\"\n    status: \"True\"\n    type: PodScheduled\n  containerStatuses:\n  - image: \"\"\n    imageID: \"\"\n    lastState: {}\n    name: wasm-hello\n    ready: false\n    restartCount: 0\n    started: true\n    state:\n      terminated:\n        exitCode: 0\n        finishedAt: \"2021-07-08T08:37:52Z\"\n        message: Module run completed\n        startedAt: null\n  message: Completed\n  phase: Succeeded\n  qosClass: BestEffort\n  reason: Completed\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e2. Containerd æ’ä»¶è°ƒåº¦ WASM\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003econtainerd-wasm å¯ä»¥è®© containerd æ”¯æŒ WASM containerï¼Œå¹¶ä¸”å¯ä»¥åˆ©ç”¨ Kubernetes é›†ç¾¤ç®¡ç†å’Œè°ƒåº¦ WASM containerã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cblockquote\u003e\n\u003cp\u003eæ³¨ï¼šè¿™ä¸ªé¡¹ç›®æ›´å¤šæ˜¯æ¦‚å¿µéªŒè¯ï¼Œè¿›ç¨‹ç®¡ç†ã€èµ„æºé™åˆ¶ï¼Œæ€§èƒ½ä¼˜åŒ–ç­‰çš„ç»†èŠ‚å¹¶æ²¡æœªå®Œæ•´å®ç°ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e\u003cimg src=\"/images/2021-09-01-16.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eâ€œcontainer-shim-wasm-v1â€ ä½œä¸º Containerd çš„æ’ä»¶ï¼Œåˆ©ç”¨ wasmer ä½œä¸º WASM åº”ç”¨è¿è¡Œæ—¶ç¯å¢ƒï¼ŒåŒæ—¶å°†å…¶æ³¨å†Œä¸º K8s çš„ä¸€ä¸ª RuntimeClass ï¼Œåˆ©ç”¨ K8s è°ƒåº¦ WASMã€‚\u003c/p\u003e\n\u003ch3\u003e2.1. éƒ¨ç½²å®‰è£…\u003c/h3\u003e\n\u003cblockquote\u003e\n\u003cp\u003eä½¿ç”¨é¡¹ç›®ï¼š\u003ca href=\"https://github.com/dippynark/containerd-shim-wasm\"\u003ehttps://github.com/dippynark/containerd-shim-wasm\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eéªŒè¯éœ€è¦ä¸€ä¸ªä½¿ç”¨ Containerd çš„ K8s é›†ç¾¤ç¯å¢ƒï¼Œä½¿ç”¨ Kind éƒ¨ç½²é›†ç¾¤ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-yaml\"\u003ekind: Cluster\napiVersion: kind.x-k8s.io/v1alpha4\nnodes:\n- role: control-plane\n  extraMounts:\n  - hostPath: config/containerd.toml\n    containerPath: /etc/containerd/config.toml\n  - hostPath: bin/containerd-shim-wasm-v1\n    containerPath: /usr/local/bin/containerd-shim-wasm-v1\n  - hostPath: bin/wasmer\n    containerPath: /usr/local/bin/wasmer\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eContainerd çš„é…ç½®ä¸­é…ç½® wasm Runtimeï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-yaml\"\u003e# Custom configuration\n# https://github.com/containerd/cri/blob/master/docs/config.md\n[plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.wasm]\n  runtime_type = \"io.containerd.wasm.v1\"\n\u003c/code\u003e\u003c/pre\u003e\n\u003cblockquote\u003e\n\u003cp\u003eå‚è€ƒæ–‡ç« ï¼š\u003ca href=\"https://www.kubernetes.org.cn/7185.html\"\u003eç†è§£ RuntimeClass ä¸ä½¿ç”¨å¤šå®¹å™¨è¿è¡Œæ—¶\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e\u003cimg src=\"/images/2021-09-01-17.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eContainerd çš„ Runtime ä¼šå¯¹åº”åˆ° K8s çš„ RuntimeClassã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-yaml\"\u003eapiVersion: node.k8s.io/v1beta1\nkind: RuntimeClass\nmetadata:\n  name: wasm\nhandler: wasm\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eæ³¨å†Œ K8s RuntimeClass èµ„æºã€‚\u003c/p\u003e\n\u003ch3\u003e2.2. WASM Runtime è°ƒåº¦\u003c/h3\u003e\n\u003ch4\u003e2.2.1. ç¼–è¯‘ WASM Module\u003c/h4\u003e\n\u003cp\u003eä½¿ç”¨ target ä¸º \u003ccode\u003ewasi/wasm\u003c/code\u003e è¿›è¡Œç¼–è¯‘ï¼Œæœ€ç»ˆä¼šä½¿ç”¨ \u003ccode\u003ewasm32-wasi-clang\u003c/code\u003e è¿›è¡Œç¼–è¯‘ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-docker\"\u003eFROM --platform=$BUILDPLATFORM tonistiigi/xx:llvm AS builder\nARG TARGETPLATFORM\nWORKDIR /src\nCOPY hello-wasm/main.c .\nRUN clang -static -o /hello-wasm main.c\n\nFROM scratch\nCOPY --from=builder /hello-wasm .\nCMD [\"/hello-wasm\"]\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè™½ç„¶ Dockerfile é‡Œå†™äº† \u003ccode\u003eCMD\u003c/code\u003e ï¼Œä½†æ˜¯å¦‚æœç›´æ¥åœ¨æ“ä½œç³»ç»Ÿä¸Šæ‰§è¡Œå‘½ä»¤ï¼Œä¼šæŠ¥é”™ï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e\u003e ./bin/hello-wasm\nzsh: exec format error: ./bin/hello-wasm\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eæ¨æµ‹ \u003ca href=\"https://github.com/dmcgowan/containerd-wasm\"\u003e\u003ccode\u003egithub.com/dmcgowan/containerd-wasm\u003c/code\u003e\u003c/a\u003e åº“å®é™…ä¸Šä¼šè§£æ Container æ–‡ä»¶ç³»ç»Ÿï¼Œæå–å‡ºè¦æ‰§è¡Œçš„ WASM moduleï¼Œæœ€åè°ƒç”¨è¿è¡Œæ—¶ï¼ˆwasmtime/wasmerï¼‰è¿è¡Œ WASMã€‚\u003c/p\u003e\n\u003cp\u003eæˆ‘ä»¬å®é™…ä½¿ç”¨ä»»æ„çš„ WASM module æ‰“åŒ…è¿› Docker å®¹å™¨ä¸­ï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-docker\"\u003eFROM scratch\nCOPY ./hello.wasm .\nCMD [\"/hello.wasm\"]\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4\u003e2.2.2. è°ƒåº¦ Pod\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"language-yaml\"\u003eapiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: hello-wasm\nspec:\n  selector:\n    matchLabels:\n      app: hello-wasm\n  template:\n    metadata:\n      labels:\n        app: hello-wasm\n    spec:\n      runtimeClassName: wasm\n      containers:\n      - name: hello-wasm\n        ## WASM ç¼–è¯‘æ‰“åŒ…çš„ Docker é•œåƒ\n        image: harbor.domain.dev/bifrost/hello-wasm2:v1\n        imagePullPolicy: Always\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ePod è¿è¡ŒçŠ¶æ€ï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-yaml\"\u003edefault  hello-wasm-86db957848-cgvdj     0/1     Completed     0      7s\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ePod è¾“å‡ºæ—¥å¿—ï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e\u003e kubectl logs hello-wasm-86db957848-cgvdj\nHello from WebAssembly!\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003e2.3. å¯¹æ¯” Krustlet\u003c/h3\u003e\n\u003cblockquote\u003e\n\u003cp\u003eOne difficulty with this shim implementation is that the shim API assumes a container runtime (as that's what it was designed for), but this doens't align as well with running WebAssmebly modules (for example currently you can't exec into a WebAssmebly module as you would a container). The Krustlet project implements a Kubelet replacement that treats wasi/wasm modules as first class citizens.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eä½œä¸º Containerd æ’ä»¶çš„ WASM Runtime å®ç°èµ·æ¥è¾ƒä¸ºç®€å•ï¼ŒåŒæ—¶ä»£ç ä¸­æœ‰å¤§é‡çš„ TODOã€‚\u003c/p\u003e\n\u003cp\u003eä½†æ˜¯å‚ç…§å…¶å®ç°çš„æ¨¡å¼ï¼Œå…¬å¸å†…éƒ¨ä¹Ÿå¯è‡ªè¡Œå®è¡Œä¸€å¥— WASM æ¨¡å—åˆ†å‘æœºåˆ¶ï¼Œè¿è¡Œæ—¶åªéœ€åŠ è½½å¯¹åº”æ¨¡å—ï¼Œè°ƒç”¨ï¼ˆwasmtime/wasmerï¼‰è¿è¡Œå³å¯ã€‚\u003c/p\u003e\n\u003csection data-footnotes class=\"footnotes\"\u003e\u003ch2 class=\"sr-only\" id=\"footnote-label\"\u003eFootnotes\u003c/h2\u003e\n\u003col\u003e\n\u003cli id=\"user-content-fn-1\"\u003e\n\u003cp\u003eWebassembly åœ¨å„ç±»æ–‡ç« ä¸­è¢«æ§ä¸Šå¤©ï¼Œä½†æ˜¯æˆªè‡³ 2021 å¹´å®ƒçš„ä½¿ç”¨åœºæ™¯è¿˜ååˆ†å±€é™ã€‚ \u003ca href=\"#user-content-fnref-1\" data-footnote-backref=\"\" aria-label=\"Back to reference 1\" class=\"data-footnote-backref\"\u003eâ†©\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/section\u003e"])</script><script>self.__next_f.push([1,"4:[\"$\",\"article\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"$c\"}}]\n"])</script></body></html>