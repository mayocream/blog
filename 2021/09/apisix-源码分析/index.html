<!doctype html><html lang=zh-hans><head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<title>APISIX æºç åˆ†æ - Mayo's Blog</title>
<meta name=description content="æœ¬æ–‡åŸºäº APISIX 2.6 ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æï¼Œæºç é˜…è¯»æ³¨é‡Šä»“åº“: reviewï¼Œåˆ†æä¸»è¦æµç¨‹ä»¥åŠæ ¸å¿ƒæœºåˆ¶ã€‚ åœ¨æºç é˜…è¯»è¿‡ç¨‹ä¸­å­¦ä¹ äº†æ¶‰åŠ OpenResty çš„éƒ¨åˆ†å†…å®¹ï¼ŒåŒ…å« lua-">
<meta name=author content>
<link rel=preconnect href=https://cdn.jsdelivr.net>
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css?family=Crimson+Text:400,700|Press+Start+2P" rel=stylesheet>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400&family=Noto+Sans+JP:wght@300;400&family=Noto+Sans+SC:wght@300;400&family=Noto+Serif:wght@300;400&family=Noto+Serif+JP:wght@300;400&family=Noto+Serif+SC:wght@300;400&family=Source+Code+Pro:wght@300;400" rel=stylesheet>
<link rel=stylesheet href="/bundle.css?v=1633973644" media=all>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/tocbot/dist/tocbot.css>
<link rel=icon href=https://unavatar.io/twitter/Freeze_Mayo><meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://shoujo.ink/2021/09/apisix-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-JKVXF5HSKT','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<meta property="og:title" content="APISIX æºç åˆ†æ">
<meta property="og:description" content="æœ¬æ–‡åŸºäº APISIX 2.6 ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æï¼Œæºç é˜…è¯»æ³¨é‡Šä»“åº“: reviewï¼Œåˆ†æä¸»è¦æµç¨‹ä»¥åŠæ ¸å¿ƒæœºåˆ¶ã€‚ åœ¨æºç é˜…è¯»è¿‡ç¨‹ä¸­å­¦ä¹ äº†æ¶‰åŠ OpenResty çš„éƒ¨åˆ†å†…å®¹ï¼ŒåŒ…å« lua-">
<meta property="og:type" content="article">
<meta property="og:url" content="https://shoujo.ink/2021/09/apisix-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-09-27T00:00:00+00:00">
<meta property="article:modified_time" content="2021-09-27T00:00:00+00:00"><meta property="og:site_name" content="Mayo's Blog">
</head>
</html>
<body><script src=https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js></script>
<script>const opts={bottom:'32px',right:'unset',left:'32px',time:'0.3s',mixColor:'#fff',backgroundColor:'#fff',buttonColorDark:'#100f2c',buttonColorLight:'#fff',saveInCookies:!0,label:'ğŸŒ“',autoMatchOsTheme:!0};let darkmode;window.matchMedia('only screen and (min-width: 680px)').matches?(darkmode=new Darkmode(opts),darkmode.showWidget()):(localStorage.removeItem('darkmode'),darkmode=new Darkmode(opts)),window.darkmode=darkmode,document.addEventListener('DOMContentLoaded',function(){document.body.style.opacity=1})</script>
<main class=page-content aria-label=Content>
<div class=wrapper><nav class=site-nav>
<a class=page-link href=/posts/>Posts</a>
<a class=page-link href=/about/>About</a>
</nav><header class=post-header>
<a class=site-title href=https://shoujo.ink>Mayo's Blog</a>
<h1 class="post-title baseline-fix typeface-sans" lang=zh-hans itemprop="name headline">APISIX æºç åˆ†æ</h1>
</header>
<div class=post-cover aria-label=Cover>
<div class=post-cover-wrapper>
<img src alt>
</div>
<div class=cover-meta></div>
</div>
<div class=post-layout>
<article class="post typeface-sans" lang=zh-hans itemscope itemtype=http://schema.org/BlogPosting>
<div class=post-content itemprop=articleBody>
<p>æœ¬æ–‡åŸºäº <a href=https://github.com/apache/apisix>APISIX</a> 2.6 ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æï¼Œæºç é˜…è¯»æ³¨é‡Šä»“åº“: <a href=https://github.com/mayocream/apisix/tree/review>review</a>ï¼Œåˆ†æä¸»è¦æµç¨‹ä»¥åŠæ ¸å¿ƒæœºåˆ¶ã€‚</p>
<p>åœ¨æºç é˜…è¯»è¿‡ç¨‹ä¸­å­¦ä¹ äº†æ¶‰åŠ OpenResty çš„éƒ¨åˆ†å†…å®¹ï¼ŒåŒ…å« lua-resty-coreï¼ˆOpenResty æ ¸å¿ƒï¼‰ï¼Œä»¥åŠ OpenResty ä½œè€…å¼€æºçš„ <code>lua-resty-*</code> åŒ…ï¼ŒåŒæ—¶äº†è§£äº† OpenResty çš„æµ‹è¯•æ¡†æ¶ Test::Nginxã€‚åœ¨æºç é˜…è¯»è¿‡ç¨‹ä¸­ç»™ APISIX æäº† 2 ä¸ª PRï¼ˆCode Style ä»¥åŠ Build Scriptï¼‰ï¼ŒçŸ¥é“äº†åŸºæœ¬çš„ LuaJIT FFI ç”¨æ³•ï¼Œè¯¥éƒ¨åˆ†è¿˜åœ¨å­¦ä¹ ä¸­ã€‚</p>
<p>åŒæ—¶åŸºäºæºç é˜…è¯»ï¼Œå¯¹å…¬å¸ç½‘å…³é€‰å‹è¿›è¡Œäº†åˆ†æã€‚</p>
<h2 id=1-apisix-æ¦‚è¿°>1. APISIX æ¦‚è¿°</h2>
<h3 id=11-é¡¹ç›®æ¦‚è¿°>1.1. é¡¹ç›®æ¦‚è¿°</h3>
<p>æ—¢ç„¶ APISIX æ˜¯åŸºäº OpenResty å¼€å‘çš„ API ç½‘å…³ï¼ŒAPISIX ä¸ OpenResty çš„è¯·æ±‚ç”Ÿå‘½å‘¨æœŸä¸€è‡´ï¼ŒAPISIX åˆ©ç”¨ Lua Nginx Module æä¾›çš„ <code>*_by_lua</code> æ·»åŠ  Hookã€‚</p>
<p>
<figure class=image>
<img src=/2021/09/apisix-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/images/gateway-traffic.png alt="API Gateway traffic" loading=lazy>
<figcaption>API Gateway traffic</figcaption>
</figure></p>
<p>å®ƒæŠ½è±¡äº†ä¸ Kong ç½‘å…³åŒæ ·çš„æ•°æ®æ¨¡å‹ï¼Œå…·æœ‰åŒæ ·çš„ Routeã€Serviceã€Upstreamã€Pluginã€Consumer ç­‰èµ„æºã€‚</p>
<div style=display:flex>
<figure style=max-width:50%>
<img src=images/114740649-a9bf2200-9d67-11eb-8e1d-1409fb5c18c2.png>
<figcaption style=text-align:center>APISIX</figcaption>
</figure>
<figure style=max-width:50%>
<img src=images/Kong-GS-overview.png>
<figcaption style=text-align:center>Kong</figcaption>
</figure>
</div>
åŸºæœ¬ä¸Šå¯ä»¥çœ‹ä½œ APISIX æ˜¯ Kong ç½‘å…³çš„é‡æ„â€”â€”è¿ç”¨å¤§é‡ LuaJITã€OpenResty æŠ€å·§ä¼˜åŒ–æ€§èƒ½ã€ç®€åŒ–å¤æ‚çš„æ•°æ®ç»“æ„ã€æ›¿æ¢å‚¨å­˜å¼•æ“ä¸º etcdã€‚
<pre><code class=language-mermaid>graph LR
	A(Routes)
	B(Services) --&gt; |Many| A
	C(Upstreams)
	A --&gt; |One| C
	B --&gt; |One| C
	D(Plugin)
	A --&gt; |Many| D
	B --&gt; |Many| D
	E(Consumers) --&gt; |Many| D
	
</code></pre>
<p>æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯æˆ‘ç¿»åˆ° APISIX çš„ä¸€ä¸ª issue ä¸­ï¼Œé¡¹ç›®å¼€å‘è€…è¯´ä¸ç¡®å®šæ˜¯ä»€ä¹ˆåŸå› ï¼Œæˆ‘ä»¬çœ‹çœ‹åŒè¡Œæ€ä¹ˆåšçš„å§ã€‚</p>
<blockquote>
<p>&ldquo;How does Kong solve similar problems?"<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p>
</blockquote>
<h3 id=12-ç”Ÿæ€æ¦‚è¿°>1.2. ç”Ÿæ€æ¦‚è¿°</h3>
<p>Kong ç½‘å…³å¼€æºç”Ÿæ€æœ‰çš„ï¼ŒAPISIX åŸºæœ¬éƒ½æœ‰æˆ–è€…æ­£åœ¨åšã€‚åŒ…å«ï¼šK8s Ingress Controllerã€Meshã€Dashboardã€‚</p>
<p>æ’ä»¶æ–¹é¢æ¯” Kong å¼€æºç‰ˆæœ¬å¤šäº† Skywalkingã€Traffit æ‹†åˆ†ã€Mirror æµé‡åŠŸèƒ½ã€‚</p>
<h2 id=2-apisix-æºç åˆ†æ>2. APISIX æºç åˆ†æ</h2>
<h3 id=21-åŸºæœ¬æµç¨‹>2.1. åŸºæœ¬æµç¨‹</h3>
<h4 id=211-ç›®å½•ç»“æ„>2.1.1. ç›®å½•ç»“æ„</h4>
<pre><code class=language-bash>$ tree -L 2
.
â”œâ”€â”€ apisix
â”‚   â”œâ”€â”€ admin # Admin API
â”‚   â”œâ”€â”€ api_router.lua
â”‚   â”œâ”€â”€ balancer # è´Ÿè½½å‡è¡¡å™¨
â”‚   â”œâ”€â”€ balancer.lua
â”‚   â”œâ”€â”€ cli # CLI, Lua è„šæœ¬
â”‚   â”œâ”€â”€ constants.lua # å¸¸é‡
â”‚   â”œâ”€â”€ consumer.lua
â”‚   â”œâ”€â”€ control
â”‚   â”œâ”€â”€ core # ä¸»è¦æ˜¯å°è£…çš„å…¬å…±æ–¹æ³•
â”‚   â”œâ”€â”€ core.lua
â”‚   â”œâ”€â”€ debug.lua
â”‚   â”œâ”€â”€ discovery # æœåŠ¡å‘ç°, æ”¯æŒ consul, eruka, dns
â”‚   â”œâ”€â”€ http
â”‚   â”œâ”€â”€ init.lua # _by_lua å‡½æ•°å…¥å£
â”‚   â”œâ”€â”€ patch.lua
â”‚   â”œâ”€â”€ plugin_config.lua
â”‚   â”œâ”€â”€ plugin.lua # æ’ä»¶
â”‚   â”œâ”€â”€ plugins
â”‚   â”œâ”€â”€ router.lua # Router
â”‚   â”œâ”€â”€ schema_def.lua # jsonschema å®šä¹‰
â”‚   â”œâ”€â”€ script.lua
â”‚   â”œâ”€â”€ ssl
â”‚   â”œâ”€â”€ ssl.lua
â”‚   â”œâ”€â”€ stream
â”‚   â”œâ”€â”€ timers.lua # timer å°è£…
â”‚   â”œâ”€â”€ upstream.lua
â”‚   â””â”€â”€ utils
â”œâ”€â”€ bin
â”‚   â””â”€â”€ apisix # apisix CLI, shell è„šæœ¬
â”œâ”€â”€ ci # CI è„šæœ¬
â”œâ”€â”€ conf # é»˜è®¤é…ç½®æ–‡ä»¶
â”œâ”€â”€ deps
â”œâ”€â”€ docs
â”œâ”€â”€ Makefile # å¿«æ·æŒ‡ä»¤
â”œâ”€â”€ rockspec # luarocks åŒ…ç®¡ç†
â”œâ”€â”€ t # Test::Nginx æµ‹è¯•
â””â”€â”€ utils # Shell è„šæœ¬
</code></pre>
<h4 id=212-å¯åŠ¨æµç¨‹>2.1.2. å¯åŠ¨æµç¨‹</h4>
<pre><code class=language-mermaid>graph LR
	1[CLI æ‰§è¡Œ] --&gt; 2[&quot;è¿è¡Œ LUA è„šæœ¬ (LuaJIT)&quot;]
	3[ç”Ÿæˆ Nginx é…ç½®] --&gt; 4[åˆå§‹åŒ– etcd]
	2 --&gt; 3
	4 --&gt; 5[å¯åŠ¨ OpenResty]
</code></pre>
<p>CLI é»˜è®¤ä¼šç”¨ LuaJIT å¯åŠ¨ï¼Œè‹¥ç‰ˆæœ¬ä¸å¤Ÿä¾¿é€€å›åˆ° Lua 5.1 è§£é‡Šå™¨æ‰§è¡Œã€‚</p>
<pre><code class=language-bash># æŸ¥æ‰¾ APISIX LUA åŒ…è·¯å¾„
# shell -s åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸” size &gt; 0
# ref: https://stackoverflow.com/questions/53319817/what-is-the-meaning-of-n-z-x-l-d-etc-in-shell-script
if [ -s './apisix/cli/apisix.lua' ]; then
	...
fi

# shell -e åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [[ -e $OR_EXEC &amp;&amp; &quot;$OR_VER&quot; =~ &quot;1.19&quot; ]]; then
    # use the luajit of openresty
    echo &quot;$LUAJIT_BIN $APISIX_LUA $*&quot;
    exec $LUAJIT_BIN $APISIX_LUA $*
elif [[ &quot;$LUA_VERSION&quot; =~ &quot;Lua 5.1&quot; ]]; then
    # OpenResty version is not 1.19, use Lua 5.1 by default
    # shell &amp;* ä¼ é€’æ‰€æœ‰ args
    # ref: https://stackoverflow.com/questions/4824590/propagate-all-arguments-in-a-bash-shell-script
    echo &quot;lua $APISIX_LUA $*&quot;
    exec lua $APISIX_LUA $*
fi
</code></pre>
<p>å¯åŠ¨è¿‡ç¨‹ä¸­ï¼š</p>
<ul>
<li>è°ƒç”¨ <code>popen</code> æ‰§è¡Œ CMD å‘½ä»¤ï¼›</li>
<li>ä½¿ç”¨ <a href=https://github.com/diegonehab/luasocket>luasocket</a> åº“å‘èµ· HTTP è¯·æ±‚ï¼ˆé OpenResty è¿è¡Œæ—¶ï¼‰ï¼›</li>
<li>ä½¿ç”¨ ltn12 <a href=http://lua-users.org/wiki/FiltersSourcesAndSinks>sink</a> è¿›è¡Œæµå¤„ç†ï¼›</li>
<li>åˆ›å»º etcd prefixï¼Œvalue ä¸º <code>init</code>ï¼›</li>
</ul>
<h3 id=22-apisix-core>2.2. APISIX Core</h3>
<p>APISIX çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯é¡¹ç›®å¼€å‘è€…è¯´ â€œæç®€æ ¸â¼¼ä»£ç é‡ï¼Œä¸åˆ° 4000 â¾ï¼Œå»é™¤ç©ºè¡Œã€æ³¨é‡Šè¡Œæ•°ç”šè‡³ä¸åˆ° 3000 è¡Œâ€ çš„éƒ¨åˆ†ã€‚</p>
<p>ä¸»è¦å°è£…äº†ä¸€äº›åº“å’Œå‡½æ•°ã€‚</p>
<h4 id=221-åŸºæœ¬ç±»å‹æ“ä½œ>2.2.1. åŸºæœ¬ç±»å‹æ“ä½œ</h4>
<p>åŸºæœ¬ä¸Šä¸ºäº†è¿½æ±‚æè‡´æ€§èƒ½ï¼Œèƒ½ç”¨ FFI è°ƒç”¨å®ç°çš„éƒ½ç”¨äº†ã€‚</p>
<h5 id=2211-å­—ç¬¦ä¸²>2.2.1.1. å­—ç¬¦ä¸²</h5>
<p>ä½¿ç”¨ FFI è°ƒç”¨ libc å‡½æ•° <code>memcmp</code> è¿›è¡Œå­—ç¬¦ä¸²æ¯”è¾ƒå†…å­˜åœ°å€çš„å‰ n é•¿åº¦æ˜¯å¦ç›¸åŒã€‚</p>
<pre><code class=language-lua>local ffi         = require(&quot;ffi&quot;)
local C           = ffi.C

-- ref: https://www.cplusplus.com/reference/cstring/memcmp/
-- ref: https://www.tutorialspoint.com/c_standard_library/c_function_memcmp.htm
ffi.cdef[[
    int memcmp(const void *s1, const void *s2, size_t n);
]]
</code></pre>
<p>æ¥æ”¶ç±»å‹æ˜¯ <code>const void *</code>ï¼Œä¸å¯å˜ç±»å‹å¯ä»¥ç›´æ¥ä¼ å…¥ Lua string ç±»å‹ã€‚</p>
<blockquote>
<p>å¦‚æœä½ çš„ C å‡½æ•°æ¥å— <code>const char *</code> æˆ–è€…ç­‰ä»·çš„ <code>const unsigned char/int8_t/... *</code> è¿™æ ·çš„å‚æ•°ç±»å‹ï¼Œ
å¯ä»¥ç›´æ¥ä¼ é€’ Lua string è¿›å»ï¼Œè€Œæ— éœ€å¦å¤–å‡†å¤‡ä¸€ä¸ª <code>ffi.new</code> ç”³è¯·çš„æ•°ç»„ã€‚<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></p>
</blockquote>
<p>string å‰ç¼€æ¯”è¾ƒï¼Œæ¯”è¾ƒ s, prefix å†…å­˜åœ°å€çš„å‰ n (#prefix) é•¿åº¦æ˜¯å¦ç›¸åŒã€‚</p>
<pre><code class=language-lua>-- ç”¨ ffi æ‰©å±• string æ–¹æ³•
function _M.has_prefix(s, prefix)
    if type(s) ~= &quot;string&quot; or type(prefix) ~= &quot;string&quot; then
        error(&quot;unexpected type: s:&quot; .. type(s) .. &quot;, prefix:&quot; .. type(prefix))
    end
    if #s &lt; #prefix then
        return false
    end
    -- æ¯”è¾ƒ s, prefix å†…å­˜åœ°å€çš„å‰ n (#prefix) é•¿åº¦æ˜¯å¦ç›¸åŒ
    local rc = C.memcmp(s, prefix, #prefix)
    return rc == 0
end
</code></pre>
<p>åŒç†æ¯”è¾ƒåç¼€ï¼š</p>
<pre><code class=language-lua>C.memcmp(ffi_cast(&quot;char *&quot;, s) + #s - #suffix, suffix, #suffix)
</code></pre>
<h5 id=2212-table>2.2.1.2. Table</h5>
<p>Table æ˜¯ Lua ä¸­æœ€å¸¸ç”¨çš„ç±»å‹äº†ï¼Œä¸å…¶ä»–è¯­è¨€æ¯”è¾ƒçš„è¯ç›¸å½“äº PHP çš„ Array ä¸€æ ·å®ç”¨ã€‚</p>
<p>Lua Table éœ€è¦æ³¨æ„çš„åœ°æ–¹å…¶ä¸€ï¼š</p>
<blockquote>
<p>table.new(narray, nhash)</p>
<p>è¿™ä¸ªå‡½æ•°ï¼Œä¼šé¢„å…ˆåˆ†é…å¥½æŒ‡å®šçš„æ•°ç»„å’Œå“ˆå¸Œçš„ç©ºé—´å¤§å°ï¼Œè€Œä¸æ˜¯åœ¨æ’å…¥å…ƒç´ æ—¶è‡ªå¢é•¿ï¼Œè¿™ä¹Ÿæ˜¯å®ƒçš„ä¸¤ä¸ªå‚æ•° narray å’Œ nhash çš„å«ä¹‰ã€‚
å¦‚æœä¸ä½¿ç”¨è¿™ä¸ªå‡½æ•°ï¼Œè‡ªå¢é•¿æ˜¯ä¸€ä¸ªä»£ä»·æ¯”è¾ƒé«˜çš„æ“ä½œï¼Œä¼šæ¶‰åŠåˆ°ç©ºé—´åˆ†é…ã€resize å’Œ rehash ç­‰ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡é¿å…ã€‚</p>
<p>table.new çš„æ–‡æ¡£å¹¶æ²¡æœ‰å‡ºç°åœ¨ LuaJIT çš„å®˜ç½‘ï¼Œè€Œæ˜¯æ·±è—åœ¨ GitHub é¡¹ç›®çš„ <a href=https://github.com/openresty/luajit2/blob/v2.1-agentzh/doc/extensions.html>æ‰©å±•æ–‡æ¡£</a> é‡Œï¼Œç”¨è°·æ­Œä¹Ÿå¾ˆéš¾æ‰¾åˆ°ï¼Œæ‰€ä»¥å¾ˆå¤šäººå¹¶ä¸çŸ¥é“è¿™ä¸ªå‡½æ•°çš„å­˜åœ¨ã€‚</p>
<p>è¶…å‡ºé¢„è®¾çš„ç©ºé—´å¤§å°ï¼Œä¹Ÿå¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œåªä¸è¿‡æ€§èƒ½ä¼šé€€åŒ–ï¼Œä¹Ÿå°±å¤±å»äº†ä½¿ç”¨ table.new çš„æ„ä¹‰ã€‚</p>
<p>éœ€è¦æ ¹æ®å®é™…åœºæ™¯ï¼Œæ¥é¢„è®¾å¥½ table.new ä¸­æ•°ç»„å’Œå“ˆå¸Œç©ºé—´çš„å¤§å°ï¼Œè¿™æ ·æ‰èƒ½åœ¨æ€§èƒ½å’Œå†…å­˜å ç”¨ä¸Šæ‰¾åˆ°ä¸€ä¸ªå¹³è¡¡ç‚¹ã€‚<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></p>
</blockquote>
<p>Lua Table éœ€è¦æ³¨æ„çš„åœ°æ–¹å…¶äºŒï¼š</p>
<blockquote>
<p>table.insert è™½ç„¶æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„æ“ä½œï¼Œä½†æ€§èƒ½å¹¶ä¸ä¹è§‚ã€‚
å¦‚æœä¸æ˜¯æ ¹æ®æŒ‡å®šä¸‹æ ‡æ¥æ’å…¥å…ƒç´ ï¼Œé‚£ä¹ˆæ¯æ¬¡éƒ½éœ€è¦è°ƒç”¨ LuaJIT çš„ lj_tab_len æ¥è·å–æ•°ç»„çš„é•¿åº¦ï¼Œä»¥ä¾¿æ’å…¥é˜Ÿå°¾ã€‚è·å– table é•¿åº¦çš„æ—¶é—´å¤æ‚åº¦ä¸º O(n) ã€‚</p>
</blockquote>
<p>å‚è€ƒ APISIX ä½œè€…ç»™ <a href=https://github.com/kubernetes/ingress-nginx>ingress-nginx</a> é¡¹ç›®æçš„ Table æ“ä½œä¼˜åŒ– PRï¼š<a href=https://github.com/kubernetes/ingress-nginx/pull/3673>used table functions of LuaJIT for better performance.</a></p>
<p>OpenResty Fork çš„ LuaJIT æ–°å¢çš„ table å‡½æ•°<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>ï¼š</p>
<ul>
<li>table.isempty</li>
<li>table.isarray</li>
<li>table.nkeys</li>
<li>table.clone</li>
</ul>
<p>å›åˆ° APISIX å°è£…çš„ Table æ“ä½œç¬¦ï¼š</p>
<pre><code class=language-lua>-- è‡ªè¡Œæ„å»º index æ’å…¥ table, æ¯” table.insert æ•ˆç‡é«˜
function _M.insert_tail(tab, ...)
    local idx = #tab
    -- éå†è¾“å…¥çš„å‚æ•°
    for i = 1, select('#', ...) do
        idx = idx + 1
        tab[idx] = select(i, ...)
    end

    return idx
end
</code></pre>
<p><code>select('#', ...)</code> è·å–è¾“å…¥å‚æ•°çš„æ•°é‡ï¼Œ<code>select(i, ...)</code> è·å–ç¬¬ n ä¸ªå‚æ•°ï¼ŒTable çš„éå†ä¸­å¤§é‡ä½¿ç”¨è¯¥ç»“æ„ã€‚</p>
<p><code>try_read_attr</code> å®ç°äº† <code>path.node.x</code> çš„ table è®¿é—®æ–¹å¼ï¼Œä¾¿äºè¯»å–å¤šå±‚çº§é…ç½®é¡¹ã€‚</p>
<pre><code class=language-lua>function _M.try_read_attr(tab, ...)
    for i = 1, select('#', ...) do
        local attr = select(i, ...)
        if type(tab) ~= &quot;table&quot; then
            return nil
        end

        tab = tab[attr]
    end

    return tab
end
</code></pre>
<p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<pre><code class=language-lua>    local size = core_tab.try_read_attr(local_conf, &quot;graphql&quot;, &quot;max_size&quot;)
    if size then
        max_size = size
    end
</code></pre>
<h4 id=222-å·¥å…·ç±»>2.2.2. å·¥å…·ç±»</h4>
<h5 id=2221-json-æ“ä½œ>2.2.2.1. JSON æ“ä½œ</h5>
<pre><code class=language-lua>local delay_tab = setmetatable({data = &quot;&quot;, force = false}, {
    __tostring = function(self)
        local res, err = encode(self.data, self.force)
        if not res then
            ngx.log(ngx.WARN, &quot;failed to encode: &quot;, err,
                    &quot; force: &quot;, self.force)
        end

        return res
    end
})


-- this is a non-thread safe implementation
-- it works well with log, eg: log.info(..., json.delay_encode({...}))
function _M.delay_encode(data, force)
    delay_tab.data = data
    delay_tab.force = force
    return delay_tab
end
</code></pre>
<p>è®¾ç½®äº†å…ƒè¡¨çš„ <code>__tostring</code> æ–¹æ³•ï¼Œåœ¨å­—ç¬¦ä¸²è½¬æ¢æ—¶æ‰ä½¿ç”¨åŒ¿åå‡½æ•°è°ƒç”¨ <code>json.encode</code>ï¼Œåœ¨æ—¥å¿—æ‰“å°æ—¶ï¼Œè¢«å¿½ç•¥çš„æ—¥å¿—ä¼šä¸æ‰§è¡Œ JSON å‹ç¼©ï¼Œé¿å…é¢å¤–çš„æ€§èƒ½æŸè€—ã€‚</p>
<h5 id=2222-lru-ç¼“å­˜>2.2.2.2. LRU ç¼“å­˜</h5>
<p><a href=https://github.com/openresty/lua-resty-lrucache>lua-resty-lrucache</a> åœ¨å†™å…¥æ—¶ä¼šæ¸…ç† TTL è¿‡æœŸçš„ç¼“å­˜ï¼Œè¯»æ—¶å¦‚æœæ•°æ®è¿‡æœŸäº†ï¼Œä¼šä½œä¸ºç¬¬äºŒä¸ªå‚æ•°è¿”å›ï¼š</p>
<pre><code class=language-lua>function _M.get(self, key)
    local hasht = self.hasht
    local val = hasht[key]
    if val == nil then
        return nil
    end

    local node = self.key2node[key]

    -- print(key, &quot;: moving node &quot;, tostring(node), &quot; to cache queue head&quot;)
    local cache_queue = self.cache_queue
    queue_remove(node)
    queue_insert_head(cache_queue, node)

    if node.expire &gt;= 0 and node.expire &lt; ngx_now() then
        -- print(&quot;expired: &quot;, node.expire, &quot; &gt; &quot;, ngx_now())
        return nil, val, node.user_flags
    end

    return val, nil, node.user_flags
end
</code></pre>
<pre><code class=language-mermaid>graph TD
	1[è·å– LRU ç¼“å­˜]
	11{ç¼“å­˜å¤±æ•ˆ?}
	1 --&gt; 11
	11 --&gt; 99
	2{å¼€å¯å¹¶å‘é”?}
	3{ä¸æ”¯æŒé”?}
	3 --&gt; |æ˜¯| 6
	11 --&gt; |æ˜¯| 2
	2 --&gt; |æ˜¯| 3
	2 --&gt; |å¦| 6
	3 --&gt; |å¦| 4
	4[å…±äº«å†…å­˜é”] --&gt; 5[å†æ¬¡è·å–ç¼“å­˜]
	5 --&gt; 7
	6[åˆ›å»ºç¼“å­˜]
	7{ç¼“å­˜æœ‰æ•ˆ?} --&gt; 99
	7 --&gt; |å¦| 6
	6 --&gt; 99
	99[è¿”å›ç¼“å­˜]
</code></pre>
<pre><code class=language-lua>local function fetch_valid_cache(lru_obj, invalid_stale, item_ttl,
                                 item_release, key, version)
    local obj, stale_obj = lru_obj:get(key)
    if obj and obj.ver == version then
        return obj
    end

    -- å¦‚æœ TTL åˆ°æœŸçš„æ•°æ®ç‰ˆæœ¬å·ä»ä¸€è‡´, é‡æ–° set è¯¥ç¼“å­˜
    if not invalid_stale and stale_obj and stale_obj.ver == version then
        lru_obj:set(key, stale_obj, item_ttl)
        return stale_obj
    end

    -- release å›è°ƒ
    if item_release and obj then
        item_release(obj.val)
    end

    return nil
end


-- è¿”å›åˆ›å»º LRU çš„åŒ¿åå‡½æ•°
local function new_lru_fun(opts)
    local item_count, item_ttl
    if opts and opts.type == 'plugin' then
        item_count = opts.count or PLUGIN_ITEMS_COUNT
        item_ttl = opts.ttl or PLUGIN_TTL
    else
        item_count = opts and opts.count or GLOBAL_ITEMS_COUNT
        item_ttl = opts and opts.ttl or GLOBAL_TTL
    end

    local item_release = opts and opts.release
    local invalid_stale = opts and opts.invalid_stale
    -- æ˜¯å¦ä½¿ç”¨å¹¶å‘é”
    local serial_creating = opts and opts.serial_creating
    -- å‚æ•°ä¸º LRU size
    local lru_obj = lru_new(item_count)

    return function (key, version, create_obj_fun, ...)
        -- ä¸æ”¯æŒçš„ yielding çš„ Nginx phase æ— æ³•ä½¿ç”¨ resty.lock
        if not serial_creating or not can_yield_phases[get_phase()] then
            local cache_obj = fetch_valid_cache(lru_obj, invalid_stale,
                                item_ttl, item_release, key, version)
            if cache_obj then
                return cache_obj.val
            end

            local obj, err = create_obj_fun(...)
            if obj ~= nil then
                lru_obj:set(key, {val = obj, ver = version}, item_ttl)
            end

            return obj, err
        end

        local cache_obj = fetch_valid_cache(lru_obj, invalid_stale, item_ttl,
                            item_release, key, version)
        if cache_obj then
            return cache_obj.val
        end

        -- å½“ç¼“å­˜å¤±æ•ˆæ—¶è·å–é”
        -- åˆ›å»ºå…±äº«å†…å­˜ lock
        local lock, err = resty_lock:new(lock_shdict_name)
        if not lock then
            return nil, &quot;failed to create lock: &quot; .. err
        end

        local key_s = tostring(key)
        log.info(&quot;try to lock with key &quot;, key_s)

        -- è·å– lock
        local elapsed, err = lock:lock(key_s)
        if not elapsed then
            return nil, &quot;failed to acquire the lock: &quot; .. err
        end

        -- å†æ¬¡è·å–ç¼“å­˜
        cache_obj = fetch_valid_cache(lru_obj, invalid_stale, item_ttl,
                        nil, key, version)
        if cache_obj then
            lock:unlock()
            log.info(&quot;unlock with key &quot;, key_s)
            return cache_obj.val
        end

        local obj, err = create_obj_fun(...)
        if obj ~= nil then
            lru_obj:set(key, {val = obj, ver = version}, item_ttl)
        end
        lock:unlock()
        log.info(&quot;unlock with key &quot;, key_s)

        return obj, err
    end
end
</code></pre>
<p>è¿™æ®µä»£ç å…³è”åˆ°ä¸¤ä¸ª PR:</p>
<ol>
<li><a href=https://github.com/apache/apisix/pull/1486>bugfix(lrucache): when creating cached objects, use resty-lock to avoid repeated creation.</a></li>
<li><a href=https://github.com/apache/apisix/pull/2575>change: make lrucache lock optional</a></li>
</ol>
<p>ä½¿ç”¨ <a href=https://github.com/openresty/lua-resty-lock>lua-resty-lock</a> é€šè¿‡å…±äº«å†…å­˜ç«äº‰é”ï¼Œç”¨åœ¨ç¼“å­˜ä¸­é¿å…ç¼“å­˜å‡»ç©¿ï¼Œå½“è¯¥ Lib å‡ºäº Luajit é™åˆ¶ï¼Œæ— æ³•åœ¨ <code>init_by_lua</code>, <code>init_worker_by_lua</code>, <code>header_filter_by_lua</code>, <code>body_filter_by_lua</code>, <code>balancer_by_lua</code>, <code>log_by_lua </code> é˜¶æ®µä¸­ä½¿ç”¨ã€‚</p>
<p>å¼•å…¥çš„ <code>serial_creating</code> å±æ€§ç”¨äºåˆ¤æ–­æ’ä»¶æ˜¯å¦éœ€è¦å¯ç”¨é”ã€‚</p>
<blockquote>
<p>Kong ä½¿ç”¨çš„ <a href=https://github.com/thibaultcha/lua-resty-mlcache>lua-resty-mlcache</a> åº“å†…éƒ¨ä¹Ÿä½¿ç”¨ resty.lock é˜²æ­¢ç¼“å­˜å‡»ç©¿ï¼ˆå¯é€‰ï¼‰ã€‚</p>
</blockquote>
<h5 id=2223-åå°ä»»åŠ¡>2.2.2.3. åå°ä»»åŠ¡</h5>
<p>ä¸¤ä¸ªåœ°æ–¹é»˜è®¤åˆå§‹åŒ–äº†å®šæ—¶å™¨ï¼ˆNginx Timerï¼‰æ‰§è¡Œåå°ä»»åŠ¡ã€‚</p>
<ol>
<li><code>init_by_lua</code> é˜¶æ®µåˆ›å»º OpenResty ç‰¹æƒè¿›ç¨‹ï¼Œè´Ÿè´£æ‰§è¡Œç‰¹å®šçš„åå°ä»»åŠ¡ï¼Œä¸ä¼šå¹²æ‰°å…¶ä»– Worker è¿›ç¨‹ï¼Œæƒé™ç›¸å½“äº rootï¼›</li>
<li><code>init_by_worker</code> é˜¶æ®µåˆ›å»º Background Timerï¼Œæ‰§è¡Œå¹¶å‘æ‰§è¡Œåå°ä»»åŠ¡ã€‚</li>
</ol>
<p>OpenResty ç‰¹æƒè¿›ç¨‹ä¸èƒ½å¤„ç†è¯·æ±‚ï¼Œåªèƒ½ç”± Timer è§¦å‘ï¼Œé€»è¾‘ä¸Šç¼–å†™ <code>if type(ngx.process.type()) == "privileged agent"</code> åªåœ¨ç‰¹æƒè¿›ç¨‹ä¸­æ‰§è¡Œæ“ä½œã€‚<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup></p>
<blockquote>
<p>Enables the privileged agent process in Nginx.</p>
<p>The privileged agent process does not listen on any virtual server ports like those worker processes. And it uses the same system account as the nginx master process, which is usually a privileged account like <code>root</code>.</p>
<p>The <code>init_worker_by_lua*</code> directive handler still runs in the privileged agent process. And one can use the <a href=https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/process.md#type>type</a> function provided by this module to check if the current process is a privileged agent.<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup></p>
</blockquote>
<pre><code class=language-lua>-- worker é»˜è®¤åå°è¿è¡Œçš„ timer, æ‰§è¡Œå„ç§åå°ä»»åŠ¡ 
local function background_timer()
    if core.table.nkeys(timers) == 0 then
        return
    end

    local threads = {}
    for name, timer in pairs(timers) do
        core.log.info(&quot;run timer[&quot;, name, &quot;]&quot;)

        -- å¼€å¯åç¨‹æ‰§è¡Œ
        local th, err = thread_spawn(timer)
        if not th then
            core.log.error(&quot;failed to spawn thread for timer [&quot;, name, &quot;]: &quot;, err)
            goto continue
        end

        core.table.insert(threads, th)

::continue::
    end

    local ok, err = thread_wait(unpack(threads))
    if not ok then
        core.log.error(&quot;failed to wait threads: &quot;, err)
    end
end

function _M.init_worker()
    local opts = {
        each_ttl = 0,
        sleep_succ = 0,
        check_interval = check_interval, -- é»˜è®¤é—´éš”ä¸º 1 ç§’
    }
    local timer, err = core.timer.new(&quot;background&quot;, background_timer, opts)
    if not timer then
        core.log.error(&quot;failed to create background timer: &quot;, err)
        return
    end

    core.log.notice(&quot;succeed to create background timer&quot;)
end
</code></pre>
<p>APISIX å¼•å…¥ç‰¹æƒè¿›ç¨‹çš„ä¸€ä¸ªç›®çš„åœ¨äºå®ç° Log Rotate æ’ä»¶åŠŸèƒ½ã€‚</p>
<h4 id=223-è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ>2.2.3. è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ</h4>
<h5 id=2231-ctx>2.2.3.1. ctx</h5>
<blockquote>
<p>Use <code>ngx.ctx</code> wherever you can. <code>ngx.var</code> is much more expensive and is also limited to string values. The latter should only be used to exchange data with other nginx C modules.<sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup></p>
</blockquote>
<p>APISIX ä¸­ä½¿ç”¨ç¼“å­˜ <code>ngx.var</code> è·å–çš„ç»“æœï¼Œ åœ¨ä¸åŒç”Ÿå‘½å‘¨æœŸä¸­ä¼ é€’ã€‚ä½¿ç”¨ <a href=https://github.com/api7/lua-var-nginx-module>lua-var-nginx-module</a> Nginx C æ¨¡å—å’Œ FFI è·å–å˜é‡ï¼Œåœ¨æ²¡æœ‰å¼€å¯ Nginx C æ¨¡å—çš„æƒ…å†µä¸‹å›é€€åˆ° <code>ngx.var</code> æ–¹å¼è·å–ã€‚APISIX é»˜è®¤æ²¡æœ‰åœ¨æ„å»ºè„šæœ¬ä¸­åŠ è½½ C æ¨¡å—ï¼Œæäº¤çš„ PR <a href=https://github.com/api7/apisix-build-tools/pull/44>feat: add lua-var-nginx-module</a> åœ¨ç¼–è¯‘ OpenResty æ—¶æ·»åŠ äº†è¯¥æ¨¡å—ã€‚</p>
<pre><code class=language-lua>function _M.set_vars_meta(ctx)
    -- ä» table æ± ä¸­è·å–/åˆ›å»ºä¸€ä¸ª hash é•¿åº¦ä¸º 32 çš„ table
    local var = tablepool.fetch(&quot;ctx_var&quot;, 0, 32)
    if not var._cache then
        var._cache = {}
    end

    -- é€šè¿‡ resty.core.base è·å–åŸå§‹ request C æŒ‡é’ˆ (?)
    -- ref: https://github.com/openresty/lua-resty-core/blob/master/lib/resty/core/base.lua
    var._request = get_request()
    -- ç»‘å®šå…ƒè¡¨
    setmetatable(var, mt)
    -- ç¼“å­˜åˆ° ngx ctx ä¸­
    ctx.var = var
end
</code></pre>
<p>ä½¿ç”¨ <a href=https://github.com/openresty/lua-tablepool>tablepool</a> ä» Lua table æ± ä¸­è·å– tableï¼Œé¿å…é¢‘ç¹åˆ†é…å†…å­˜ã€‚</p>
<pre><code class=language-lua>do
    -- è·å–ç‰¹æ®Š var ç±»å‹çš„æ–¹æ³•
    local var_methods = {
        method = ngx.req.get_method,
        -- ref: https://github.com/cloudflare/lua-resty-cookie
        cookie = function () return ck:new() end
    }

    local ngx_var_names = {
        upstream_scheme            = true,
        upstream_host              = true,
        ...

        var_x_forwarded_proto = true,
    }

    local mt = {
        -- é‡è½½ hash å…ƒæ–¹æ³•
        -- t æ˜¯ self
        __index = function(t, key)

            -- è‹¥ cache table å­˜åœ¨ç›´æ¥è¿”å›
            local cached = t._cache[key]
            if cached ~= nil then
                return cached
            end

            if type(key) ~= &quot;string&quot; then
                error(&quot;invalid argument, expect string value&quot;, 2)
            end

            local val
            -- å¦‚æœæ˜¯ç‰¹æ®Šç±»å‹, ä½¿ç”¨ç‰¹å®šæ–¹æ³•è·å–
            local method = var_methods[key]
            if method then
                val = method()

            elseif core_str.has_prefix(key, &quot;cookie_&quot;) then
                -- é€šè¿‡ var_methods è®¿é—®åˆ° resty.cookie
                local cookie = t.cookie
                if cookie then
                    local err
                    val, err = cookie:get(sub_str(key, 8))
                    if not val then
                        log.warn(&quot;failed to fetch cookie value by key: &quot;,
                                 key, &quot; error: &quot;, err)
                    end
                end

            elseif core_str.has_prefix(key, &quot;http_&quot;) then
                key = key:lower()
                key = re_gsub(key, &quot;-&quot;, &quot;_&quot;, &quot;jo&quot;)
                -- æœ€ç»ˆé€šè¿‡ ngx.var è·å–
                val = get_var(key, t._request)

            elseif core_str.has_prefix(key, &quot;graphql_&quot;) then
                -- trim the &quot;graphql_&quot; prefix
                key = sub_str(key, 9)
                val = get_parsed_graphql(t)[key]

            elseif key == &quot;route_id&quot; then
                val = ngx.ctx.api_ctx and ngx.ctx.api_ctx.route_id

            elseif key == &quot;service_id&quot; then
                val = ngx.ctx.api_ctx and ngx.ctx.api_ctx.service_id

            elseif key == &quot;consumer_name&quot; then
                val = ngx.ctx.api_ctx and ngx.ctx.api_ctx.consumer_name

            elseif key == &quot;route_name&quot; then
                val = ngx.ctx.api_ctx and ngx.ctx.api_ctx.route_name

            elseif key == &quot;service_name&quot; then
                val = ngx.ctx.api_ctx and ngx.ctx.api_ctx.service_name

            elseif key == &quot;balancer_ip&quot; then
                val = ngx.ctx.api_ctx and ngx.ctx.api_ctx.balancer_ip

            elseif key == &quot;balancer_port&quot; then
                val = ngx.ctx.api_ctx and ngx.ctx.api_ctx.balancer_port

            else
                val = get_var(key, t._request)
            end

            if val ~= nil then
                t._cache[key] = val
            end

            -- ä¸ºç©ºè¿”å› nil
            return val
        end,

        __newindex = function(t, key, val)
            if ngx_var_names[key] then
                ngx_var[key] = val
            end

            -- log.info(&quot;key: &quot;, key, &quot; new val: &quot;, val)
            t._cache[key] = val
        end,
    }
</code></pre>
<p>éƒ¨åˆ† APISIX è·¯ç”±åŒ¹é…çš„å†…éƒ¨å‚æ•°åœ¨å…¶ä»–é˜¶æ®µæ³¨å…¥ã€‚</p>
<h5 id=2232-headers>2.2.3.2. headers</h5>
<pre><code class=language-lua>-- ç”¨ ngx.ctx table ç¼“å­˜ headers, é¿å…å†è¿›è¡Œä¸€æ¬¡ ffi è°ƒç”¨
local function _headers(ctx)
    if not ctx then
        ctx = ngx.ctx.api_ctx
    end
    local headers = ctx.headers
    if not headers then
        headers = get_headers()
        ctx.headers = headers
    end

    return headers
end
</code></pre>
<p>ç”¨åˆ°äº†ä¸Šè¿°çš„ ctx åº“ã€‚</p>
<h4 id=224-etcd>2.2.4. etcd</h4>
<p>etcd åœ¨ APISIX ä¸­ä½œç”¨ç›¸åŒä¸ PostgreSQL ä¹‹äº Kongï¼Œå†…éƒ¨ä½¿ç”¨ <a href=https://github.com/api7/lua-resty-etcd>lua-resty-etcd</a> ä½œä¸ºå®¢æˆ·ç«¯ï¼Œä½¿ç”¨ timer å®šæ—¶æ‰§è¡Œå’Œé•¿è½®è¯¢è·å–è·Ÿè¸ª etcd ä¸­æ•°æ®çš„å˜åŒ–ã€‚</p>
<p>è¿™é‡Œçš„ä¼˜åŒ–ç‚¹ä¸ Kong ä¸€æ ·ï¼Œåœ¨ <code>init_by_lua</code> é˜¶æ®µè¿›è¡Œæ•°æ®çš„ warm upï¼Œä¹‹åæ•°æ®ä¼š fork åˆ°å…¶ä»–çš„è¿›ç¨‹ä¸­ã€‚</p>
<blockquote>
<p>It does not really make much sense to use this library in the context of <a href=https://github.com/openresty/lua-nginx-module#lua_shared_dict>init_by_lua</a> because the cache will not get shared by any of the worker processes (unless you just want to &ldquo;warm up&rdquo; the cache with predefined items which will get inherited by the workers via <code>fork()</code>).<sup id=fnref:8><a href=#fn:8 class=footnote-ref role=doc-noteref>8</a></sup></p>
</blockquote>
<h5 id=2241-åˆå§‹åŒ–>2.2.4.1. åˆå§‹åŒ–</h5>
<p>è¯»å– etcd æ•°æ®åˆ°å…¨å±€å•ä¾‹çš„ Lua tableã€‚</p>
<pre><code class=language-lua>-- åˆå§‹åŒ– etcd
function _M.init()
    local local_conf, err = config_local.local_conf()
    if not local_conf then
        return nil, err
    end

    if table.try_read_attr(local_conf, &quot;apisix&quot;, &quot;disable_sync_configuration_during_start&quot;) then
        return true
    end

    -- è·å– etcd cli
    local etcd_cli, err = get_etcd()
    if not etcd_cli then
        return nil, &quot;failed to start a etcd instance: &quot; .. err
    end

    local etcd_conf = local_conf.etcd
    local prefix = etcd_conf.prefix
    -- åŠ è½½ etcd æ‰€æœ‰æ•°æ®åˆ° lua table ä¸­, å•ä¾‹æ¨¡å¼
    local res, err = readdir(etcd_cli, prefix, create_formatter(prefix))
    if not res then
        return nil, err
    end

    return true
end
</code></pre>
<p>å¯¹æ•°æ®è¿›è¡Œæ ¼å¼åŒ–ï¼Œå­˜å…¥ Lua table ä¸­ï¼š</p>
<pre><code class=language-lua>-- åˆ›å»ºæ ¼å¼åŒ– formatter
local function create_formatter(prefix)
    -- è¿”å›é—­åŒ…å‡½æ•°, å¯¹ etcd è¿”å›çš„ç»“æœè¿›è¡Œæ ¼å¼åŒ–
    -- æ ¼å¼ä¸ªæ¯›, è¿™å°±æ˜¯ä¸ª hook å‡½æ•°
    return function (res)
        res.body.nodes = {}

        local dirs
        if is_http then
            dirs = constants.HTTP_ETCD_DIRECTORY
        else
            dirs = constants.STREAM_ETCD_DIRECTORY
        end

        local curr_dir_data
        local curr_key
        for _, item in ipairs(res.body.kvs) do
            if curr_dir_data then
                -- å°†åŒ¹é…çš„å†…å®¹æ’å…¥ table
                if core_str.has_prefix(item.key, curr_key) then
                    table.insert(curr_dir_data, etcd_apisix.kvs_to_node(item))
                    goto CONTINUE
                end

                curr_dir_data = nil
            end

            -- æˆªå– prefix åçš„ key
            local key = sub_str(item.key, #prefix + 1)
            if dirs[key] then
                -- single item
                loaded_configuration[key] = {
                    body = etcd_apisix.kvs_to_node(item),
                    headers = res.headers,
                }
            else
                -- å‰ç¼€ä¸€è‡´
                local key = sub_str(item.key, #prefix + 1, #item.key - 1) -- å»æ‰æœ«å°¾çš„ /
                -- ensure the same key hasn't been handled as single item
                if dirs[key] and not loaded_configuration[key] then
                    loaded_configuration[key] = {
                        body = {
                            nodes = {},
                        },
                        headers = res.headers,
                    }
                    curr_dir_data = loaded_configuration[key].body.nodes
                    curr_key = item.key
                end
            end

            ::CONTINUE::
        end

        return res
    end
end
</code></pre>
<p>è¿™éƒ¨åˆ†é€»è¾‘åœ¨ <code>init_by_lua</code> æ‰§è¡Œï¼Œfork åˆ°å…¶ä»–å­è¿›ç¨‹ã€‚</p>
<h5 id=2242-æ•°æ®æ ¡éªŒ>2.2.4.2. æ•°æ®æ ¡éªŒ</h5>
<p><code>schema_def.lua</code> æ–‡ä»¶ä¸­å®šä¹‰äº†æ‰€æœ‰å‚¨å­˜æ•°æ®ç»“æ„çš„ schema æ ¡éªŒè§„åˆ™ï¼Œä½¿ç”¨ <a href=https://github.com/api7/jsonschema>jsonschema</a> åº“è¿›è¡Œæ•°æ®æ ¡éªŒã€‚</p>
<p><code>core/schema.lua</code> ä¸­ä½¿ç”¨ LRU ç¼“å­˜æ ¡éªŒå™¨ã€‚</p>
<p><code>load_full_data</code> å‡½æ•°åŠ è½½æ•°æ®ç»“æ„æ‰€éœ€çš„ etcd kvsï¼Œå¹¶è¿›è¡Œæ•°æ®è½¬æ¢ã€æ ¡éªŒã€æ ¼å¼åŒ–ã€æ‰§è¡Œå›è°ƒã€‚</p>
<pre><code class=language-mermaid>graph TD
	1[åˆ›å»º table ç¼“å­˜æ–°æ•°æ®] --&gt; 2[jsonschema æ ¡éªŒæ•°æ®æ ¼å¼]
	2 --&gt; 3[è‡ªå®šä¹‰ check å‡½æ•°æ£€æŸ¥æ•°æ®æ ¼å¼]
	3 --&gt; 4[è‡ªå®šä¹‰ filter å‡½æ•°è¿‡æ»¤æ•°æ®]
	4 --&gt; 5[etcd æ›´æ–° mvcc ç‰ˆæœ¬]
</code></pre>
<pre><code class=language-lua>local function load_full_data(self, dir_res, headers)
    local err
    local changed = false

    if self.single_item then
        -- table size ä¸º 1
        ...
        -- æ‰§è¡Œé€»è¾‘ä¸ä¸‹é¢æ•°ç»„æ ¼å¼ç±»ä¼¼
    else
        if not dir_res.nodes then
            dir_res.nodes = {}
        end

        self.values = new_tab(#dir_res.nodes, 0)
        self.values_hash = new_tab(0, #dir_res.nodes)

        for _, item in ipairs(dir_res.nodes) do
            local key = short_key(self, item.key)
            local data_valid = true
            
            -- æ•°æ®æ ¼å¼æ ¡éªŒ...

            -- schema æ ¡éªŒ...

            -- è¿‡æ»¤å™¨...

            if data_valid then
                changed = true
                insert_tab(self.values, item)
                self.values_hash[key] = #self.values

                item.value.id = key
                item.clean_handlers = {}

                -- æ‰§è¡Œå›è°ƒ
                if self.filter then
                    self.filter(item)
                end
            end
			-- æ›´æ–° mvcc ç‰ˆæœ¬
            self:upgrade_version(item.modifiedIndex)
        end
    end
	...
    self.need_reload = false
end
</code></pre>
<h5 id=2243-åå°æ•°æ®åŒæ­¥>2.2.4.3. åå°æ•°æ®åŒæ­¥</h5>
<p>åˆ©ç”¨ etcd watch æœºåˆ¶è¿›è¡Œæ•°æ®å˜æ›´çš„åŒæ­¥ã€‚</p>
<pre><code class=language-mermaid>graph TD
	A[è§¦å‘å®šæ—¶å™¨] --&gt; C[åŒæ­¥æ•°æ®]
	subgraph åŒæ­¥æ•°æ®
		C{ }
		C --&gt; |å…¨é‡åŠ è½½?| D[å…¨é‡æ•°æ®è·å–]
		C --&gt; |watch?| E[Watch å˜åŒ–]
		F[æ ¼å¼åŒ–] --&gt; G[æ•°æ®æ ¡éªŒ] --&gt; H[æ‰§è¡Œå›è°ƒ]
		D --&gt; F
		E --&gt; F
	end
	
</code></pre>
<pre><code class=language-lua>-- å®šæ—¶å™¨è‡ªåŠ¨åŒæ­¥ etcd æ•°æ®
local function _automatic_fetch(premature, self)
    if premature then
        return
    end

    local i = 0
    while not exiting() and self.running and i &lt;= 32 do
        i = i + 1

        local ok, err = xpcall(function()
            if not self.etcd_cli then
                local etcd_cli, err = get_etcd()
                if not etcd_cli then
                    error(&quot;failed to create etcd instance for key [&quot;
                          .. self.key .. &quot;]: &quot; .. (err or &quot;unknown&quot;))
                end
                self.etcd_cli = etcd_cli
            end

            -- åŒæ­¥æ•°æ®
            local ok, err = sync_data(self)
            if err then
                if err ~= &quot;timeout&quot; and err ~= &quot;Key not found&quot;
                    and self.last_err ~= err then
                    log.error(&quot;failed to fetch data from etcd: &quot;, err, &quot;, &quot;,
                              tostring(self))
                end

                if err ~= self.last_err then
                    self.last_err = err
                    self.last_err_time = ngx_time()
                else
                    if ngx_time() - self.last_err_time &gt;= 30 then
                        self.last_err = nil
                    end
                end

                ngx_sleep(self.resync_delay + rand() * 0.5 * self.resync_delay)
            elseif not ok then
                -- no error. reentry the sync with different state
                ngx_sleep(0.05)
            end

        end, debug.traceback)

        if not ok then
            log.error(&quot;failed to fetch data from etcd: &quot;, err, &quot;, &quot;,
                      tostring(self))
            ngx_sleep(self.resync_delay + rand() * 0.5 * self.resync_delay)
            break
        end
    end

    -- è¿›è¡Œä¸‹ä¸€æ¬¡å¾ªç¯
    if not exiting() and self.running then
        ngx_timer_at(0, _automatic_fetch, self)
    end
end
</code></pre>
<h5 id=2244-é…ç½®åŒæ­¥>2.2.4.4. é…ç½®åŒæ­¥</h5>
<p>å°è£…ä¸Šè¿°çš„é€»è¾‘æä¾›ç»™ <code>routes</code>ã€<code>plugins</code>ã€<code>services</code> ç­‰æ•°æ®ç»“æ„ä½¿ç”¨ï¼Œæ¯ä¸ªæ•°æ®ç»“æ„ç›‘å¬è‡ªå·±çš„ prefixï¼ŒåŒæ­¥æ•°æ®å¹¶æ‰§è¡Œå›è°ƒï¼Œé€šå¸¸åœ¨å›è°ƒé€»è¾‘ä¸Šè§¦å‘æ›´æ–°ï¼Œä¾‹å¦‚é‡æ–°æ„å»º Routerã€é‡æ–°æ„å»º plugins table ç­‰ã€‚</p>
<pre><code class=language-lua>-- etcd é…ç½®åˆ›å»º
function _M.new(key, opts)
    local local_conf, err = config_local.local_conf()
    if not local_conf then
        return nil, err
    end

    -- etcd é‡æ–°åŒæ­¥äº‹ä»¶ 5 ç§’, ä¸ Kong é‡æ–° poll db æ•°æ®ä¸€è‡´
    local etcd_conf = local_conf.etcd
    local prefix = etcd_conf.prefix
    local resync_delay = etcd_conf.resync_delay
    if not resync_delay or resync_delay &lt; 0 then
        resync_delay = 5
    end

    local automatic = opts and opts.automatic
    local item_schema = opts and opts.item_schema
    local filter_fun = opts and opts.filter
    local timeout = opts and opts.timeout
    local single_item = opts and opts.single_item
    local checker = opts and opts.checker

    local obj = setmetatable({
        etcd_cli = nil,
        key = key and prefix .. key,
        automatic = automatic,
        item_schema = item_schema,
        checker = checker,
        sync_times = 0,
        running = true,
        conf_version = 0,
        values = nil,
        need_reload = true,
        routes_hash = nil,
        prev_index = 0,
        last_err = nil,
        last_err_time = nil,
        resync_delay = resync_delay,
        timeout = timeout,
        single_item = single_item,
        filter = filter_fun,
    }, mt)

    if automatic then
        -- timer å®šæ—¶è·å–æ•°æ®
        if not key then
            return nil, &quot;missing `key` argument&quot;
        end

        -- ä»å•ä¾‹ table è·å– etcd æ•°æ®, è¿›è¡Œå¤„ç†
        if loaded_configuration[key] then
            local res = loaded_configuration[key]
            -- æ¸…ç©º table
            loaded_configuration[key] = nil -- tried to load

            log.notice(&quot;use loaded configuration &quot;, key)

            local dir_res, headers = res.body, res.headers
            -- åŠ è½½æ•°æ®å¹¶æ ¡éªŒæ•°æ®, è¿‡æ»¤æ•°æ®
            load_full_data(obj, dir_res, headers)
        end

        -- åˆ›å»ºå®šæ—¶å™¨è‡ªåŠ¨åŒæ­¥
        ngx_timer_at(0, _automatic_fetch, obj)

    else
        local etcd_cli, err = get_etcd()
        if not etcd_cli then
            return nil, &quot;failed to start a etcd instance: &quot; .. err
        end
        obj.etcd_cli = etcd_cli
    end

    if key then
        created_obj[key] = obj
    end

    return obj
end
</code></pre>
<h3 id=23-apisix-proxy>2.3. APISIX Proxy</h3>
<p>æºç ä¸­ Core éƒ¨åˆ†å°è£…äº†æ•°æ®è·å–çš„å‡½æ•°ï¼Œåœ¨ API ç½‘å…³ä¸»æµç¨‹ä¸­é€šè¿‡ Nginx ç”Ÿå‘½å‘¨æœŸä¸²èµ·æ¥ã€‚</p>
<h4 id=231-router>2.3.1. Router</h4>
<p>APISIX çš„ Router åŒ¹é…åŸºäºå‹ç¼©å­—å…¸æ ‘ï¼ˆRadix Treeï¼‰å®ç°ï¼Œä¸»è¦ä½¿ç”¨ <a href=https://github.com/api7/lua-resty-radixtree>lua-resty-radixtree</a> åº“ã€‚å†…ç½®å¤šç§è§£ææ¨¡å¼ï¼Œè¿™é‡Œåªå…³æ³¨ HTTP é»˜è®¤çš„ <code>radixtree_uri</code> å®ç°ã€‚</p>
<h5 id=2311-è·¯ç”±æ„å»º>2.3.1.1. è·¯ç”±æ„å»º</h5>
<p><code>core.config.new</code> è°ƒç”¨çš„æ˜¯ etcd åº“ï¼ˆ<code>config_etcd.lua</code>ï¼‰ç»´æŠ¤çš„é…ç½®åŒæ­¥æ–¹æ³•ï¼Œè¿”å›åŸè¡¨ï¼Œå¯ä»¥è®¿é—®ä» etcd åŒæ­¥çš„æ•°æ®ã€‚<code>core.schema.route</code> åŒ…å«äº† route è¿™ä¸ªæ•°æ®ç»“æ„çš„ schema åŠæ ¡éªŒè§„åˆ™ï¼Œ<code>check_route</code> å†…éƒ¨æ£€æŸ¥ route ç›´æ¥ç»‘å®š plugin çš„æ•°æ®ç»“æ„ã€‚</p>
<blockquote>
<p>APISIX å¼•å…¥ route ç›´æ¥ç»‘å®š plugin çš„ç®€åŒ–é…ç½®ï¼Œä¸éœ€è¦é¢å¤–åˆ›å»º plugin å¯¹è±¡ã€‚</p>
</blockquote>
<pre><code class=language-lua>-- åˆå§‹åŒ– router
function _M.init_worker(filter)
    local user_routes, err = core.config.new(&quot;/routes&quot;, {
            automatic = true, -- è‡ªåŠ¨åŒæ­¥
            item_schema = core.schema.route,
            checker = check_route,
            filter = filter,
        })
    if not user_routes then
        error(&quot;failed to create etcd instance for fetching /routes : &quot; .. err)
    end

    return user_routes
end
</code></pre>
<p><code>filter</code> æ˜¯å›è°ƒå‡½æ•°ï¼Œä¸‹è¿°çš„æµç¨‹ä¸­ä¼šæ³¨å…¥ã€‚</p>
<h5 id=2312-è·¯ç”±åˆå§‹åŒ–>2.3.1.2. è·¯ç”±åˆå§‹åŒ–</h5>
<p><code>router.http_init_worker</code> ä¸­è¿›è¡Œ Router åˆå§‹åŒ–ã€‚</p>
<pre><code class=language-mermaid>graph TD
	1[&quot;1. åŠ è½½ä¸åŒæ¨¡å¼çš„ router (uri/sni), å¼•å…¥ä¸åŒçš„ lua åº“&quot;]
	2[2. åˆ›å»º router å®ä¾‹]
	3[3. æ·»åŠ åˆå§‹åŒ–å›è°ƒ]
	4[&quot;4. etcd è·å–æ•°æ®å¹¶æ‰§è¡Œå›è°ƒ (åå°è‡ªåŠ¨æ›´æ–°)&quot;]
	5[5. filter callback æ ¼å¼åŒ–, è§£æ upstream]
	6[&quot;6. ä¿®æ”¹ router user_routes æ•°æ® (router match ä½¿ç”¨)&quot;]
	1 --&gt; 2 --&gt; 3 --&gt; 4 --&gt; 5 --&gt;6
</code></pre>
<pre><code class=language-lua>-- attach common methods if the router doesn't provide its custom implementation
local function attach_http_router_common_methods(http_router)
    ...

    if http_router.init_worker == nil then
        http_router.init_worker = function (filter)
            -- æ·»åŠ è·¯ç”±
            http_router.user_routes = http_route.init_worker(filter)
        end
    end
end


function _M.http_init_worker()
    local conf = core.config.local_conf()
    -- é»˜è®¤çš„åŒ¹é…æ¨¡å¼
    local router_http_name = &quot;radixtree_uri&quot;
    local router_ssl_name = &quot;radixtree_sni&quot;

    if conf and conf.apisix and conf.apisix.router then
        router_http_name = conf.apisix.router.http or router_http_name
        router_ssl_name = conf.apisix.router.ssl or router_ssl_name
    end

    -- åˆ›å»º router å®ä¾‹
    local router_http = require(&quot;apisix.http.router.&quot; .. router_http_name)
    -- ä¿®æ”¹ router çš„ table
    attach_http_router_common_methods(router_http)
    -- åˆå§‹åŒ–è·¯ç”±
    -- è°ƒç”¨ apisix.http.route.init_worker æ–¹æ³•
    -- ä» etcd è·å–æ•°æ®å¹¶æ‰§è¡Œå›è°ƒ
    -- filter ä¸ºæ ¼å¼åŒ–, è§£æ upstream
    router_http.init_worker(filter)
    _M.router_http = router_http

    local router_ssl = require(&quot;apisix.ssl.router.&quot; .. router_ssl_name)
    router_ssl.init_worker()
    _M.router_ssl = router_ssl

    _M.api = require(&quot;apisix.api_router&quot;)

    ...
end
</code></pre>
<p><code>http_router.user_routes</code> å‚¨å­˜åœ¨ router çš„ table ä¸­ï¼Œä¼šåœ¨è·¯ç”±åŒ¹é…æ—¶ç”¨åˆ°ï¼ˆæ‡’åŠ è½½ï¼‰ã€‚</p>
<h5 id=2313-è·¯ç”±åŒ¹é…>2.3.1.3. è·¯ç”±åŒ¹é…</h5>
<p><code>access_by_lua</code> é˜¶æ®µä¸­è¿›è¡Œè·¯ç”±åŒ¹é…ï¼Œå°†åŒ¹é…ç»“æœï¼ˆrouteã€serviceï¼‰ä¼ é€’åˆ° ctx ä¸­ä¾› balancer è¯·æ±‚ä¸Šæ¸¸ã€‚</p>
<pre><code class=language-lua>do
    local uri_routes = {}
    local uri_router
    local match_opts = {}
    
    function _M.match(api_ctx)
        -- ä» module çš„ user_routes å±æ€§è·å–è·¯ç”±, åœ¨ etcd route å˜åŒ–æ—¶å›è°ƒæ·»åŠ 
        local user_routes = _M.user_routes
        if not cached_version or cached_version ~= user_routes.conf_version then
            uri_router = base_router.create_radixtree_uri_router(user_routes.values,
                                                                uri_routes, false)
            cached_version = user_routes.conf_version
        end

        if not uri_router then
            core.log.error(&quot;failed to fetch valid `uri` router: &quot;)
            return true
        end

        return base_router.match_uri(uri_router, match_opts, api_ctx)
    end

end
</code></pre>
<p><code>radixtree</code> è·¯ç”±åŒ¹é…åº“æä¾›äº†åŒ¹é…æˆåŠŸå›è°ƒ handlerï¼ŒåŒ¹é…æˆåŠŸåä¼ é€’åˆ° ctx ä¸­ã€‚</p>
<pre><code class=language-lua>core.table.insert(uri_routes, {
                ...
                handler = function (api_ctx, match_opts)
                    api_ctx.matched_params = nil
                    api_ctx.matched_route = route
                    api_ctx.curr_req_matched = match_opts.matched
                end
            })
</code></pre>
<h4 id=232-balancer>2.3.2. Balancer</h4>
<p>Balancer éƒ¨åˆ†ä¸ Kong é€»è¾‘ä¸€è‡´ï¼Œç”šè‡³ä»£ç é‡Œå‡½æ•°åéƒ½ä¸€æ ·ï¼Œä¸»è¦é€»è¾‘æ˜¯ Service/Upstream èŠ‚ç‚¹è§£æã€è´Ÿè½½å‡è¡¡ç­–ç•¥ã€å¥åº·æ£€æŸ¥ä¸å¤±è´¥é‡è¯•ã€‚</p>
<p>APISIX æ”¯æŒçš„ä¸€ç‰¹æ€§æ˜¯å¤–éƒ¨æœåŠ¡å‘ç°ï¼ŒKong ä¸­é»˜è®¤æ”¯æŒé€šè¿‡ DNS è§£æ Service hostï¼Œæ ¹æ® AAAAã€Aã€SRV è®°å½•æ·»åŠ  IP ä¸ä¼˜å…ˆçº§ï¼ŒAPISIX æ”¯æŒäº†ä» consulã€eruka å’Œå…¶ä»–æ³¨å†Œä¸­å¿ƒè·å– IP åœ°å€åˆ—è¡¨ï¼Œå¹¶åŒæ­¥èŠ‚ç‚¹æ•°æ®ï¼ˆé•¿è½®è¯¢ï¼‰ã€‚</p>
<h5 id=2321-æœåŠ¡å‘ç°>2.3.2.1. æœåŠ¡å‘ç°</h5>
<p>å¦‚æœ serivce host æ˜¯åŸŸå, é€šè¿‡å¤–éƒ¨æ³¨å†Œä¸­å¿ƒè¿›è¡ŒæœåŠ¡å‘ç°ï¼Œè·å–ä¸Šæ¸¸ IP åˆ—è¡¨ã€‚</p>
<pre><code class=language-lua>function _M.set_by_route(route, api_ctx)
   	...
    -- å¦‚æœ serivce host æ˜¯åŸŸå, é€šè¿‡ discovery å‘ç°, dns è§£æ
    if up_conf.service_name then
        ...
        -- å¤–éƒ¨æ³¨å†Œä¸­å¿ƒ
        local dis = discovery[up_conf.discovery_type]
        if not dis then
            return 500, &quot;discovery &quot; .. up_conf.discovery_type .. &quot; is uninitialized&quot;
        end

        -- ä»æ³¨å†Œä¸­å¿ƒæ•°æ®æºï¼ˆç¼“å­˜æœ¬åœ° tableï¼‰è·å– IP
        local new_nodes, err = dis.nodes(up_conf.service_name)
        if not new_nodes then
            return HTTP_CODE_UPSTREAM_UNAVAILABLE, &quot;no valid upstream node: &quot; .. (err or &quot;nil&quot;)
        end

        ...
    end

    -- å°† upstream èŠ‚ç‚¹ä¿¡æ¯å­˜å…¥ ctx
    set_directly(api_ctx, up_conf.type .. &quot;#upstream_&quot; .. tostring(up_conf),
                 api_ctx.conf_version, up_conf)

    local nodes_count = up_conf.nodes and #up_conf.nodes or 0
    if nodes_count == 0 then
        return HTTP_CODE_UPSTREAM_UNAVAILABLE, &quot;no valid upstream node&quot;
    end
	...

    set_upstream_scheme(api_ctx, up_conf)

    local ok, err = fill_node_info(up_conf, api_ctx.upstream_scheme, false)
    if not ok then
        return 503, err
    end
    ...

    local scheme = up_conf.scheme
    if (scheme == &quot;https&quot; or scheme == &quot;grpcs&quot;) and up_conf.tls then
        ...
    end

    return
end
</code></pre>
<h5 id=2322-è´Ÿè½½å‡è¡¡>2.3.2.2. è´Ÿè½½å‡è¡¡</h5>
<p>ä¸åŒäº Kong ä½¿ç”¨è‡ªå·±å°è£…çš„ <a href=https://github.com/Kong/lua-resty-dns-client/tree/master/src/resty/dns/balancer>lua-resty-dns-client/balancer</a> ä½œä¸ºè´Ÿè½½å‡è¡¡å™¨ï¼ŒAPISIX åŸºäº <a href=https://github.com/openresty/lua-resty-balancer>lua-resty-balancer</a> å°è£…äº†è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼ŒåŸºäº <a href=https://github.com/Kong/lua-resty-healthcheck>lua-resty-healthcheck</a>ï¼ˆfork ç‰ˆæœ¬ï¼‰å®ç°èŠ‚ç‚¹å¥åº·æ£€æŸ¥ã€‚</p>
<p>API ç½‘å…³çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼ˆKong/APISIXï¼‰éƒ½æ˜¯åŸºäº OpenResty <a href=https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/balancer.md#set_current_peer>lua-resty-core/balancer</a> æä¾›çš„è´Ÿè½½å‡è¡¡å‡½æ•°å®ç°ï¼Œ<code>set_current_peer</code> è®¾ç½®å½“å‰è¯·æ±‚ä¸Šæ¸¸åœ°å€ï¼Œ<code>set_more_tries</code> è®¾ç½®è¯·æ±‚å¤±è´¥é‡è¯•æ¬¡æ•°ï¼Œ<code>get_last_failure</code> è·å–ä¸Šä¸€æ¬¡è¯·æ±‚å¤±è´¥ç»“æœåˆ¤æ–­æ˜¯å¦éœ€è¦ç»§ç»­é‡è¯•ï¼Œ<code>set_timeouts</code> è®¾ç½®å•ä¸ªè¯·æ±‚è¶…æ—¶æ—¶é—´ã€‚</p>
<pre><code class=language-mermaid>graph TD
	subgraph access_by_lua
		a1[æœåŠ¡å‘ç°]
        a2[peer å‚¨å­˜åˆ° ctx]
        a1 --&gt; a2
	end
	subgraph balancer_by_lua
		b1{ }
		b2[é‡æ–°è·å– peer]
		b3[ä» ctx è·å– peer]
		b9[è¯·æ±‚ä¸Šæ¸¸]
		b1 -.-&gt; |å¤±è´¥é‡è¯•| b2
		b1 --&gt; b3
		b3 --&gt; b9
	end
	subgraph balancer
		c1(è´Ÿè½½å‡è¡¡)
		c2[ä¸ŠæŠ¥ä¸Šæ¬¡å¤±è´¥ç»“æœ]
		c1 -.-&gt; c2
		c3[è´Ÿè½½å‡è¡¡å™¨è·å– peer]
		c1 ---&gt; c3
	end
	a1 ---&gt; c1
	b2 -.-&gt; c1
</code></pre>
<p><code>set_balancer_opts</code> è®¾ç½® Nginx Balancer å‚æ•°ã€‚</p>
<pre><code class=language-lua>-- set_balancer_opts will be called in balancer phase and before any tries
local function set_balancer_opts(route, ctx)
    local up_conf = ctx.upstream_conf

    -- If the matched route has timeout config, prefer to use the route config.
    local timeout = nil
    if route and route.value and route.value.timeout then
        timeout = route.value.timeout
    else
        if up_conf.timeout then
            timeout = up_conf.timeout
        end
    end
    -- è®¾ç½® Nginx è¯·æ±‚è¶…æ—¶æ—¶é—´
    if timeout then
        local ok, err = set_timeouts(timeout.connect, timeout.send,
                                     timeout.read)
        if not ok then
            core.log.error(&quot;could not set upstream timeouts: &quot;, err)
        end
    end

    local retries = up_conf.retries
    if not retries or retries &lt; 0 then
        retries = #up_conf.nodes - 1
    end

    -- è®¾ç½® Nginx å¤±è´¥é‡è¯•æ¬¡æ•°
    if retries &gt; 0 then
        local ok, err = set_more_tries(retries)
        ...
    end
end
</code></pre>
<p>åœ¨ <code>access_by_lua</code> é˜¶æ®µä¸­æœåŠ¡å‘ç°ï¼Œè°ƒç”¨ balancer åº“è·å– peer èŠ‚ç‚¹ï¼Œ<code>balancer_by_lua</code> ä¸­ä» ctx ä¸­è·å– peer èŠ‚ç‚¹ä¿¡æ¯ï¼Œè®¿é—®åç«¯èŠ‚ç‚¹ï¼Œè‹¥å¤±è´¥é‡è¯•ï¼ˆè¯¥é˜¶æ®µå†æ¬¡è¢«è°ƒç”¨ï¼‰ï¼Œé‡æ–°è·å– peer èŠ‚ç‚¹ï¼Œé‡æ–°åˆ›å»ºè¯·æ±‚ï¼ˆ<code>recreate_request()</code>ï¼‰å†æ¬¡è®¿é—®åç«¯èŠ‚ç‚¹ã€‚</p>
<h4 id=233-plugin>2.3.3. Plugin</h4>
<p>æ’ä»¶æœºåˆ¶ä¹Ÿä¸ Kong ç±»ä¼¼ï¼Œæ’ä»¶å¼€å‘è€…å¯ä»¥å®šä¹‰ Schema é…ç½®æ•°æ®ç»“æ„ï¼Œä»¥åŠ Handler æ³¨å…¥ Nginx è¯·æ±‚ç”Ÿå‘½å‘¨æœŸï¼ŒAPI ç½‘å…³æä¾›æ ¸å¿ƒçš„åº“ä¾›å¼€å‘è€…ä½¿ç”¨ï¼ˆSDKï¼‰ã€‚</p>
<p>APISIX ç›¸æ¯” Kongï¼Œå¼€æºçš„æ’ä»¶è¾ƒå¤šï¼Œæ’ä»¶ Schema ä¾¿äºç¼–å†™ï¼ŒåŒæ—¶æ’ä»¶åªéœ€è¦å•æ–‡ä»¶ï¼Œè€Œ Kong çš„æ’ä»¶é€šå¸¸æ˜¯å•ç‹¬ä¸€ä¸ªä»“åº“ï¼Œä¸æ–¹ä¾¿ç»´æŠ¤ã€‚ä½†æ˜¯è€ƒè™‘åˆ°æ’ä»¶éœ€è¦å•ç‹¬çš„ Test::Nginx å•å…ƒæµ‹è¯•ï¼Œå•ç‹¬ä¸€ä¸ªä»“åº“ä¹Ÿæœªå°ä¸å¯ï¼ˆKong è¿˜è¯´äº†ä»¥åä¼šæŠŠ Github é¡¹ç›®ä¸»ä»“åº“çš„æ’ä»¶ä»£ç ç§»åˆ°å•ç‹¬çš„ä»“åº“ï¼‰ã€‚</p>
<p>å…·ä½“å„ä¸ªé˜¶æ®µæ‰§è¡Œé€»è¾‘åº”è¯¥ä¸ Kong ç›¸åŒï¼Œå³éƒ¨åˆ†é˜¶æ®µæ’ä»¶å¼€åç¨‹å¹¶å‘æ‰§è¡Œï¼Œéƒ¨åˆ†é˜¶æ®µé¿å…æ•°æ®ç«äº‰ï¼Œæ’ä»¶é¡ºåºæ‰§è¡Œã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„ä¸€ç‚¹æ˜¯ APISIX ç”Ÿå‘½å‘¨æœŸé‡Œæ²¡æœ‰ <code>rewrite_by_lua</code> é˜¶æ®µï¼Œæ’ä»¶å®ç°çš„è¯¥é˜¶æ®µä¼šåœ¨ <code>access_by_lua</code> ä¸­ä¼˜å…ˆäº <code>access_by_lua</code> æ’ä»¶é€»è¾‘æ‰§è¡Œã€‚</p>
<blockquote>
<p>The apisix run both &ldquo;.access&rdquo; and &ldquo;.rewrite&rdquo; in the &ldquo;access&rdquo; phase.<sup id=fnref:9><a href=#fn:9 class=footnote-ref role=doc-noteref>9</a></sup></p>
</blockquote>
<h5 id=2331-æ’ä»¶åŠ è½½>2.3.3.1. æ’ä»¶åŠ è½½</h5>
<p>æ’ä»¶åˆ—è¡¨ä»æœ¬åœ° yaml æ–‡ä»¶è·å–ï¼ŒåŒæ—¶ç›‘å¬æœ¬åœ°æ–‡ä»¶å˜åŒ–ï¼ŒåŒæ­¥é…ç½®ï¼›æ’ä»¶é…ç½®ä¿¡æ¯ä» etcd è·å–ã€‚</p>
<pre><code class=language-lua>local init_plugins_syncer
do
    local plugins_conf

    function init_plugins_syncer()
        local err
        -- å‚¨å­˜æ’ä»¶çš„é…ç½®ä¿¡æ¯, ä¸€æ¡ kv
        plugins_conf, err = core.config.new(&quot;/plugins&quot;, {
            automatic = true, -- åå°åˆ›å»º timer watch etcd è‡ªåŠ¨åŒæ­¥é…ç½®
            item_schema = core.schema.plugins,
            single_item = true,
            -- filter æ–¹æ³•ä¸­è®¿é—®åˆ° etcd kv çš„ item, è¿™é‡Œè¿›è¡Œæ’ä»¶åŠ è½½çš„å›è°ƒ
            -- æ¯æ¬¡ etcd æ’ä»¶é…ç½®å˜åŠ¨, è‡ªåŠ¨åŒæ­¥
            filter = function(item)
                -- we need to pass 'item' instead of plugins_conf because
                -- the latter one is nil at the first run
                _M.load(item)
            end,
        })
        if not plugins_conf then
            error(&quot;failed to create etcd instance for fetching /plugins : &quot; .. err)
        end
    end
end
</code></pre>
<p>æ’ä»¶åˆ—è¡¨ä¼šå‚¨å­˜åˆ° Lua table ä¸­ï¼š</p>
<pre><code class=language-lua>-- åŠ è½½æ’ä»¶
local function load(plugin_names)
    local processed = {}
    for _, name in ipairs(plugin_names) do
        if processed[name] == nil then
            processed[name] = true
        end
    end

    core.log.warn(&quot;new plugins: &quot;, core.json.delay_encode(processed))

    -- ç§»é™¤å·²ç»å­˜åœ¨çš„ module
    for name in pairs(local_plugins_hash) do
        unload_plugin(name)
    end

    core.table.clear(local_plugins)
    core.table.clear(local_plugins_hash)

    -- åŠ è½½æ’ä»¶
    for name in pairs(processed) do
        load_plugin(name, local_plugins)
    end

    -- æ’ä»¶æ’åº, priority è¶Šé«˜çš„æ’ä»¶è¶Šå…ˆæ‰§è¡Œ, ä¸ Kong åŒæ ·
    -- sort by plugin's priority
    if #local_plugins &gt; 1 then
        sort_tab(local_plugins, sort_plugin)
    end

    -- æ‰“å°è°ƒè¯•æ—¥å¿—
    for i, plugin in ipairs(local_plugins) do
        ...
    end

    return true
end
</code></pre>
<p>æ’ä»¶é…ç½®ä¿¡æ¯ <code>plugin_meta</code> ä¹ŸåŠ è½½åˆ° Lua table ä¸­ï¼Œåœ¨æ’ä»¶åŒ¹é…çš„æ—¶å€™ä¼šè·å–ã€‚</p>
<h5 id=2332-æ’ä»¶åŒ¹é…>2.3.3.2. æ’ä»¶åŒ¹é…</h5>
<p>æ’ä»¶è¿‡æ»¤ï¼Œéå†æ’ä»¶åˆ—è¡¨ï¼ŒåŒ¹é…å¼€å¯çš„æ’ä»¶ï¼ŒO(n) æ“ä½œ <code>plugin.filter(route)</code> ï¼š</p>
<pre><code class=language-lua>-- æ’ä»¶é…ç½®ç»‘å®š
function _M.filter(user_route, plugins)
    ...

    plugins = plugins or core.tablepool.fetch(&quot;plugins&quot;, 32, 0)
    for _, plugin_obj in ipairs(local_plugins) do
        local name = plugin_obj.name
        local plugin_conf = user_plugin_conf[name]

        -- æ’ä»¶å’Œæ’ä»¶é…ç½®å­˜å…¥
        if type(plugin_conf) == &quot;table&quot; and not plugin_conf.disable then
            core.table.insert(plugins, plugin_obj)
            core.table.insert(plugins, plugin_conf)
        end
    end

    trace_plugins_info_for_debug(plugins)

    return plugins
end
</code></pre>
<h5 id=2333-æ’ä»¶æ‰§è¡Œ>2.3.3.3. æ’ä»¶æ‰§è¡Œ</h5>
<p>è¿™é‡Œä»¥ <code>access_by_lua</code> é˜¶æ®µæ’ä»¶æ‰§è¡Œé€»è¾‘ä¸ºä¾‹ï¼Œæ ¹æ® Routeã€Service åŒ¹é…æ’ä»¶ï¼Œåˆ›å»ºä¸´æ—¶ Table å‚¨å­˜ plugin å’Œ plugin_confï¼Œå­˜å…¥ ctx ä¸­ã€‚</p>
<pre><code class=language-lua>        -- æ’ä»¶è¿‡æ»¤, éå†æ’ä»¶åˆ—è¡¨, åŒ¹é…å¼€å¯çš„æ’ä»¶, O(n)
        local plugins = plugin.filter(route)
        api_ctx.plugins = plugins

        -- fake æ‰§è¡Œ rewrite é˜¶æ®µ
        plugin.run_plugin(&quot;rewrite&quot;, plugins, api_ctx)
        if api_ctx.consumer then
            local changed
            route, changed = plugin.merge_consumer_route(
                route,
                api_ctx.consumer,
                api_ctx
            )

            core.log.info(&quot;find consumer &quot;, api_ctx.consumer.username,
                          &quot;, config changed: &quot;, changed)

            if changed then
                core.table.clear(api_ctx.plugins)
                api_ctx.plugins = plugin.filter(route, api_ctx.plugins)
            end
        end
        -- æ‰§è¡Œ access é˜¶æ®µ
        plugin.run_plugin(&quot;access&quot;, plugins, api_ctx)
</code></pre>
<h4 id=234-ä¸»æµç¨‹>2.3.4. ä¸»æµç¨‹</h4>
<p>ä»¥ Nginx HTTP Subsystem ä¸ºä¾‹åˆ†æä¸»è¦æ‰§è¡Œé€»è¾‘ï¼Œå…¶ä¸­ä¸€äº›æ ¸å¿ƒé€»è¾‘å·²åœ¨ä¸Šè¿°å°èŠ‚ä¸­æµç¨‹åˆ†æè¿‡ã€‚</p>
<h5 id=2341-init_by_lua>2.3.4.1. init_by_lua</h5>
<pre><code class=language-mermaid>graph TD
	1[&quot;1. åŠ è½½ resty.core&quot;]
	2[&quot;2. ngx.re JIT ç¼“å­˜å‚æ•°ä¼˜åŒ–&quot;]
	3[&quot;3. LuaJIT å‚æ•°ä¼˜åŒ–&quot;]
	4[&quot;4. dns client åˆå§‹åŒ–&quot;]
	5[&quot;5. ç”ŸæˆèŠ‚ç‚¹ id&quot;]
	6[&quot;6. å¼€å¯ openresty ç‰¹æƒè¿›ç¨‹&quot;]
	7[&quot;7. è¯»å–é…ç½®æ–‡ä»¶å¹¶æ ¡éªŒæœ‰æ•ˆæ€§ (æœ¬åœ°æ–‡ä»¶/etcd)&quot;]
	1 --&gt; 2 --&gt; 3 --&gt; 4
	4 --&gt; 5 --&gt; 6 --&gt; 7
</code></pre>
<pre><code class=language-lua>function _M.http_init(args)
    require(&quot;resty.core&quot;)

    if require(&quot;ffi&quot;).os == &quot;Linux&quot; then
        require(&quot;ngx.re&quot;).opt(&quot;jit_stack_size&quot;, 200 * 1024)
    end

    require(&quot;jit.opt&quot;).start(&quot;minstitch=2&quot;, &quot;maxtrace=4000&quot;,
                             &quot;maxrecord=8000&quot;, &quot;sizemcode=64&quot;,
                             &quot;maxmcode=4000&quot;, &quot;maxirconst=1000&quot;)

    core.resolver.init_resolver(args)
    -- ç”ŸæˆèŠ‚ç‚¹ ID
    core.id.init()

    -- å¯ç”¨ openresty çš„ç‰¹æƒè¿›ç¨‹
    local process = require(&quot;ngx.process&quot;)
    local ok, err = process.enable_privileged_agent()
    if not ok then
        core.log.error(&quot;failed to enable privileged_agent: &quot;, err)
    end

    -- ä» etcd / yaml æœ¬åœ°é…ç½®æ–‡ä»¶è·å–é…ç½®, etcd æœ‰ init å‡½æ•°
    if core.config.init then
        local ok, err = core.config.init()
        if not ok then
            core.log.error(&quot;failed to load the configuration: &quot;, err)
        end
    end
end
</code></pre>
<h5 id=2342-init_worker_by_lua>2.3.4.2. init_worker_by_lua</h5>
<pre><code class=language-mermaid>graph TD
	1[&quot;1. random seed åˆå§‹åŒ–&quot;]
	2[&quot;2. å¤–éƒ¨æœåŠ¡å‘ç° (é»˜è®¤æ²¡æœ‰å¼€å¯, consul, dubbo)&quot;]
	3[&quot;3. åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨ balancer (HTTP/Upstream) åˆ›å»º LRU ç¼“å­˜&quot;]
	4[&quot;4. åŠ è½½ Admin API&quot;]
	5[&quot;5. åˆ›å»ºåå° timer&quot;]
	6[&quot;6. åŠ è½½æ‰€æœ‰æ’ä»¶å¹¶æ‰§è¡Œæ’ä»¶ init æ–¹æ³•&quot;]
	7[&quot;7. ä» etcd è·å– routes/services/upstreams&quot;]
	1 --&gt; 2 --&gt; 3 --&gt; 4
	4 --&gt; 5 --&gt; 6 --&gt; 7
</code></pre>
<pre><code class=language-mermaid>graph TD
	subgraph &quot;7. ä» etcd è·å– routes/services/upstreams&quot;
        71[&quot;a. åˆ›å»º router (uri/sni)&quot;]
        72[&quot;b. æŒ‚è½½ filter å›è°ƒå‡½æ•°&quot;]
        73[&quot;c. æ•°æ®æ ¼å¼åŒ–&quot;]
        74[&quot;d. timer watch etcd äº‹ä»¶å˜åŒ–æ‰§è¡Œå›è°ƒ&quot;]
        71 --&gt; 72 --&gt; 73 --&gt; 74
	end
</code></pre>
<pre><code class=language-lua>function _M.http_init_worker()
    local seed, err = core.utils.get_seed_from_urandom()
    if not seed then
        core.log.warn('failed to get seed from urandom: ', err)
        seed = ngx_now() * 1000 + ngx.worker.pid()
    end
    math.randomseed(seed)
    -- for testing only
    core.log.info(&quot;random test in [1, 10000]: &quot;, math.random(1, 10000))

    -- è¿›ç¨‹é—´äº‹ä»¶é€šä¿¡
    local we = require(&quot;resty.worker.events&quot;)
    local ok, err = we.configure({shm = &quot;worker-events&quot;, interval = 0.1})
    if not ok then
        error(&quot;failed to init worker event: &quot; .. err)
    end
    -- æœåŠ¡å‘ç° lib
    local discovery = require(&quot;apisix.discovery.init&quot;).discovery
    -- é»˜è®¤æ²¡æœ‰å¼€å¯æœåŠ¡å‘ç°
    if discovery and discovery.init_worker then
        discovery.init_worker()
    end
    -- åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨, æ–¹æ³•ä¸ºç©º
    require(&quot;apisix.balancer&quot;).init_worker()
    -- è´Ÿè½½å‡è¡¡å™¨
    load_balancer = require(&quot;apisix.balancer&quot;)
    -- TODO admin æµç¨‹åˆ†æ
    require(&quot;apisix.admin.init&quot;).init_worker()
    -- æ³¨å†Œå…¨å±€ timer
    require(&quot;apisix.timers&quot;).init_worker()

    -- åŠ è½½æ‰€æœ‰æ’ä»¶å¹¶æ‰§è¡Œæ’ä»¶ init
    plugin.init_worker()
    -- åˆå§‹åŒ– router, å¹¶åŠ è½½ routes
    router.http_init_worker()

    -- åˆå§‹åŒ– services, åŠ è½½ services
    require(&quot;apisix.http.service&quot;).init_worker()
    -- åŠ è½½æ’ä»¶é…ç½®
    plugin_config.init_worker()
    -- consumer åŠ è½½
    require(&quot;apisix.consumer&quot;).init_worker()

    if core.config == require(&quot;apisix.core.config_yaml&quot;) then
        core.config.init_worker()
    end

    require(&quot;apisix.debug&quot;).init_worker()
    -- upstreams åŠ è½½
    apisix_upstream.init_worker()
    require(&quot;apisix.plugins.ext-plugin.init&quot;).init_worker()

    local_conf = core.config.local_conf()

    if local_conf.apisix and local_conf.apisix.enable_server_tokens == false then
        ver_header = &quot;APISIX&quot;
    end
end
</code></pre>
<h5 id=2343-access_by_lua>2.3.4.3. access_by_lua</h5>
<pre><code class=language-lua>-- access_by_lua é˜¶æ®µ, apisix æ²¡æœ‰ rewrite_by_lua
-- ref: https://github.com/apache/apisix/issues/1120
-- ref: https://github.com/apache/apisix/issues/1120#issuecomment-584949073
function _M.http_access_phase()
    local ngx_ctx = ngx.ctx
	...

    -- ä» table ç¼“å­˜æ± ä¸­è·å– table
    -- always fetch table from the table pool, we don't need a reused api_ctx
    local api_ctx = core.tablepool.fetch(&quot;api_ctx&quot;, 0, 32)
    -- å°† table å‚¨å­˜åœ¨ ngx.ctx ä¸­, ä¸‹ä¸€ä¸ªé˜¶æ®µå…±äº«
    ngx_ctx.api_ctx = api_ctx

    -- ç»‘å®š metatable 
    core.ctx.set_vars_meta(api_ctx)
	...

    -- router è·¯ç”±åŒ¹é…
    router.router_http.match(api_ctx)

    -- run global rule
    plugin.run_global_rules(api_ctx, router.global_rules, nil)

    ...
    local enable_websocket = route.value.enable_websocket

    -- route æ’ä»¶é…ç½®ç»‘å®š
    if route.value.plugin_config_id then
       	...
        route = plugin_config.merge(route, conf)
    end

    -- è·å–å¯¹åº”çš„ service
    if route.value.service_id then
        local service = service_fetch(route.value.service_id)
        ...
        if enable_websocket == nil then
            enable_websocket = service.value.enable_websocket
        end

    else
        ...
    end
    api_ctx.route_id = route.value.id
    api_ctx.route_name = route.value.name

    -- æ‰§è¡Œ script
    if route.value.script then
        script.load(route, api_ctx)
        script.run(&quot;access&quot;, api_ctx)
    else
        -- æ’ä»¶è¿‡æ»¤, éå†æ’ä»¶åˆ—è¡¨, åŒ¹é…å¼€å¯çš„æ’ä»¶, O(n)
        local plugins = plugin.filter(route)
        api_ctx.plugins = plugins

        -- fake æ‰§è¡Œ rewrite é˜¶æ®µ
        plugin.run_plugin(&quot;rewrite&quot;, plugins, api_ctx)
        if api_ctx.consumer then
            local changed
            route, changed = plugin.merge_consumer_route(
                route,
                api_ctx.consumer,
                api_ctx
            )

            core.log.info(&quot;find consumer &quot;, api_ctx.consumer.username,
                          &quot;, config changed: &quot;, changed)

            if changed then
                core.table.clear(api_ctx.plugins)
                api_ctx.plugins = plugin.filter(route, api_ctx.plugins)
            end
        end
        -- æ‰§è¡Œ access é˜¶æ®µ
        plugin.run_plugin(&quot;access&quot;, plugins, api_ctx)
    end

    local up_id = route.value.upstream_id

    -- used for the traffic-split plugin
    if api_ctx.upstream_id then
        up_id = api_ctx.upstream_id
    end
	...

    -- websocket ç‰¹æ®Šå¤„ç†
    if enable_websocket then
        api_ctx.var.upstream_upgrade    = api_ctx.var.http_upgrade
        api_ctx.var.upstream_connection = api_ctx.var.http_connection
        core.log.info(&quot;enabled websocket for route: &quot;, route.value.id)
    end

    if route.value.service_protocol == &quot;grpc&quot; then
        api_ctx.upstream_scheme = &quot;grpc&quot;
    end

    -- è·å– upstream èŠ‚ç‚¹
    local code, err = set_upstream(route, api_ctx)
    if code then
        core.log.error(&quot;failed to set upstream: &quot;, err)
        core.response.exit(code)
    end

    -- è´Ÿè½½å‡è¡¡
    local server, err = load_balancer.pick_server(route, api_ctx)
    if not server then
        core.log.error(&quot;failed to pick server: &quot;, err)
        return core.response.exit(502)
    end

    api_ctx.picked_server = server

    set_upstream_headers(api_ctx, server)

    -- stash ngx ctx è¿™éƒ¨åˆ†ä¸ Kong ä¸€è‡´, æ€€ç–‘æ˜¯æŠ„æ¥çš„ï¼ˆ95% ç½®ä¿¡åŒºé—´ï¼‰
    ngx_var.ctx_ref = ctxdump.stash_ngx_ctx()
    local up_scheme = api_ctx.upstream_scheme
    if up_scheme == &quot;grpcs&quot; or up_scheme == &quot;grpc&quot; then
        return ngx.exec(&quot;@grpc_pass&quot;)
    end

    if api_ctx.dubbo_proxy_enabled then
        return ngx.exec(&quot;@dubbo_pass&quot;)
    end
end
</code></pre>
<h2 id=3-ä¸€äº›æ€è€ƒ>3. ä¸€äº›æ€è€ƒ</h2>
<h3 id=31-è¾¹ç¼˜è®¡ç®—>3.1. è¾¹ç¼˜è®¡ç®—</h3>
<blockquote>
<p>å¯¹äºäº’è”ç½‘è®¾å¤‡ï¼Œç½‘ç»œè¾¹ç¼˜æ˜¯è®¾å¤‡æˆ–åŒ…å«è®¾å¤‡çš„æœ¬åœ°ç½‘ç»œä¸äº’è”ç½‘é€šä¿¡çš„ä½ç½®ã€‚è¾¹ç¼˜æ˜¯ä¸ªæ¯”è¾ƒæ¨¡ç³Šçš„æœ¯è¯­ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥å°†ç”¨æˆ·çš„è®¡ç®—æœºæˆ– IoT æ‘„åƒå¤´å†…éƒ¨çš„å¤„ç†å™¨è§†ä¸ºç½‘ç»œè¾¹ç¼˜ï¼Œä½†ä¹Ÿå¯ä»¥å°†ç”¨æˆ·çš„è·¯ç”±å™¨ã€ISP æˆ–æœ¬åœ°è¾¹ç¼˜æœåŠ¡å™¨è§†ä¸ºè¾¹ç¼˜ã€‚é‡è¦çš„æ˜¯ï¼Œç½‘ç»œè¾¹ç¼˜åœ¨åœ°ç†ä½ç½®ä¸Šé è¿‘è®¾å¤‡ï¼Œä¸<a href=https://www.cloudflare.com/learning/cdn/glossary/origin-server/>æºç«™</a>å’Œäº‘æœåŠ¡å™¨ä¸åŒï¼Œåè€…å¯èƒ½ä¸å®ƒä»¬ç›¸äº’é€šä¿¡çš„è®¾å¤‡ç›¸è·å¾ˆè¿œã€‚</p>
<p>å®Œå…¨å‡è½»é¢å¤–ç¡¬ä»¶éœ€æ±‚çš„ä¸€ç§æ–¹æ³•æ˜¯åˆ©ç”¨è¾¹ç¼˜æœåŠ¡å™¨ã€‚ä¾‹å¦‚ï¼Œå€ŸåŠ© Cloudflare åˆ†æ•£åœ¨å…¨çƒå„åœ°çš„ 194 ä¸ªè¾¹ç¼˜æœåŠ¡å™¨ç½‘ç»œï¼ŒCloudflare çš„å®¢æˆ·å¯ä»¥ä½¿ç”¨ <a href=https://www.cloudflare.com/products/cloudflare-workers/>Cloudflare Workers</a> åœ¨å…¨çƒèŒƒå›´å†…è¿è¡Œè¾¹ç¼˜ä»£ç ã€‚<sup id=fnref:10><a href=#fn:10 class=footnote-ref role=doc-noteref>10</a></sup></p>
</blockquote>
<p>Cloudflare çš„è¾¹ç¼˜è®¡ç®—æ˜¯åŸºäº Edge Gatewayï¼ˆè¾¹ç¼˜ç½‘å…³ã€è¾¹ç¼˜é›†ç¾¤ï¼‰çš„ Serverless ä»£ç æ‰§è¡Œï¼Œæä¾›äº† JS ä»£ç æ‰§è¡Œï¼Œä»¥åŠ WASM äºŒè¿›åˆ¶ã€‚<sup id=fnref:11><a href=#fn:11 class=footnote-ref role=doc-noteref>11</a></sup></p>
<p>
<figure class=image>
<img src=/2021/09/apisix-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/images/image-20210611155454963.png alt loading=lazy>
</figure></p>
<p><em>ä¸€äº›ç›¸å…³çš„ Issue:</em></p>
<ul>
<li>
<p><a href=https://github.com/openresty/openresty/issues/541>Support wasm in openresty?</a>
<figure class=image>
<img src=/2021/09/apisix-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/images/image-20210611160051987.png alt loading=lazy>
</figure></p>
</li>
<li>
<p><a href=https://github.com/apache/apisix/issues/157>feature: support WebAssembly in apisix.</a>
<figure class=image>
<img src=/2021/09/apisix-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/images/image-20210611160137790.png alt loading=lazy>
</figure></p>
</li>
</ul>
<h4 id=311-lua-serverless>3.1.1. Lua (Serverless)</h4>
<p>APISIX çš„ Serverless æ’ä»¶åŠŸèƒ½æ”¯æŒæ³¨å…¥ä»»ä½• Lua è„šæœ¬ï¼ŒKong ä¹Ÿæ”¯æŒå¯¹åº”çš„åŠŸèƒ½ï¼ŒAPISIX å°±æ˜¯æŠ„çš„ Kong çš„æ’ä»¶åŠŸèƒ½ã€‚<sup id=fnref:12><a href=#fn:12 class=footnote-ref role=doc-noteref>12</a></sup></p>
<p>
<figure class=image>
<img src=/2021/09/apisix-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/images/image-20210611160354452.png alt loading=lazy>
</figure></p>
<p>åªæ”¯æŒæœ€ç®€å•çš„å‡½æ•°æ‰§è¡Œã€‚</p>
<h4 id=312-wasm-vm>3.1.2. WASM VM</h4>
<p>LuaJIT çš„ FFI åŠŸèƒ½èƒ½éå¸¸æ–¹ä¾¿å’Œé«˜æ€§èƒ½åœ°è°ƒç”¨ C libï¼Œèƒ½é€šè¿‡ C è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œæˆ–è€…äº¤ç”± LuaJIT è‡ªåŠ¨ gcï¼ˆè¯¥éƒ¨åˆ†è¿˜åœ¨å­¦ä¹ ä¸­ï¼‰ã€‚</p>
<p>å‡ºäºæ€§èƒ½æœ€å¥½çš„å¼€æº WASM VM å¼•æ“ <a href=https://github.com/WasmEdge/WasmEdge>WasmEdge</a>ï¼ˆC++ ç¼–å†™ï¼‰æä¾› C APIï¼Œæˆ‘å°è¯•åœ¨ LuaJIT ä¸­åŠ è½½ <code>.so</code> è°ƒç”¨ WasmEdge åˆ›å»º VM è™šæ‹Ÿæœºï¼ˆVMContextï¼‰ï¼Œæ‰§è¡Œ <code>.wasm</code> æ–‡ä»¶ã€‚</p>
<blockquote>
<p>è¿™éƒ¨åˆ†ä»£ç è¿˜åœ¨è¿›è¡Œä¸­ï¼Œä¸»è¦ç›®çš„æ˜¯ç†Ÿæ‚‰ WASM åŸºæœ¬æ“ä½œï¼Œä»¥åŠå­¦ä¹  LuaJIT FFI è°ƒç”¨æ–¹æ³•ï¼ˆè¿˜éœ€è¦å­¦ä¹ ä¸€äº› C çŸ¥è¯†ï¼‰ã€‚<sup id=fnref:13><a href=#fn:13 class=footnote-ref role=doc-noteref>13</a></sup></p>
</blockquote>
<pre><code class=language-lua>local ffi = require &quot;ffi&quot;
local wasmedge = ffi.load(&quot;libwasmedge.so&quot;)
</code></pre>
<p>åŠ è½½ <code>ffi</code> åŒ…ï¼Œå¹¶åŠ è½½ WasmEdge çš„åŠ¨æ€é“¾æ¥åº“ã€‚</p>
<p>ç”±äº LuaJIT å¹¶ä¸çŸ¥é“ä»£ç é‡Œè°ƒç”¨çš„ C å‡½æ•°ç±»å‹æ˜¯ä»€ä¹ˆï¼Œéœ€è¦åœ¨ä»£ç ä¸­å®šä¹‰ C ç±»å‹ï¼š</p>
<blockquote>
<p>C ç±»å‹å‚è€ƒ WasmEdge æä¾›çš„ C++ å¯¼å‡ºçš„ C Header æ–‡ä»¶: <a href=https://github.com/WasmEdge/WasmEdge/blob/master/include/api/wasmedge.h.in>https://github.com/WasmEdge/WasmEdge/blob/master/include/api/wasmedge.h.in</a></p>
<p>å¿½ç•¥å‡½æ•°å‰é¢çš„ <code>WASMEDGE_CAPI_EXPORT extern</code> éƒ¨åˆ†ï¼ˆä¸çŸ¥é“æ˜¯å¦æ­£ç¡®ï¼‰ã€‚</p>
</blockquote>
<pre><code class=language-lua>ffi.cdef[[
    enum WasmEdge_ValType {
        WasmEdge_ValType_I32 = 0x7FU,
        WasmEdge_ValType_I64 = 0x7EU,
        WasmEdge_ValType_F32 = 0x7DU,
        WasmEdge_ValType_F64 = 0x7CU,
        WasmEdge_ValType_V128 = 0x7BU,
        WasmEdge_ValType_FuncRef = 0x70U,
        WasmEdge_ValType_ExternRef = 0x6FU
    };

    typedef struct WasmEdge_Result {
        uint8_t Code;
    } WasmEdge_Result;

    typedef struct WasmEdge_String {
        uint32_t Length;
        const char *Buf;
    } WasmEdge_String;

    typedef struct WasmEdge_Value {
    } WasmEdge_Value;

    typedef struct WasmEdge_VMContext WasmEdge_VMContext;
    typedef struct WasmEdge_ConfigureContext WasmEdge_ConfigureContext;
    typedef struct WasmEdge_StoreContext WasmEdge_StoreContext;

    WasmEdge_ConfigureContext *WasmEdge_ConfigureCreate();

    WasmEdge_String WasmEdge_StringCreateByCString(const char *Str);

    WasmEdge_VMContext *
    WasmEdge_VMCreate(const WasmEdge_ConfigureContext *ConfCxt,
                      WasmEdge_StoreContext *StoreCxt);

    const char *WasmEdge_VersionGet();
    void WasmEdge_LogSetDebugLevel();
    
    WasmEdge_Result WasmEdge_VMRunWasmFromFile(
        WasmEdge_VMContext *Cxt, const char *Path, const WasmEdge_String FuncName,
        const WasmEdge_Value *Params, const uint32_t ParamLen,
        WasmEdge_Value *Returns, const uint32_t ReturnLen);
]]
</code></pre>
<p>é¦–å…ˆå°è¯•ä¸€ä¸‹é€šè¿‡ FFI ç®€å•è·å– WasmEdge çš„ç‰ˆæœ¬å·ï¼š</p>
<pre><code class=language-lua>local ver = wasmedge.WasmEdge_VersionGet()
print(ffi.string(ver))

-- è¾“å‡º
&lt; 0.8.0
</code></pre>
<p>WasmEdge ä½¿ç”¨åº”è¯¥æ˜¯å…ˆåˆ›å»º VMï¼Œè¿è¡Œè„šæœ¬æ—¶ä¼ å…¥ VM å’Œè„šæœ¬è·¯å¾„æ‰§è¡Œï¼š</p>
<pre><code class=language-lua>-- åŠ è½½ä¸€ä¸ªæœ¬åœ°ç¼–è¯‘å¥½çš„ .wasm æ–‡ä»¶
local test_wasm_add_path = &quot;./test/wasm/add/add.wasm&quot;
-- åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„é…ç½®
local vmconf = wasmedge.WasmEdge_ConfigureCreate()
-- åˆ›å»º VM, ç¬¬äºŒä¸ªå‚æ•°æ˜¯ Store, æˆ‘ä»¬é»˜è®¤ä¼  null
local vmctx = wasmedge.WasmEdge_VMCreate(vmconf, ffi.NULL)
-- æ‰§è¡Œ wasm
local result = wasmedge.WasmEdge_VMRunWasmFromFile(vmctx, test_wasm_add_path, 
        wasmedge.WasmEdge_StringCreateByCString(&quot;add&quot;), nil,
        0, nil, 0)
</code></pre>
<p><code>WasmEdge_VMRunWasmFromFile</code> æ¥æ”¶å‚æ•° <code>WasmEdge_VMContext *Cxt</code>, <code>const char *Path</code>, <code>const WasmEdge_String FuncName</code>, <code>const WasmEdge_Value *Params</code>, <code>const uint32_t ParamLen</code>, <code>WasmEdge_Value *Returns</code>, <code>const uint32_t ReturnLen</code>ã€‚</p>
<p>æš‚æ—¶è¿˜ä¸çŸ¥é“æ€ä¹ˆåˆ›å»º C ç»“æ„ä½“çš„å‚æ•°ä¼ å…¥ï¼Œé»˜è®¤ä¼  null æ‰§è¡Œç»“æœï¼š</p>
<pre><code class=language-lua>ERROR [default] execution failed: function signature mismatch, Code: 0x83
ERROR [default]     Mismatched function type. Expected: params{i32 , i32} returns{i32} , Got: params{} returns{i32}
</code></pre>
<p>çœ‹ä¸Šå»ç›´åˆ°å‚æ•°ä¼ å…¥ä¸ºæ­¢è¿˜æ²¡é—®é¢˜ï¼Œåç»­å†ç»§ç»­ç ”ç©¶ã€‚</p>
<h3 id=32-mesh>3.2. Mesh</h3>
<p>APISIX ç½‘å…³çš„ Mesh é¡¹ç›®ã€‚å€¼å¾—ä¸€æçš„æ˜¯ Kong ä¹Ÿæœ‰ç±»ä¼¼çš„ Mesh é¡¹ç›®ã€‚</p>
<p>Repo: <a href=https://github.com/api7/apisix-mesh-agent>api7/apisix-mesh-agent</a></p>
<p>
<figure class=image>
<img src=/2021/09/apisix-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/images/apisix-mesh-overview.png alt loading=lazy>
</figure></p>
<p>Go è¯­è¨€å¼€å‘çš„ Agentï¼Œæ¥å…¥äº† Istio çš„åè®®ï¼š</p>
<pre><code class=language-go>module github.com/api7/apisix-mesh-agent

go 1.16

require (
	github.com/envoyproxy/go-control-plane v0.9.9-0.20210115003313-31f9241a16e6
	github.com/envoyproxy/protoc-gen-validate v0.4.1
	github.com/fsnotify/fsnotify v1.4.9
	github.com/golang/protobuf v1.4.3
	github.com/google/uuid v1.2.0
	github.com/grpc-ecosystem/grpc-gateway v1.14.6
	github.com/soheilhy/cmux v0.1.4
	github.com/spf13/cobra v1.1.3
	github.com/stretchr/testify v1.7.0
	github.com/tmc/grpc-websocket-proxy v0.0.0-20190109142713-0ad062ec5ee5
	go.etcd.io/etcd/api/v3 v3.5.0-alpha.0
	go.uber.org/zap v1.16.0
	golang.org/x/net v0.0.0-20210525063256-abc453219eb5
	google.golang.org/genproto v0.0.0-20210222152913-aa3ee6e6a81c
	google.golang.org/grpc v1.36.0
	google.golang.org/grpc/examples v0.0.0-20210304020650-930c79186c99 // indirect
	google.golang.org/protobuf v1.25.0
	gotest.tools v2.2.0+incompatible
	istio.io/istio v0.0.0-20210308180034-f6502508b04c
)
</code></pre>
<h3 id=33-ç½‘å…³é€‰å‹>3.3. ç½‘å…³é€‰å‹</h3>
<p>APISIX ç½‘å…³ç›¸å½“äº Kong çš„é‡æ„ï¼Œæ€§èƒ½é«˜äº Kongï¼Œèµ„æºå ç”¨è¾ƒä½ï¼ŒäºŒæ¬¡å¼€å‘è¾ƒä¸ºæ–¹ä¾¿ã€‚ä½†æ˜¯å…¬å¸å†…éƒ¨ä½¿ç”¨çš„ Kong ç½‘å…³ç›®å‰æ¥å…¥äº† Kong Ingress Controllerï¼Œè™šæ‹Ÿæœºæ³¨å†Œçš„éƒ¨åˆ†ä¹Ÿç”¨çš„æ˜¯ Kong å¼€æºçš„ Go åŒ…ï¼Œç”Ÿæ€è¾ƒä¸ºä¸°å¯Œã€‚</p>
<p>APISIX ç›®å‰è¿˜æ²¡æä¾› Go çš„ SDKã€‚APISIX å¼€æºçš„ Traffic Split ä»¥åŠ Mirror æ’ä»¶ä¹Ÿä¸è¶³ä»¥æ»¡è¶³å…¬å¸æµé‡ç‰µå¼•çš„éœ€æ±‚ã€‚</p>
<p>æˆ‘è®¤ä¸ºå…¬å¸ç›®å‰ä»å¯ä»¥ç»§ç»­ä½¿ç”¨ Kong ç½‘å…³ï¼Œç»å†æœ¬æ¬¡ APISIX æºç é˜…è¯»ï¼Œä¸ OpenResty ç›¸å…³ä½“ç³»çš„å­¦ä¹ åäºŒæ¬¡å¼€å‘èƒ½åŠ›æœ‰æ‰€æå‡ã€‚</p>
<p>å¦‚æœè¦å°†å…¬å¸ç½‘å…³ä» Kong è¿ç§»åˆ° APISIX çš„é™„åŠ æˆæœ¬å¾ˆé«˜ï¼Œå¼€å‘ã€è¿ç§»ã€å…¶ä»–éƒ¨é—¨åè°ƒæ—¶é—´è‡³å°‘éœ€è¦ 2 å‘¨ï¼Œå¯¹æ¯”èµ·æ¥æ”¶ç›Šå¹¶ä¸å¤§ï¼Œå…¬å¸ç°åœ¨å¹¶ä¸ç¼ºå°‘ APISIX çš„åŠŸèƒ½ã€‚</p>
<p>é˜…è¯»è¿‡æºç å APISIX å”¯ä¸€æ¯”è¾ƒå¥½çš„åŠŸèƒ½ç‚¹æ˜¯æ”¯æŒå¤–éƒ¨æ³¨å†Œä¸­å¿ƒï¼Œå…¬å¸ä½¿ç”¨ Bilibili discovery æ³¨å†Œä¸­å¿ƒäºŒæ¬¡å¼€å‘ç‰ˆæœ¬ï¼Œæ¥å…¥æ³¨å†Œä¸­å¿ƒåèƒ½å¤Ÿè·å–åˆ°æœåŠ¡æ›´å¤šå…ƒæ•°æ®ï¼Œä¾¿äºåç»­åœ¨ç½‘å…³å¯¹æœåŠ¡è¿›è¡Œæ²»ç†ã€‚Kong ç½‘å…³ç¤¾åŒºæœ‰ Consul æ¥å…¥çš„è®¨è®ºï¼Œå¯ä»¥ç»§ç»­å…³æ³¨è¯¥ Issue è¿›å±•ï¼Œæˆ–ä¸ºç¤¾åŒºæè®®å¼€å‘ç›¸åº”åŠŸèƒ½ã€‚</p>
<p>APISIX ç½‘å…³ä¸­ä½¿ç”¨åˆ°çš„ LuaJIT å’Œ OpenResty çš„ Coding æ€§èƒ½ä¼˜åŒ–æŠ€å·§å¯ä»¥å­¦ä¹ ã€‚</p>
<section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p><a href=https://github.com/apache/apisix/issues/3207#issuecomment-759269071>How does Kong solve similar problems?</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:2 role=doc-endnote>
<p><a href=https://segmentfault.com/a/1190000016149595>LuaJIT FFI ä»‹ç»ï¼ŒåŠå…¶åœ¨ OpenResty ä¸­çš„åº”ç”¨ï¼ˆä¸‹ï¼‰</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:3 role=doc-endnote>
<p><a href=https://yxudong.github.io/%E3%80%8AOpenResty%E7%B2%BE%E5%8D%8E%E6%95%B4%E7%90%86%E3%80%8B6.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/>ã€ŠOpenRestyç²¾åæ•´ç†ã€‹6.æ€§èƒ½ä¼˜åŒ– </a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:4 role=doc-endnote>
<p><a href=https://github.com/openresty/luajit2>openresty/luajit2</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:5 role=doc-endnote>
<p><a href=https://www.cnblogs.com/liekkas01/p/12764577.html>OpenRestyï¼šç‰¹æƒè¿›ç¨‹å’Œå®šæ—¶ä»»åŠ¡</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:6 role=doc-endnote>
<p><a href=https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/process.md#enable_privileged_agent>enable_privileged_agent</a>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:7 role=doc-endnote>
<p><a href=https://github.com/openresty/lua-nginx-module/issues/1482>ngx.var vs ngx.ctx</a>&#160;<a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:8 role=doc-endnote>
<p><a href=https://github.com/openresty/lua-resty-lrucache#description>openresty/lua-resty-lrucache</a>&#160;<a href=#fnref:8 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:9 role=doc-endnote>
<p><a href=https://github.com/apache/apisix/issues/1120#issuecomment-584949073>set variable inoperative!!</a>&#160;<a href=#fnref:9 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:10 role=doc-endnote>
<p><a href=https://www.cloudflare.com/zh-cn/learning/serverless/glossary/what-is-edge-computing/>ä»€ä¹ˆæ˜¯è¾¹ç¼˜è®¡ç®—ï¼Ÿ</a>&#160;<a href=#fnref:10 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:11 role=doc-endnote>
<p><a href=https://blog.cloudflare.com/webassembly-on-cloudflare-workers/>WebAssembly on Cloudflare Workers</a>&#160;<a href=#fnref:11 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:12 role=doc-endnote>
<p><a href=https://github.com/apache/apisix/blob/master/docs/en/latest/plugins/serverless.md>APISIX Serverless Plugin</a>&#160;<a href=#fnref:12 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:13 role=doc-endnote>
<p><a href=https://github.com/mayocream/lua-resty-wasm>mayocream/lua-resty-wasm</a>&#160;<a href=#fnref:13 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
</ol>
</section>
</div>
<footer class=post-footer>
<div class=post-meta>
<time datetime=" 2021-09-27" itemprop=datePublished>Sep 27, 2021</time>
</div>
</footer>
</article>
<script src=https://cdn.jsdelivr.net/npm/tocbot/dist/tocbot.min.js></script>
<aside class=typeface-sans lang=zh-hans>
<nav class=toc></nav>
</aside>
<script>tocbot.init({tocSelector:'.toc',contentSelector:'article',headingSelector:'h1, h2, h3, h4, h5',hasInnerContainers:!0,collapseDepth:"3",positionFixedSelector:".toc",headingsOffset:10})</script>
</div><script src=https://cdn.jsdelivr.net/npm/prismjs@1.24.1/prism.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/prismjs@1.24.1/plugins/filter-highlight-all/prism-filter-highlight-all.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/prismjs@1.24.1/plugins/autoloader/prism-autoloader.min.js></script>
<script>Prism.plugins.filterHighlightAll.add(function(a){return a.language!=="mermaid"})</script>
<script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script>
<script>mermaid.init({startOnLoad:!0},"pre code.language-mermaid",function(){const a=document.querySelectorAll('code.language-mermaid');for(const c of a){c.style.backgroundColor='initial';const b=c.parentNode;b.style.border='none',b.style.textAlign='center',window.darkmode&&!window.darkmode.isActivated()&&(b.style.backgroundColor='initial')}})</script>
</div>
</main><footer class=site-footer>
<div class=wrapper>
<div class=social-links>
<a class="social-link social-github" href=https://github.com/mayocream><svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="currentcolor" d="M12 2A10 10 0 002 12c0 4.42 2.87 8.17 6.84 9.5C9.34 21.58 9.5 21.27 9.5 21 9.5 20.77 9.5 20.14 9.5 19.31 6.73 19.91 6.14 17.97 6.14 17.97c-.46-1.16-1.11-1.47-1.11-1.47C4.12 15.88 5.1 15.9 5.1 15.9 6.1 15.97 6.63 16.93 6.63 16.93 7.5 18.45 8.97 18 9.54 17.76 9.63 17.11 9.89 16.67 10.17 16.42c-2.22-.25-4.55-1.11-4.55-4.92.0-1.11.38-2 1.03-2.71C6.55 8.54 6.2 7.5 6.75 6.15c0 0 .84-.27 2.75 1.02C10.29 6.95 11.15 6.84 12 6.84s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02C17.8 7.5 17.45 8.54 17.35 8.79 18 9.5 18.38 10.39 18.38 11.5c0 3.82-2.34 4.66-4.57 4.91C14.17 16.72 14.5 17.33 14.5 18.26c0 1.34.0 2.42.0 2.74.0.27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0012 2z"/></svg>
</a>
<a class="social-link social-twitter" href=https://twitter.com/Freeze_Mayo><svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="currentcolor" d="M22.46 6c-.77.35-1.6.58-2.46.69C20.88 6.16 21.56 5.32 21.88 4.31 21.05 4.81 20.13 5.16 19.16 5.36 18.37 4.5 17.26 4 16 4c-2.35.0-4.27 1.92-4.27 4.29C11.73 8.63 11.77 8.96 11.84 9.27 8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15.0 1.49.75 2.81 1.91 3.56C3.62 10.5 2.96 10.3 2.38 10V10.03c0 2.08 1.48 3.82 3.44 4.21C5.46 14.34 5.08 14.39 4.69 14.39 4.42 14.39 4.15 14.36 3.89 14.31c.54 1.69 2.11 2.95 4 2.98-1.46 1.16-3.31 1.84-5.33 1.84C2.22 19.13 1.88 19.11 1.54 19.07 3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79 20.33 8.6 20.33 8.42 20.32 8.23 21.16 7.63 21.88 6.87 22.46 6z"/></svg>
</a>
<a class="social-link social-rss" href=/index.xml target=_blank><svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="currentcolor" d="M6.18 15.64a2.18 2.18.0 012.18 2.18C8.36 19 7.38 20 6.18 20 5 20 4 19 4 17.82a2.18 2.18.0 012.18-2.18M4 4.44A15.56 15.56.0 0119.56 20H16.73A12.73 12.73.0 004 7.27V4.44M4 10.1A9.9 9.9.0 0113.9 20H11.07A7.07 7.07.0 004 12.93V10.1z"/></svg>
</a>
</div>
<div class=credits>
Theme KAGAMI by Kamikat
</div>
</div>
</footer><script>(function(a){for(var a=Array.prototype.slice.call(document.getElementsByClassName('baseline-fix')),b=0,c;b!=a.length;b++)c=a[b],c.innerHTML=c.innerHTML.replace(/[\u2000-\u206eâ¸€-\u2e7eâº€-\u2efeâ¼€-\u2fdeâ¿°-\u2ffe\u3000-ã€¾\u3040-ã‚ã‚ -ãƒ¾\u3100-\u312e\u3130-ã†ã†-ã†ã† -\u31beã‡€-\u31eeã‡°-ã‡¾ãˆ€-ã‹¾ãŒ€-ã¾ã€-\u4dbeä¸€-\u9ffe\ua960-\ua97eê°€-\ud7ae\ud7b0-\ud7feï¤€-\ufafeï¸°-ï¹\uff00-ï¿®]|[\ud840-\ud868\ud86a-\ud86c][\udc00-\udfff]|\ud82c[\udc00-\udcfe]|\ud869[\udc00-\udede\udf00-\udfff]|\ud86d[\udc00-\udf3e\udf40-\udfff]|\ud86e[\udc00-\udc1e]|\ud87e[\udc00-\ude1e]/g,function(a){return'<span class="baseline-fix-block">'+a+'<'+'/span>'}),c.classList.remove('baseline-fix')})(Array.prototype.slice.call(document.getElementsByClassName('baseline-fix')))</script>
<script type=text/javascript>const resize=function(){this.width=.5*(this.naturalWidth||this.width)};Array.prototype.forEach.call(document.querySelectorAll('.half-size, .retina2x'),function(a){a.naturalWidth?resize.call(a):a.onload=resize})</script>
<script src=https://cdn.jsdelivr.net/npm/twemoji@13.1.0/dist/twemoji.min.js></script>
<script>twemoji.parse(document.body,{folder:'svg',ext:'.svg'})</script>
</body>