<!doctype html><html lang=zh-hans><head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<title>K8s é›†ç¾¤è°ƒåº¦ WASM å®éªŒ - Mayo's Blog</title>
<meta name=description content="Webassemblyï¼ˆWASMï¼‰æ˜¯ Next-Generation çš„è½¯ä»¶åˆ†å‘æ–¹å¼ï¼Œå…·æœ‰è·¨è¯­è¨€ã€è·¨å¹³å°ã€è‡ªå¸¦è¿è¡Œæ—¶çš„æ— æ•Œå±æ€§1ã€‚çŸ¥æ™“äº†å®ƒçš„ç¾å¦™ä¹‹å¤„ï¼Œæˆ‘ä»¬è‡ªç„¶ä¼šæƒ³æ‹¥æœ‰æ¬¡ä¸–ä»£">
<meta name=author content>
<link rel=preconnect href=https://cdn.jsdelivr.net>
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css?family=Crimson+Text:400,700|Press+Start+2P" rel=stylesheet>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400&family=Noto+Sans+JP:wght@300;400&family=Noto+Sans+SC:wght@300;400&family=Noto+Serif:wght@300;400&family=Noto+Serif+JP:wght@300;400&family=Noto+Serif+SC:wght@300;400&family=Source+Code+Pro:wght@300;400" rel=stylesheet>
<link rel=stylesheet href="/bundle.css?v=1636447687" media=all>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/tocbot/dist/tocbot.css>
<link rel=icon href=https://github.com/mayocream.png><meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://shoujo.ink/2021/09/k8s-%E9%9B%86%E7%BE%A4%E8%B0%83%E5%BA%A6-wasm-%E5%AE%9E%E9%AA%8C/>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-JKVXF5HSKT','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<meta property="og:title" content="K8s é›†ç¾¤è°ƒåº¦ WASM å®éªŒ">
<meta property="og:description" content="Webassemblyï¼ˆWASMï¼‰æ˜¯ Next-Generation çš„è½¯ä»¶åˆ†å‘æ–¹å¼ï¼Œå…·æœ‰è·¨è¯­è¨€ã€è·¨å¹³å°ã€è‡ªå¸¦è¿è¡Œæ—¶çš„æ— æ•Œå±æ€§1ã€‚çŸ¥æ™“äº†å®ƒçš„ç¾å¦™ä¹‹å¤„ï¼Œæˆ‘ä»¬è‡ªç„¶ä¼šæƒ³æ‹¥æœ‰æ¬¡ä¸–ä»£">
<meta property="og:type" content="article">
<meta property="og:url" content="https://shoujo.ink/2021/09/k8s-%E9%9B%86%E7%BE%A4%E8%B0%83%E5%BA%A6-wasm-%E5%AE%9E%E9%AA%8C/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-09-23T21:00:00+08:00">
<meta property="article:modified_time" content="2021-09-23T21:00:00+08:00"><meta property="og:site_name" content="Mayo's Blog">
</head>
</html>
<body><script src=https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js></script>
<script>const opts={bottom:'32px',right:'unset',left:'32px',time:'0.3s',mixColor:'#fff',backgroundColor:'#fff',buttonColorDark:'#100f2c',buttonColorLight:'#fff',saveInCookies:!0,label:'ğŸŒ“',autoMatchOsTheme:!0};let darkmode;window.matchMedia('only screen and (min-width: 680px)').matches?(darkmode=new Darkmode(opts),darkmode.showWidget()):(localStorage.removeItem('darkmode'),darkmode=new Darkmode(opts)),window.darkmode=darkmode,document.addEventListener('DOMContentLoaded',function(){document.body.style.opacity=1})</script>
<main class=page-content aria-label=Content>
<div class=wrapper><nav class=site-nav>
<a class=page-link href=/posts/>Posts</a>
<a class=page-link href=/about/>About</a>
</nav><header class=post-header>
<a class=site-title href=https://shoujo.ink>Mayo's Blog</a>
<h1 class="post-title baseline-fix typeface-sans" lang=zh-hans itemprop="name headline">K8s é›†ç¾¤è°ƒåº¦ WASM å®éªŒ</h1>
</header>
<div class=post-cover aria-label=Cover>
<div class=post-cover-wrapper>
<img src alt>
</div>
<div class=cover-meta></div>
</div>
<div class=post-layout>
<article class="post typeface-sans" lang=zh-hans itemscope itemtype=http://schema.org/BlogPosting>
<div class=post-content itemprop=articleBody>
<p>Webassemblyï¼ˆWASMï¼‰æ˜¯ Next-Generation çš„è½¯ä»¶åˆ†å‘æ–¹å¼ï¼Œå…·æœ‰è·¨è¯­è¨€ã€è·¨å¹³å°ã€è‡ªå¸¦è¿è¡Œæ—¶çš„æ— æ•Œå±æ€§<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>ã€‚çŸ¥æ™“äº†å®ƒçš„ç¾å¦™ä¹‹å¤„ï¼Œæˆ‘ä»¬è‡ªç„¶ä¼šæƒ³æ‹¥æœ‰æ¬¡ä¸–ä»£çš„ä½“éªŒï¼Œæœ¬æ–‡æè¿°å°è¯•å°†è½»é‡çº§ WASM ç”¨ç±» OCI æ‰“åŒ…æ–¹å¼è°ƒåº¦åˆ° K8s é›†ç¾¤ä¸­è¿è¡Œçš„è¿‡ç¨‹ï¼Œä»¥åŠå…¶ä¸­çš„è‰°è¾›ä¹‹å¤„ã€‚</p>
<p>WASM åœ¨å½“å‰é˜¶æ®µè¿˜å¾ˆå°´å°¬ï¼ŒWASIï¼ˆWebAssembly System Interfaceï¼‰è¿˜å¤„äº<a href=https://github.com/WebAssembly/WASI/milestone/1>æ—©æœŸé˜¶æ®µ</a>ï¼ŒWASM è¿è¡Œæ—¶é¡¹ç›® <a href=https://github.com/wasmerio/wasmer>Wasmer</a> ä¸ <a href=https://github.com/bytecodealliance/wasmtime>wasmtime</a> å¯¹äºå¤šè¯­è¨€çš„æ”¯æŒè¿˜ä¸è¶³ï¼Œäº‘å‚å•†ä¾‹å¦‚ Cloudflare ä¸ AWS Lambda@Edge éƒ½ä¸æ˜¯åŸç”Ÿæ”¯æŒ WASMï¼ŒWASM çš„æ‰§è¡Œæ€§èƒ½ä¹Ÿå¯èƒ½æ¯”ä¸ä¸Š Google çš„ v8 JavaScript å¼•æ“ã€‚</p>
<p>å½“æˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†ä¸€äº›å¸Œæœ›ï¼šGo å®˜æ–¹ä¹Ÿè®¸ä¼š<a href=https://github.com/golang/go/issues/31105>æ”¯æŒ WASI</a>ã€APISIX å‡†å¤‡<a href=https://github.com/apache/apisix/issues/157>ä½¿ç”¨ Wamser ä½œä¸º WASM è¿è¡Œæ—¶</a>ã€‚</p>
<p>æˆ‘å½“å‰åœ¨è¿›è¡Œçš„å¦ä¸€ä¸ªé¡¹ç›®ä¹Ÿé€šè¿‡åœ¨æµè§ˆå™¨ä¸­åŠ è½½ WASM å®ç° X.509 è¯ä¹¦è§£æã€ç­¾åä¸ ACME ç”³è¯·è¯ä¹¦ï¼Œè¯¥é¡¹ç›®è¿˜ä¼šä½¿ç”¨ Serverless æŠ€æœ¯è¿›è¡Œæµé‡ä»£ç†ï¼Œä¸è¿‡è¿™ä¸ªå‘ä½•æ—¶èƒ½å¡«å®Œå°±æ²¡æœ‰äººçŸ¥é“äº† ğŸ’€ã€‚</p>
<h2 id=1-krustlet-è°ƒåº¦-wasm>1. Krustlet è°ƒåº¦ WASM</h2>
<blockquote>
<p>Krustlet ä»‹ç»ï¼š<a href=https://www.infoq.cn/article/oumc77mjsl67m39lqgtg>ä½¿ç”¨ Rust å¼€å‘çš„ kubeletï¼Œç”¨äºè¿è¡Œ WASM å·¥ä½œè´Ÿè½½</a></p>
</blockquote>
<p>æ¦‚è¿°ï¼šKrustlet çš„å·¥ä½œæ–¹å¼ç±»ä¼¼äº Kubeletï¼Œæ˜¯åœ¨ K8s é›†ç¾¤å·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡Œçš„åå°ç¨‹åºï¼Œè´Ÿè´£ä¸ŠæŠ¥èŠ‚ç‚¹çŠ¶æ€ä»¥åŠè¿è¡Œå·¥ä½œè´Ÿè½½ï¼ˆWASMï¼‰ã€‚</p>
<p>ç›®å‰ä¸æ”¯æŒ CNI ç½‘ç»œã€‚</p>
<h3 id=11-éƒ¨ç½²å®‰è£…>1.1. éƒ¨ç½²å®‰è£…</h3>
<h4 id=111-æµ‹è¯•ç¯å¢ƒ>1.1.1. æµ‹è¯•ç¯å¢ƒ</h4>
<ul>
<li>é˜¿é‡Œäº‘æµ‹è¯•é›†ç¾¤ - <code>192.168.33.161</code> æœºå™¨ï¼ˆ2c 8gï¼‰</li>
</ul>
<h4 id=112-å®‰è£…-krustlet>1.1.2. å®‰è£… Krustlet</h4>
<pre><code class=language-bash>#!/bin/bash

wget https://krustlet.blob.core.windows.net/releases/krustlet-v0.7.0-linux-amd64.tar.gz -O /tmp/krustlet.tar.gz
tar zxvf /tmp/krustlet.tar.gz &amp;&amp; mv krustlet-wasi /usr/local/bin/
</code></pre>
<h4 id=113-èŠ‚ç‚¹åˆå§‹åŒ–>1.1.3. èŠ‚ç‚¹åˆå§‹åŒ–</h4>
<blockquote>
<p>æ ¹æ®å®˜æ–¹æ–‡æ¡£è¿›è¡ŒèŠ‚ç‚¹åˆå§‹åŒ–: <a href=https://docs.krustlet.dev/intro/quickstart/>quickstart</a>ã€‚</p>
</blockquote>
<p>æ­¥éª¤ï¼š</p>
<ol>
<li>
<p>èŠ‚ç‚¹ä¸Šå®‰è£… Kubectl å¹¶é…ç½®æœ‰åœ¨ <code>kube-system</code> ä¸‹åˆ›å»º CSR èµ„æºçš„å‡­è¯</p>
</li>
<li>
<p>æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬</p>
<pre><code class=language-bash>bash &lt;(curl https://raw.githubusercontent.com/deislabs/krustlet/master/docs/howto/assets/bootstrap.sh)
</code></pre>
</li>
<li>
<p>åˆ›å»º Systemd æ–‡ä»¶ <code>/etc/systemd/system/krustlet.service</code></p>
<pre><code class=language-bash>[Unit]
Description=Krustlet, a kubelet implementation for running WASM

[Service]
Restart=on-failure
RestartSec=5s
Environment=KUBECONFIG=/root/.kube/config
ExecStart=/usr/local/bin/krustlet-wasi
User=root
Group=root

[Install]
WantedBy=multi-user.target
</code></pre>
<pre><code class=language-bash>systemctl daemon-reload
systemctl enable krustlet.service
systemctl start krustlet.service
</code></pre>
</li>
<li>
<p>å®¡æ ¸ CSR ç”³è¯·</p>
<pre><code class=language-bash>kubectl certificate approve ${HOSTNAME}-tls
</code></pre>
</li>
</ol>
<h4 id=114-èŠ‚ç‚¹çŠ¶æ€>1.1.4. èŠ‚ç‚¹çŠ¶æ€</h4>
<p>
<figure class=image>
<img src=/2021/09/k8s-%E9%9B%86%E7%BE%A4%E8%B0%83%E5%BA%A6-wasm-%E5%AE%9E%E9%AA%8C/images/Untitled.png alt="ç­‰å¾…æ‰‹åŠ¨ Approve" loading=lazy>
<figcaption>ç­‰å¾…æ‰‹åŠ¨ Approve</figcaption>
</figure></p>
<p>
<figure class=image>
<img src=/2021/09/k8s-%E9%9B%86%E7%BE%A4%E8%B0%83%E5%BA%A6-wasm-%E5%AE%9E%E9%AA%8C/images/1.png alt=ç¨‹åºæ­£å¸¸å¯åŠ¨ loading=lazy>
<figcaption>ç¨‹åºæ­£å¸¸å¯åŠ¨</figcaption>
</figure></p>
<p>
<figure class=image>
<img src=/2021/09/k8s-%E9%9B%86%E7%BE%A4%E8%B0%83%E5%BA%A6-wasm-%E5%AE%9E%E9%AA%8C/images/2.png alt="Krustlet èŠ‚ç‚¹å·²åŠ å…¥é›†ç¾¤" loading=lazy>
<figcaption>Krustlet èŠ‚ç‚¹å·²åŠ å…¥é›†ç¾¤</figcaption>
</figure></p>
<ul>
<li>
<p>Krustlet èŠ‚ç‚¹è¯¦æƒ… <code>kubectl describe node ${HOSTNAME}</code></p>
<pre><code class=language-bash>Name:               izuf6cc5ecqwtuhm1p2rcaz
Roles:              &lt;none&gt;
Labels:             beta.kubernetes.io/arch=wasm32-wasi
                    beta.kubernetes.io/os=wasm32-wasi
                    kubernetes.io/arch=wasm32-wasi
                    kubernetes.io/hostname=iZuf6cc5ecqwtuhm1p2rcaZ
                    kubernetes.io/os=wasm32-wasi
                    type=krustlet
Annotations:        node.alpha.kubernetes.io/ttl: 0
                    volumes.kubernetes.io/controller-managed-attach-detach: true
CreationTimestamp:  Thu, 08 Jul 2021 14:45:26 +0800
Taints:             kubernetes.io/arch=wasm32-wasi:NoExecute
                    kubernetes.io/arch=wasm32-wasi:NoSchedule
Unschedulable:      false
Lease:
  HolderIdentity:  izuf6cc5ecqwtuhm1p2rcaz
  AcquireTime:     Thu, 08 Jul 2021 14:49:37 +0800
  RenewTime:       Thu, 08 Jul 2021 14:49:37 +0800
Conditions:
  Type        Status  LastHeartbeatTime                 LastTransitionTime                Reason                     Message
  ----        ------  -----------------                 ------------------                ------                     -------
  Ready       True    Thu, 08 Jul 2021 14:49:37 +0800   Thu, 08 Jul 2021 14:45:26 +0800   KubeletReady               kubelet is posting ready status
  OutOfDisk   False   Thu, 08 Jul 2021 14:45:26 +0800   Thu, 08 Jul 2021 14:45:26 +0800   KubeletHasSufficientDisk   kubelet has sufficient disk space available
Addresses:
  InternalIP:  192.168.33.161
  Hostname:    iZuf6cc5ecqwtuhm1p2rcaZ
Capacity:
  cpu:                4
  ephemeral-storage:  61255492Ki
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             4032800Ki
  pods:               110
Allocatable:
  cpu:                4
  ephemeral-storage:  61255492Ki
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             4032800Ki
  pods:               110
System Info:
  Machine ID:                 
  System UUID:                
  Boot ID:                    
  Kernel Version:             
  OS Image:                   
  Operating System:           linux
  Architecture:               wasm-wasi
  Container Runtime Version:  mvp
  Kubelet Version:            0.7.0
  Kube-Proxy Version:         v1.17.0
PodCIDR:                      10.244.0.0/24
PodCIDRs:                     10.244.0.0/24
Non-terminated Pods:          (3 in total)
  Namespace                   Name                   CPU Requests  CPU Limits  Memory Requests  Memory Limits  Age
  ---------                   ----                   ------------  ----------  ---------------  -------------  ---
  kruise-system               kruise-daemon-v9nfh    0 (0%)        50m (1%)    0 (0%)           64Mi (1%)      4m17s
  kube-system                 calico-node-m4d67      150m (3%)     300m (7%)   64M (1%)         500M (12%)     4m17s
  kube-system                 nodelocaldns-k5kd2     100m (2%)     0 (0%)      70Mi (1%)        170Mi (4%)     4m17s
Allocated resources:
  (Total limits may be over 100 percent, i.e., overcommitted.)
  Resource           Requests        Limits
  --------           --------        ------
  cpu                250m (6%)       350m (8%)
  memory             137400320 (3%)  745366784 (18%)
  ephemeral-storage  0 (0%)          0 (0%)
  hugepages-1Gi      0 (0%)          0 (0%)
  hugepages-2Mi      0 (0%)          0 (0%)
Events:              &lt;none&gt;
</code></pre>
</li>
</ul>
<p>èŠ‚ç‚¹å¸¦æœ‰ä¸¤ä¸ªæ±¡ç‚¹ï¼š</p>
<pre><code class=language-bash>Taints:             kubernetes.io/arch=wasm32-wasi:NoExecute
                    kubernetes.io/arch=wasm32-wasi:NoSchedule
</code></pre>
<h3 id=12-wasm-oci>1.2. WASM OCI</h3>
<p>Krustlet ä½¿ç”¨ <a href=https://github.com/engineerd/wasm-to-oci>wasm-to-oci</a> æ‰“åŒ… WASM ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶åˆ°é•œåƒä»“åº“ã€‚</p>
<h4 id=121-æ¨é€é•œåƒ>1.2.1. æ¨é€é•œåƒ</h4>
<p>å®‰è£… wasm-to-oci CLI</p>
<pre><code class=language-bash>wget https://github.com/engineerd/wasm-to-oci/releases/download/v0.1.2/linux-amd64-wasm-to-oci -O /usr/local/bin/wasm-to-oci \
&amp;&amp; chmod +x /usr/local/bin/wasm-to-oci
</code></pre>
<ul>
<li>
<p><code>wasm-to-oci</code> Usage</p>
<pre><code class=language-bash>Usage:
  wasm-to-oci [command]

Available Commands:
  help        Help about any command
  pull        Pulls a WASM module from an OCI registry
  push        Pushes a WASM module from an OCI registry

Flags:
  -d, --dir string         Directory where the trust data is persisted to (default &quot;/root/.wasm-to-oci&quot;)
  -h, --help               help for wasm-to-oci
      --insecure           allow connections to SSL registry without certs
      --log string         Set the logging level (&quot;debug&quot;|&quot;info&quot;|&quot;warn&quot;|&quot;error&quot;|&quot;fatal&quot;) (default &quot;info&quot;)
      --server string      The trust server used (default &quot;https://notary.docker.io&quot;)
  -t, --timeout string     Timeout for the trust server (default &quot;5s&quot;)
      --tlscacert string   Trust certs signed only by this CA
      --use-http           use plain http and not https
</code></pre>
</li>
</ul>
<p>æ‰“åŒ…ç¤ºä¾‹ WASMï¼ˆäºŒè¿›åˆ¶ç¼–è¯‘åçš„æ–‡ä»¶ï¼‰</p>
<pre><code class=language-bash>wget https://github.com/engineerd/wasm-to-oci/raw/master/testdata/hello.wasm
wasm-to-oci push hello.wasm harbor.domain.dev/bifrost/hello-wasm:v1
</code></pre>
<blockquote>
<p>Docker éœ€è¦æœ‰ Registry çš„å‡­è¯ <code>~/.docker/config.json</code></p>
</blockquote>
<p>Push è¾“å‡ºï¼š</p>
<pre><code class=language-bash>INFO[0001] Pushed: harbor.domain.dev/bifrost/hello-wasm:v1 
INFO[0001] Size: 1624962                                
INFO[0001] Digest: sha256:a01f32cc647abe49bb34727cc2c520e6e304e3049d669f53e2d30d49ee2ed9c7
</code></pre>
<p>wasm-oci ä½¿ç”¨äº†è‡ªå®šä¹‰çš„ OCI Layerï¼Œå±äºéæ ‡å‡†ç±»å‹ã€‚</p>
<blockquote>
<p><a href=https://radu-matei.com/blog/wasm-oci-tuf/>Securely distributing and signing WebAssembly modules using OCI and TUF</a></p>
</blockquote>
<pre><code class=language-json>{
  &quot;schemaVersion&quot;: 2,
  &quot;config&quot;: {
    &quot;mediaType&quot;: &quot;application/vnd.wasm.config.v1+json&quot;,
    &quot;digest&quot;: &quot;sha256:44136fa355b3678a1146ad16f7e8649e94fb4fc21fe77e8310c060f61caaff8a&quot;,
    &quot;size&quot;: 2
  },
  &quot;layers&quot;: [
    {
      &quot;mediaType&quot;: &quot;application/vnd.wasm.content.layer.v1+wasm&quot;,
      &quot;digest&quot;: &quot;sha256:4c7915b4c1f9b0c13f962998e4199ceb00db39a4a7fa4554f40ae0bed83d9510&quot;,
      &quot;size&quot;: 1624962
    }
  ]
}
</code></pre>
<h4 id=122-æ‹‰å–é•œåƒ>1.2.2. æ‹‰å–é•œåƒ</h4>
<p>ç”±äºæ˜¯éæ ‡å‡†æ ¼å¼çš„ OCI é•œåƒï¼Œç›´æ¥ä½¿ç”¨ Docker CLI æ‹‰å–ä¼šå‡ºé”™ï¼š</p>
<pre><code class=language-bash>v1: Pulling from bifrost/hello-wasm
4c7915b4c1f9: Pulling fs layer 
invalid rootfs in image configuration
</code></pre>
<h4 id=123-wasm-module-ä¸å®¹å™¨åŒºåˆ«>1.2.3. WASM module ä¸å®¹å™¨åŒºåˆ«</h4>
<p><a href=https://github.com/deislabs/krustlet/issues/624#issuecomment-855607557>Krustlet-tutorial pod get stuck in init:regitered status Â· Issue #624 Â· deislabs/krustlet</a></p>
<ul>
<li>WASM OCI ä¸æ˜¯ Docker å®¹å™¨</li>
<li>WASM OCI ä¸èƒ½ä½¿ç”¨ Docker pull</li>
</ul>
<h3 id=13-wasm-pod-è°ƒåº¦>1.3. WASM Pod è°ƒåº¦</h3>
<p>WASM è°ƒåº¦çš„æœ€å°å•å…ƒæ˜¯ Podï¼ŒPod å®šä¹‰ä¸­å¿…é¡»åŒ…å« WASM èŠ‚ç‚¹çš„ tolerationsã€‚</p>
<h4 id=131-pod-è°ƒåº¦>1.3.1. Pod è°ƒåº¦</h4>
<p>ç¤ºä¾‹ Podï¼š</p>
<pre><code class=language-yaml>apiVersion: v1
kind: Pod
metadata:
  name: wasm-hello
spec:
  containers:
    - name: wasm-hello
      image: harbor.domain.dev/bifrost/hello-wasm:v1
  tolerations:
    - key: &quot;kubernetes.io/arch&quot;
      operator: &quot;Equal&quot;
      value: &quot;wasm32-wasi&quot;
      effect: &quot;NoExecute&quot;
    - key: &quot;kubernetes.io/arch&quot;
      operator: &quot;Equal&quot;
      value: &quot;wasm32-wasi&quot;
      effect: &quot;NoSchedule&quot;
</code></pre>
<pre><code class=language-bash>&gt; k apply -f wasm-hello.yaml
pod/wasm-hello created
</code></pre>
<ul>
<li>
<p>å°æ’æ›²</p>
<p>è¯•éªŒè¿‡ç¨‹ä¸­å‘ç°ä½¿ç”¨ wasm-to-oci æ¨é€é•œåƒåˆ°è‡ªå»ºçš„ Harbor é•œåƒä»“åº“åï¼Œæ‹‰å–é•œåƒæ—¶ä¼šæŠ¥é”™ã€‚</p>
<p><a href=https://github.com/deislabs/krustlet/issues/624>Krustlet-tutorial pod get stuck in init:regitered status Â· Issue #624 Â· deislabs/krustlet</a></p>
<p>å…³è”åˆ°ä¸€ä¸ª Issueï¼Œéƒ¨åˆ† Registry ä¼šæ— æ³•æ‹‰å–é•œåƒï¼ŒæŠ¥é”™ï¼š</p>
<pre><code class=language-bash>krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG hyper::proto::h1::conn] incoming body is content-length (950 bytes)
krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG hyper::proto::h1::conn] incoming body completed
krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG hyper::client::pool] pooling idle connection for (&quot;https&quot;, harbor....)
krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG reqwest::async_impl::client] response '200 OK' for https://harbor..../service/token?scope=repository%3Abifrost%2Fhello-wasm%3Apull&amp;service=harbor-registry
krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG oci_distribution::client] Received response from auth request: {&quot;token&quot;:&quot;...&quot;,&quot;access_token&quot;:&quot;&quot;,&quot;expires_in&quot;:1800,&quot;issued_at&quot;:&quot;2021-07-08T08:31:46Z&quot;}
krustlet-wasi[20706]: [2021-07-08T08:31:46Z ERROR kubelet::state::common::image_pull] Failed to decode registry token from auth request
krustlet-wasi[20706]:     
krustlet-wasi[20706]:     Caused by:
krustlet-wasi[20706]:         duplicate field `token` at line 1 column 1129
krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG krator::state] State::status
krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG krator::state] Applying status patch to object. name=wasm-hello patch={&quot;metadata&quot;:{&quot;resourceVersion&quot;:&quot;&quot;},&quot;status&quot;:{&quot;phase&quot;:&quot;Pending&quot;,&quot;message&quot;:&quot;ImagePullBackoff&quot;,&quot;reason&quot;:&quot;ImagePullBackoff&quot;}}
</code></pre>
<p>å°†é•œåƒæ›¿æ¢ä¸º <a href=http://webassembly.azurecr.io/hello-world-wasi-rust:v0.1.0><code>webassembly.azurecr.io/hello-world-wasi-rust:v0.1.0</code></a> å¯æ­£å¸¸è¿è¡Œã€‚</p>
</li>
</ul>
<h4 id=132-pod-è¿è¡Œæ—¶>1.3.2. Pod è¿è¡Œæ—¶</h4>
<p>æŸ¥çœ‹ Pod è¿è¡ŒçŠ¶æ€ï¼š</p>
<pre><code class=language-bash>&gt; k get pod -n ns-msp | grep wasm
wasm-hello        0/1     ExitCode:0         0          13m
</code></pre>
<p>Pod è¢«è°ƒåº¦åç«‹åˆ»è¢«æ‰§è¡Œï¼Œè¿”å› ExitCode 0ã€‚</p>
<pre><code class=language-bash>&gt; k logs -n ns-msp -f wasm-hello 
hello from stdout!
hello from stderr!
Args are: []
</code></pre>
<p>kubectl æŸ¥çœ‹ä¸è¿è¡Œæ—¥å¿—ã€‚</p>
<ul>
<li>
<p>Pod YAML</p>
<pre><code class=language-yaml>apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: &quot;2021-07-08T08:37:39Z&quot;
  name: wasm-hello
  namespace: ns-msp
  resourceVersion: &quot;543645433&quot;
  selfLink: /api/v1/namespaces/ns-msp/pods/wasm-hello
  uid: 09f74071-fd90-45be-be7d-466ef211043a
spec:
  containers:
  - image: webassembly.azurecr.io/hello-world-wasi-rust:v0.1.0
    imagePullPolicy: IfNotPresent
    name: wasm-hello
    resources: {}
    terminationMessagePath: /dev/termination-log
    terminationMessagePolicy: File
    volumeMounts:
    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
      name: default-token-h8q2z
      readOnly: true
  dnsPolicy: ClusterFirst
  enableServiceLinks: true
  nodeName: izuf6cc5ecqwtuhm1p2rcaz
  priority: 0
  restartPolicy: Always
  schedulerName: default-scheduler
  securityContext: {}
  serviceAccount: default
  serviceAccountName: default
  terminationGracePeriodSeconds: 30
  tolerations:
  - effect: NoExecute
    key: kubernetes.io/arch
    operator: Equal
    value: wasm32-wasi
  - effect: NoSchedule
    key: kubernetes.io/arch
    operator: Equal
    value: wasm32-wasi
  - effect: NoExecute
    key: node.kubernetes.io/not-ready
    operator: Exists
    tolerationSeconds: 300
  - effect: NoExecute
    key: node.kubernetes.io/unreachable
    operator: Exists
    tolerationSeconds: 300
  volumes:
  - name: default-token-h8q2z
    secret:
      defaultMode: 420
      secretName: default-token-h8q2z
status:
  conditions:
  - lastProbeTime: null
    lastTransitionTime: &quot;2021-07-08T08:37:39Z&quot;
    status: &quot;True&quot;
    type: PodScheduled
  containerStatuses:
  - image: &quot;&quot;
    imageID: &quot;&quot;
    lastState: {}
    name: wasm-hello
    ready: false
    restartCount: 0
    started: true
    state:
      terminated:
        exitCode: 0
        finishedAt: &quot;2021-07-08T08:37:52Z&quot;
        message: Module run completed
        startedAt: null
  message: Completed
  phase: Succeeded
  qosClass: BestEffort
  reason: Completed
</code></pre>
</li>
</ul>
<h2 id=2-containerd-æ’ä»¶è°ƒåº¦-wasm>2. Containerd æ’ä»¶è°ƒåº¦ WASM</h2>
<blockquote>
<p>containerd-wasm å¯ä»¥è®© containerd æ”¯æŒ WASM containerï¼Œå¹¶ä¸”å¯ä»¥åˆ©ç”¨ Kubernetes é›†ç¾¤ç®¡ç†å’Œè°ƒåº¦ WASM containerã€‚</p>
</blockquote>
<blockquote>
<p>æ³¨ï¼šè¿™ä¸ªé¡¹ç›®æ›´å¤šæ˜¯æ¦‚å¿µéªŒè¯ï¼Œè¿›ç¨‹ç®¡ç†ã€èµ„æºé™åˆ¶ï¼Œæ€§èƒ½ä¼˜åŒ–ç­‰çš„ç»†èŠ‚å¹¶æ²¡æœªå®Œæ•´å®ç°ã€‚</p>
</blockquote>
<p>
<figure class=image>
<img src=/2021/09/k8s-%E9%9B%86%E7%BE%A4%E8%B0%83%E5%BA%A6-wasm-%E5%AE%9E%E9%AA%8C/images/3.png alt loading=lazy>
</figure></p>
<p>â€œcontainer-shim-wasm-v1â€ ä½œä¸º Containerd çš„æ’ä»¶ï¼Œåˆ©ç”¨ wasmer ä½œä¸º WASM åº”ç”¨è¿è¡Œæ—¶ç¯å¢ƒï¼ŒåŒæ—¶å°†å…¶æ³¨å†Œä¸º K8s çš„ä¸€ä¸ª RuntimeClass ï¼Œåˆ©ç”¨ K8s è°ƒåº¦ WASMã€‚</p>
<h3 id=21-éƒ¨ç½²å®‰è£…>2.1. éƒ¨ç½²å®‰è£…</h3>
<blockquote>
<p>ä½¿ç”¨é¡¹ç›®ï¼š<a href=https://github.com/dippynark/containerd-shim-wasm>https://github.com/dippynark/containerd-shim-wasm</a></p>
</blockquote>
<p>éªŒè¯éœ€è¦ä¸€ä¸ªä½¿ç”¨ Containerd çš„ K8s é›†ç¾¤ç¯å¢ƒï¼Œä½¿ç”¨ Kind éƒ¨ç½²é›†ç¾¤ã€‚</p>
<pre><code class=language-yaml>kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraMounts:
  - hostPath: config/containerd.toml
    containerPath: /etc/containerd/config.toml
  - hostPath: bin/containerd-shim-wasm-v1
    containerPath: /usr/local/bin/containerd-shim-wasm-v1
  - hostPath: bin/wasmer
    containerPath: /usr/local/bin/wasmer
</code></pre>
<p>Containerd çš„é…ç½®ä¸­é…ç½® wasm Runtimeï¼š</p>
<pre><code class=language-yaml># Custom configuration
# https://github.com/containerd/cri/blob/master/docs/config.md
[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.wasm]
  runtime_type = &quot;io.containerd.wasm.v1&quot;
</code></pre>
<blockquote>
<p>å‚è€ƒæ–‡ç« ï¼š<a href=https://www.kubernetes.org.cn/7185.html>ç†è§£ RuntimeClass ä¸ä½¿ç”¨å¤šå®¹å™¨è¿è¡Œæ—¶</a></p>
</blockquote>
<p>
<figure class=image>
<img src=/2021/09/k8s-%E9%9B%86%E7%BE%A4%E8%B0%83%E5%BA%A6-wasm-%E5%AE%9E%E9%AA%8C/images/4.png alt loading=lazy>
</figure></p>
<p>Containerd çš„ Runtime ä¼šå¯¹åº”åˆ° K8s çš„ RuntimeClassã€‚</p>
<pre><code class=language-yaml>apiVersion: node.k8s.io/v1beta1
kind: RuntimeClass
metadata:
  name: wasm
handler: wasm
</code></pre>
<p>æ³¨å†Œ K8s RuntimeClass èµ„æºã€‚</p>
<h3 id=22-wasm-runtime-è°ƒåº¦>2.2. WASM Runtime è°ƒåº¦</h3>
<h4 id=221-ç¼–è¯‘-wasm-module>2.2.1. ç¼–è¯‘ WASM Module</h4>
<p>ä½¿ç”¨ target ä¸º <code>wasi/wasm</code> è¿›è¡Œç¼–è¯‘ï¼Œæœ€ç»ˆä¼šä½¿ç”¨ <code>wasm32-wasi-clang</code> è¿›è¡Œç¼–è¯‘ã€‚</p>
<pre><code class=language-docker>FROM --platform=$BUILDPLATFORM tonistiigi/xx:llvm AS builder
ARG TARGETPLATFORM
WORKDIR /src
COPY hello-wasm/main.c .
RUN clang -static -o /hello-wasm main.c

FROM scratch
COPY --from=builder /hello-wasm .
CMD [&quot;/hello-wasm&quot;]
</code></pre>
<p>è™½ç„¶ Dockerfile é‡Œå†™äº† <code>CMD</code> ï¼Œä½†æ˜¯å¦‚æœç›´æ¥åœ¨æ“ä½œç³»ç»Ÿä¸Šæ‰§è¡Œå‘½ä»¤ï¼Œä¼šæŠ¥é”™ï¼š</p>
<pre><code class=language-bash>&gt; ./bin/hello-wasm 
zsh: exec format error: ./bin/hello-wasm
</code></pre>
<p>æ¨æµ‹ <a href=https://github.com/dmcgowan/containerd-wasm><code>github.com/dmcgowan/containerd-wasm</code></a> åº“å®é™…ä¸Šä¼šè§£æ Container æ–‡ä»¶ç³»ç»Ÿï¼Œæå–å‡ºè¦æ‰§è¡Œçš„ WASM moduleï¼Œæœ€åè°ƒç”¨è¿è¡Œæ—¶ï¼ˆwasmtime/wasmerï¼‰è¿è¡Œ WASMã€‚</p>
<p>æˆ‘ä»¬å®é™…ä½¿ç”¨ä»»æ„çš„ WASM module æ‰“åŒ…è¿› Docker å®¹å™¨ä¸­ï¼š</p>
<pre><code class=language-docker>FROM scratch
COPY ./hello.wasm .
CMD [&quot;/hello.wasm&quot;]
</code></pre>
<h4 id=222-è°ƒåº¦-pod>2.2.2. è°ƒåº¦ Pod</h4>
<pre><code class=language-yaml>apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-wasm
spec:
  selector:
    matchLabels:
      app: hello-wasm
  template:
    metadata:
      labels:
        app: hello-wasm
    spec:
      runtimeClassName: wasm
      containers:
      - name: hello-wasm
        ## WASM ç¼–è¯‘æ‰“åŒ…çš„ Docker é•œåƒ
        image: harbor.domain.dev/bifrost/hello-wasm2:v1
        imagePullPolicy: Always
</code></pre>
<p>Pod è¿è¡ŒçŠ¶æ€ï¼š</p>
<pre><code class=language-yaml>default  hello-wasm-86db957848-cgvdj     0/1     Completed     0      7s
</code></pre>
<p>Pod è¾“å‡ºæ—¥å¿—ï¼š</p>
<pre><code class=language-bash>&gt; kubectl logs hello-wasm-86db957848-cgvdj
Hello from WebAssembly!
</code></pre>
<h3 id=23-å¯¹æ¯”-krustlet>2.3. å¯¹æ¯” Krustlet</h3>
<blockquote>
<p>One difficulty with this shim implementation is that the shim API assumes a container runtime (as that&rsquo;s what it was designed for), but this doens&rsquo;t align as well with running WebAssmebly modules (for example currently you can&rsquo;t exec into a WebAssmebly module as you would a container). The Krustlet project implements a Kubelet replacement that treats wasi/wasm modules as first class citizens.</p>
</blockquote>
<p>ä½œä¸º Containerd æ’ä»¶çš„ WASM Runtime å®ç°èµ·æ¥è¾ƒä¸ºç®€å•ï¼ŒåŒæ—¶ä»£ç ä¸­æœ‰å¤§é‡çš„ TODOã€‚</p>
<p>ä½†æ˜¯å‚ç…§å…¶å®ç°çš„æ¨¡å¼ï¼Œå…¬å¸å†…éƒ¨ä¹Ÿå¯è‡ªè¡Œå®è¡Œä¸€å¥— WASM æ¨¡å—åˆ†å‘æœºåˆ¶ï¼Œè¿è¡Œæ—¶åªéœ€åŠ è½½å¯¹åº”æ¨¡å—ï¼Œè°ƒç”¨ï¼ˆwasmtime/wasmerï¼‰è¿è¡Œå³å¯ã€‚</p>
<section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p>Webassembly åœ¨å„ç±»æ–‡ç« ä¸­è¢«æ§ä¸Šå¤©ï¼Œä½†æ˜¯æˆªè‡³ 2021 å¹´å®ƒçš„ä½¿ç”¨åœºæ™¯è¿˜ååˆ†å±€é™ã€‚&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
</ol>
</section>
</div>
<footer class=post-footer>
<div class=post-meta>
<time datetime=" 2021-09-23" itemprop=datePublished>Sep 23, 2021</time>
</div>
<ul class=post-tags aria-label=TagList>
<li><a class=tag-link href=https://shoujo.ink/tags/wasm/>WASM</a></li>
<li><a class=tag-link href=https://shoujo.ink/tags/%E6%A8%A1%E5%9E%8B%E8%AF%95%E9%AA%8C/>æ¨¡å‹è¯•éªŒ</a></li>
</ul>
</footer>
</article>
<script src=https://cdn.jsdelivr.net/npm/tocbot/dist/tocbot.min.js></script>
<aside class=typeface-sans lang=zh-hans>
<nav class=toc></nav>
</aside>
<script>tocbot.init({tocSelector:'.toc',contentSelector:'article',headingSelector:'h1, h2, h3, h4, h5',hasInnerContainers:!0,collapseDepth:"3",positionFixedSelector:".toc",headingsOffset:10})</script>
</div><script src=https://cdn.jsdelivr.net/npm/prismjs@1.24.1/prism.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/prismjs@1.24.1/plugins/filter-highlight-all/prism-filter-highlight-all.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/prismjs@1.24.1/plugins/autoloader/prism-autoloader.min.js></script>
<script>Prism.plugins.filterHighlightAll.add(function(a){return a.language!=="mermaid"})</script>
<script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script>
<script>mermaid.init({startOnLoad:!0},"pre code.language-mermaid",function(){const a=document.querySelectorAll('code.language-mermaid');for(const c of a){c.style.backgroundColor='initial';const b=c.parentNode;b.style.border='none',b.style.textAlign='center',window.darkmode&&!window.darkmode.isActivated()&&(b.style.backgroundColor='initial')}})</script>
</div>
</main><footer class=site-footer>
<div class=wrapper>
<div class=social-links>
<a class="social-link social-github" href=https://github.com/mayocream><svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="currentcolor" d="M12 2A10 10 0 002 12c0 4.42 2.87 8.17 6.84 9.5C9.34 21.58 9.5 21.27 9.5 21 9.5 20.77 9.5 20.14 9.5 19.31 6.73 19.91 6.14 17.97 6.14 17.97c-.46-1.16-1.11-1.47-1.11-1.47C4.12 15.88 5.1 15.9 5.1 15.9 6.1 15.97 6.63 16.93 6.63 16.93 7.5 18.45 8.97 18 9.54 17.76 9.63 17.11 9.89 16.67 10.17 16.42c-2.22-.25-4.55-1.11-4.55-4.92.0-1.11.38-2 1.03-2.71C6.55 8.54 6.2 7.5 6.75 6.15c0 0 .84-.27 2.75 1.02C10.29 6.95 11.15 6.84 12 6.84s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02C17.8 7.5 17.45 8.54 17.35 8.79 18 9.5 18.38 10.39 18.38 11.5c0 3.82-2.34 4.66-4.57 4.91C14.17 16.72 14.5 17.33 14.5 18.26c0 1.34.0 2.42.0 2.74.0.27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0012 2z"/></svg>
</a>
<a class="social-link social-rss" href=/index.xml target=_blank><svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="currentcolor" d="M6.18 15.64a2.18 2.18.0 012.18 2.18C8.36 19 7.38 20 6.18 20 5 20 4 19 4 17.82a2.18 2.18.0 012.18-2.18M4 4.44A15.56 15.56.0 0119.56 20H16.73A12.73 12.73.0 004 7.27V4.44M4 10.1A9.9 9.9.0 0113.9 20H11.07A7.07 7.07.0 004 12.93V10.1z"/></svg>
</a>
</div>
<div class=credits>
Theme KAGAMI by Kamikat
</div>
</div>
</footer><script>(function(a){for(var a=Array.prototype.slice.call(document.getElementsByClassName('baseline-fix')),b=0,c;b!=a.length;b++)c=a[b],c.innerHTML=c.innerHTML.replace(/[\u2000-\u206eâ¸€-\u2e7eâº€-\u2efeâ¼€-\u2fdeâ¿°-\u2ffe\u3000-ã€¾\u3040-ã‚ã‚ -ãƒ¾\u3100-\u312e\u3130-ã†ã†-ã†ã† -\u31beã‡€-\u31eeã‡°-ã‡¾ãˆ€-ã‹¾ãŒ€-ã¾ã€-\u4dbeä¸€-\u9ffe\ua960-\ua97eê°€-\ud7ae\ud7b0-\ud7feï¤€-\ufafeï¸°-ï¹\uff00-ï¿®]|[\ud840-\ud868\ud86a-\ud86c][\udc00-\udfff]|\ud82c[\udc00-\udcfe]|\ud869[\udc00-\udede\udf00-\udfff]|\ud86d[\udc00-\udf3e\udf40-\udfff]|\ud86e[\udc00-\udc1e]|\ud87e[\udc00-\ude1e]/g,function(a){return'<span class="baseline-fix-block">'+a+'<'+'/span>'}),c.classList.remove('baseline-fix')})(Array.prototype.slice.call(document.getElementsByClassName('baseline-fix')))</script>
<script type=text/javascript>const resize=function(){this.width=.5*(this.naturalWidth||this.width)};Array.prototype.forEach.call(document.querySelectorAll('.half-size, .retina2x'),function(a){a.naturalWidth?resize.call(a):a.onload=resize})</script>
<script src=https://cdn.jsdelivr.net/npm/twemoji@13.1.0/dist/twemoji.min.js></script>
<script>twemoji.parse(document.body,{folder:'svg',ext:'.svg'})</script>
</body>