<!doctype html><html lang=ja><head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<title>åœ¨ Kubernetes é›†ç¾¤åˆ¶é€ æ··æ²Œ - Mayo's Blog</title>
<meta name=description content="Chaos Mesh å·¥ä½œåŸç†ä¸æ§åˆ¶å¹³é¢å¼€å‘ Chaos Mesh æ˜¯ç”± TiDB èƒŒåçš„ PingCAP å…¬å¸å¼€å‘ï¼Œè¿è¡Œåœ¨ Kubernetes ä¸Šçš„æ··æ²Œå·¥ç¨‹ï¼ˆChaos Engineeringï¼‰ç³»ç»Ÿã€‚ç®€è€Œè¨€ä¹‹ï¼ŒChaos Mesh é€š">
<meta name=author content>
<link rel=preconnect href=https://cdn.jsdelivr.net>
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css?family=Crimson+Text:400,700|Press+Start+2P" rel=stylesheet>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400&family=Noto+Sans+JP:wght@300;400&family=Noto+Sans+SC:wght@300;400&family=Noto+Serif:wght@300;400&family=Noto+Serif+JP:wght@300;400&family=Noto+Serif+SC:wght@300;400&family=Source+Code+Pro:wght@300;400" rel=stylesheet>
<link rel=stylesheet href="/bundle.css?v=1723627089" media=all>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/tocbot/dist/tocbot.css>
<link rel=icon href=https://github.com/mayocream.png><meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://mayo.rocks/2021/10/%E5%9C%A8-kubernetes-%E9%9B%86%E7%BE%A4%E5%88%B6%E9%80%A0%E6%B7%B7%E6%B2%8C/><meta property="og:title" content="åœ¨ Kubernetes é›†ç¾¤åˆ¶é€ æ··æ²Œ">
<meta property="og:description" content="Chaos Mesh å·¥ä½œåŸç†ä¸æ§åˆ¶å¹³é¢å¼€å‘ Chaos Mesh æ˜¯ç”± TiDB èƒŒåçš„ PingCAP å…¬å¸å¼€å‘ï¼Œè¿è¡Œåœ¨ Kubernetes ä¸Šçš„æ··æ²Œå·¥ç¨‹ï¼ˆChaos Engineeringï¼‰ç³»ç»Ÿã€‚ç®€è€Œè¨€ä¹‹ï¼ŒChaos Mesh é€š">
<meta property="og:type" content="article">
<meta property="og:url" content="https://mayo.rocks/2021/10/%E5%9C%A8-kubernetes-%E9%9B%86%E7%BE%A4%E5%88%B6%E9%80%A0%E6%B7%B7%E6%B2%8C/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-10-21T00:00:00+00:00">
<meta property="article:modified_time" content="2021-10-21T00:00:00+00:00"><meta property="og:site_name" content="Mayo's Blog">
</head>
</html>
<body><script src=https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js></script>
<script>const opts={bottom:'32px',right:'unset',left:'32px',time:'0.3s',mixColor:'#fff',backgroundColor:'#fff',buttonColorDark:'#100f2c',buttonColorLight:'#fff',saveInCookies:!0,label:'ğŸŒ“',autoMatchOsTheme:!0};let darkmode;window.matchMedia('only screen and (min-width: 680px)').matches?(darkmode=new Darkmode(opts),darkmode.showWidget()):(localStorage.removeItem('darkmode'),darkmode=new Darkmode(opts)),window.darkmode=darkmode,document.addEventListener('DOMContentLoaded',function(){document.body.style.opacity=1})</script>
<main class=page-content aria-label=Content>
<div class=wrapper><nav class=site-nav>
<a class=page-link href=/posts/>Posts</a>
<a class=page-link href=/about/>About</a>
</nav><header class=post-header>
<a class=site-title href=https://mayo.rocks>Mayo's Blog</a>
<h1 class="post-title baseline-fix typeface-sans" lang=zh-hans itemprop="name headline">åœ¨ Kubernetes é›†ç¾¤åˆ¶é€ æ··æ²Œ</h1>
</header>
<div class=post-cover aria-label=Cover>
<div class=post-cover-wrapper>
<img src alt>
</div>
<div class=cover-meta></div>
</div>
<div class=post-layout>
<article class="post typeface-sans" lang=zh-hans itemscope itemtype=http://schema.org/BlogPosting>
<div class=post-content itemprop=articleBody>
<p><em>Chaos Mesh å·¥ä½œåŸç†ä¸æ§åˆ¶å¹³é¢å¼€å‘</em></p>
<p>Chaos Mesh æ˜¯ç”± TiDB èƒŒåçš„ PingCAP å…¬å¸å¼€å‘ï¼Œè¿è¡Œåœ¨ Kubernetes ä¸Šçš„æ··æ²Œå·¥ç¨‹ï¼ˆChaos Engineeringï¼‰ç³»ç»Ÿã€‚ç®€è€Œè¨€ä¹‹ï¼ŒChaos Mesh é€šè¿‡è¿è¡Œåœ¨ K8s é›†ç¾¤ä¸­çš„â€œç‰¹æƒâ€å®¹å™¨ï¼Œä¾æ® CRD èµ„æºä¸­çš„æµ‹è¯•åœºæ™¯ï¼Œåœ¨é›†ç¾¤ä¸­åˆ¶é€ æµ‘æ²Œï¼ˆæ¨¡æ‹Ÿæ•…éšœï¼‰<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>ã€‚</p>
<p>æœ¬æ–‡çš„é¦–è¦ç›®çš„æ˜¯è¯•æ¢ Chaos Mesh æ··æ²Œå·¥ç¨‹ç³»ç»Ÿèƒ½å¦æ•´åˆè¿›ä¼ä¸šçš„äº‘å¹³å°ä¸­ã€é€šè¿‡æ€æ ·çš„æ–¹å¼ç»“åˆï¼Œæ‰“é€ ä¸€ä½“åŒ–å¼çš„ä½“éªŒã€‚å¦‚æœä½ ç¼ºä¹åŸºç¡€çŸ¥è¯†ï¼Œè¦æƒ³å¯¹ Chaos Mesh çš„æ¶æ„æœ‰å®è§‚ä¸Šçš„è®¤è¯†ï¼Œè¯·å‚é˜…æ–‡æœ«å°¾æ³¨ä¸­çš„é“¾æ¥ã€‚</p>
<p>æœ¬æ–‡è¯•éªŒä»£ç ä½äº <a href=https://github.com/mayocream/chaos-mesh-controlpanel-demo>mayocream/chaos-mesh-controlpanel-demo</a> ä»“åº“ã€‚</p>
<h2 id=æ€ä¹ˆæ£ä¹±>æ€ä¹ˆæ£ä¹±ï¼Ÿ</h2>
<h3 id=ç‰¹æƒ>ç‰¹æƒ</h3>
<p>ä¸Šé¢æåˆ° Chaos Mesh è¿è¡Œ Kubernetes ç‰¹æƒå®¹å™¨æ¥åˆ¶é€ æ•…éšœã€‚Daemon Set æ–¹å¼è¿è¡Œçš„ Pod æˆæƒäº†å®¹å™¨è¿è¡Œæ—¶çš„<a href=https://kubernetes.io/zh/docs/concepts/policy/pod-security-policy/#capabilities>æƒèƒ½å­—ï¼ˆCapabilitiesï¼‰</a>ã€‚</p>
<pre><code class=language-yaml>apiVersion: apps/v1
kind: DaemonSet
spec:
  template:
    metadata: ...
    spec:
      containers:
        - name: chaos-daemon
          securityContext:
            {{- if .Values.chaosDaemon.privileged }}
            privileged: true
            capabilities:
              add:
                - SYS_PTRACE
            {{- else }}
            capabilities:
              add:
                - SYS_PTRACE
                - NET_ADMIN
                - MKNOD
                - SYS_CHROOT
                - SYS_ADMIN
                - KILL
                # CAP_IPC_LOCK is used to lock memory
                - IPC_LOCK
            {{- end }}
</code></pre>
<p>è¿™äº› Linux æƒèƒ½å­—ç”¨äºæˆäºˆå®¹å™¨ç‰¹æƒï¼Œä»¥åˆ›å»ºå’Œè®¿é—® <code>/dev/fuse</code> FUSE ç®¡é“<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>ï¼ˆFUSE æ˜¯ Linux ç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿæ¥å£ï¼Œå®ƒä½¿æ— ç‰¹æƒçš„ç”¨æˆ·èƒ½å¤Ÿæ— éœ€ç¼–è¾‘å†…æ ¸ä»£ç è€Œåˆ›å»ºè‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿï¼‰ã€‚</p>
<p>å‚é˜… <a href=https://github.com/chaos-mesh/chaos-mesh/pull/1109>#1109</a> Pull Requestï¼ŒDaemon Set ç¨‹åºä½¿ç”¨ CGO è°ƒç”¨ Linux <code>makedev</code> å‡½æ•°åˆ›å»º FUSE ç®¡é“ã€‚</p>
<pre><code class=language-go>// #include &lt;sys/sysmacros.h&gt;
// #include &lt;sys/types.h&gt;
// // makedev is a macro, so a wrapper is needed
// dev_t Makedev(unsigned int maj, unsigned int min) {
//   return makedev(maj, min);
// }

// EnsureFuseDev ensures /dev/fuse exists. If not, it will create one
func EnsureFuseDev() {
	if _, err := os.Open(&quot;/dev/fuse&quot;); os.IsNotExist(err) {
		// 10, 229 according to https://www.kernel.org/doc/Documentation/admin-guide/devices.txt
		fuse := C.Makedev(10, 229)
		syscall.Mknod(&quot;/dev/fuse&quot;, 0o666|syscall.S_IFCHR, int(fuse))
	}
}
</code></pre>
<p>åŒæ—¶åœ¨ <a href=https://github.com/chaos-mesh/chaos-mesh/pull/1453>#1453</a> PR ä¸­ï¼ŒChaos Daemon é»˜è®¤å¯ç”¨ç‰¹æƒæ¨¡å¼ï¼Œå³å®¹å™¨çš„ <code>securityContext</code> ä¸­è®¾ç½® <code>privileged: true</code>ã€‚</p>
<h3 id=æ€æ­»-pod>æ€æ­» Pod</h3>
<p>PodKillã€PodFailureã€ContainerKill éƒ½å½’å±äº PodChaos ç±»åˆ«ä¸‹ï¼ŒPodKill æ˜¯éšæœºæ€æ­» Podã€‚</p>
<p>PodKill çš„å…·ä½“å®ç°å…¶å®æ˜¯é€šè¿‡è°ƒç”¨ API Server å‘é€ Kill å‘½ä»¤ã€‚</p>
<pre><code class=language-go>import (
	&quot;context&quot;

	v1 &quot;k8s.io/api/core/v1&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;
)

type Impl struct {
	client.Client
}

func (impl *Impl) Apply(ctx context.Context, index int, records []*v1alpha1.Record, obj v1alpha1.InnerObject) (v1alpha1.Phase, error) {
	...
	err = impl.Get(ctx, namespacedName, &amp;pod)
	if err != nil {
		// TODO: handle this error
		return v1alpha1.NotInjected, err
	}

	err = impl.Delete(ctx, &amp;pod, &amp;client.DeleteOptions{
		GracePeriodSeconds: &amp;podchaos.Spec.GracePeriod, // PeriodSeconds has to be set specifically
	})
	...
	return v1alpha1.Injected, nil
}
</code></pre>
<p><code>GracePeriodSeconds</code> å‚æ•°é€‚ç”¨äº K8s <a href=https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#pod-termination-forced>å¼ºåˆ¶ç»ˆæ­¢ Pod</a>ã€‚ä¾‹å¦‚åœ¨éœ€è¦å¿«é€Ÿåˆ é™¤ Pod æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>kubectl delete pod --grace-period=0 --force</code> å‘½ä»¤ã€‚</p>
<p>PodFailure æ˜¯é€šè¿‡ Patch Pod å¯¹è±¡èµ„æºï¼Œç”¨é”™è¯¯çš„é•œåƒæ›¿æ¢ Pod ä¸­çš„é•œåƒã€‚Chaos åªä¿®æ”¹äº† <code>containers</code> å’Œ <code>initContainers</code> çš„ <code>image</code> å­—æ®µï¼Œè¿™ä¹Ÿæ˜¯å› ä¸º Pod å¤§éƒ¨åˆ†å­—æ®µæ˜¯æ— æ³•æ›´æ”¹çš„ï¼Œè¯¦æƒ…å¯ä»¥å‚é˜… <a href=https://kubernetes.io/zh/docs/concepts/workloads/pods/#pod-update-and-replacement>Pod æ›´æ–°ä¸æ›¿æ¢</a>ã€‚</p>
<pre><code class=language-go>func (impl *Impl) Apply(ctx context.Context, index int, records []*v1alpha1.Record, obj v1alpha1.InnerObject) (v1alpha1.Phase, error) {
	...
	pod := origin.DeepCopy()
	for index := range pod.Spec.Containers {
		originImage := pod.Spec.Containers[index].Image
		name := pod.Spec.Containers[index].Name

		key := annotation.GenKeyForImage(podchaos, name, false)
		if pod.Annotations == nil {
			pod.Annotations = make(map[string]string)
		}

		// If the annotation is already existed, we could skip the reconcile for this container
		if _, ok := pod.Annotations[key]; ok {
			continue
		}
		pod.Annotations[key] = originImage
		pod.Spec.Containers[index].Image = config.ControllerCfg.PodFailurePauseImage
	}

	for index := range pod.Spec.InitContainers {
		originImage := pod.Spec.InitContainers[index].Image
		name := pod.Spec.InitContainers[index].Name

		key := annotation.GenKeyForImage(podchaos, name, true)
		if pod.Annotations == nil {
			pod.Annotations = make(map[string]string)
		}

		// If the annotation is already existed, we could skip the reconcile for this container
		if _, ok := pod.Annotations[key]; ok {
			continue
		}
		pod.Annotations[key] = originImage
		pod.Spec.InitContainers[index].Image = config.ControllerCfg.PodFailurePauseImage
	}

	err = impl.Patch(ctx, pod, client.MergeFrom(&amp;origin))
	if err != nil {
		// TODO: handle this error
		return v1alpha1.NotInjected, err
	}

	return v1alpha1.Injected, nil
}
</code></pre>
<p>é»˜è®¤ç”¨äºå¼•å‘æ•…éšœçš„å®¹å™¨é•œåƒæ˜¯ <code>gcr.io/google-containers/pause:latest</code>ï¼Œ å¦‚æœåœ¨å›½å†…ç¯å¢ƒä½¿ç”¨ï¼Œå¤§æ¦‚ç‡ä¼šæ°´åœŸä¸æœï¼Œå¯ä»¥å°† <code>gcr.io</code> æ›¿æ¢ä¸º <code>registry.aliyuncs.com</code>ã€‚</p>
<p>ContainerKill ä¸åŒäº PodKill å’Œ PodFailureï¼Œåä¸¤ä¸ªéƒ½æ˜¯é€šè¿‡ K8s API Server æ§åˆ¶ Pod ç”Ÿå‘½å‘¨æœŸï¼Œè€Œ ContainerKill æ˜¯é€šè¿‡è¿è¡Œåœ¨é›†ç¾¤ Node ä¸Šçš„ Chaos Daemon ç¨‹åºæ“ä½œå®Œæˆã€‚å…·ä½“æ¥è¯´ï¼ŒContainerKill é€šè¿‡ Chaos Controller Manager è¿è¡Œå®¢æˆ·ç«¯å‘ Chaos Daemon å‘èµ· grpc è°ƒç”¨ã€‚</p>
<pre><code class=language-go>func (b *ChaosDaemonClientBuilder) Build(ctx context.Context, pod *v1.Pod) (chaosdaemonclient.ChaosDaemonClientInterface, error) {
	...
	daemonIP, err := b.FindDaemonIP(ctx, pod)
	if err != nil {
		return nil, err
	}
	builder := grpcUtils.Builder(daemonIP, config.ControllerCfg.ChaosDaemonPort).WithDefaultTimeout()
	if config.ControllerCfg.TLSConfig.ChaosMeshCACert != &quot;&quot; {
		builder.TLSFromFile(config.ControllerCfg.TLSConfig.ChaosMeshCACert, config.ControllerCfg.TLSConfig.ChaosDaemonClientCert, config.ControllerCfg.TLSConfig.ChaosDaemonClientKey)
	} else {
		builder.Insecure()
	}
	cc, err := builder.Build()
	if err != nil {
		return nil, err
	}
	return chaosdaemonclient.New(cc), nil
}

</code></pre>
<p>å‘ Chaos Daemon å‘é€å‘½ä»¤æ—¶ä¼šä¾æ® Pod ä¿¡æ¯åˆ›å»ºå¯¹åº”çš„å®¢æˆ·ç«¯ï¼Œä¾‹å¦‚è¦æ§åˆ¶æŸä¸ª Node ä¸Šçš„ Podï¼Œä¼šè·å–è¯¥ Pod æ‰€åœ¨ Node çš„ ClusterIPï¼Œä»¥åˆ›å»ºå®¢æˆ·ç«¯ã€‚å¦‚æœ TLS è¯ä¹¦é…ç½®å­˜åœ¨ï¼ŒController Manager ä¼šä¸ºå®¢æˆ·ç«¯æ·»åŠ  TLS è¯ä¹¦ã€‚</p>
<p>Chaos Daemon åœ¨å¯åŠ¨æ—¶å¦‚æœæœ‰ TLS è¯ä¹¦ï¼Œä¼šé™„åŠ è¯ä¹¦ä»¥å¯ç”¨ grpcsã€‚TLS æ ¡éªŒé…ç½® <code>RequireAndVerifyClientCert</code> è¡¨ç¤ºå¯ç”¨åŒå‘ TLS è®¤è¯ï¼ˆmTLSï¼‰ã€‚</p>
<pre><code class=language-go>func newGRPCServer(containerRuntime string, reg prometheus.Registerer, tlsConf tlsConfig) (*grpc.Server, error) {
	...
	if tlsConf != (tlsConfig{}) {
		caCert, err := ioutil.ReadFile(tlsConf.CaCert)
		if err != nil {
			return nil, err
		}
		caCertPool := x509.NewCertPool()
		caCertPool.AppendCertsFromPEM(caCert)

		serverCert, err := tls.LoadX509KeyPair(tlsConf.Cert, tlsConf.Key)
		if err != nil {
			return nil, err
		}

		creds := credentials.NewTLS(&amp;tls.Config{
			Certificates: []tls.Certificate{serverCert},
			ClientCAs:    caCertPool,
			ClientAuth:   tls.RequireAndVerifyClientCert,
		})

		grpcOpts = append(grpcOpts, grpc.Creds(creds))
	}

	s := grpc.NewServer(grpcOpts...)
	grpcMetrics.InitializeMetrics(s)

	pb.RegisterChaosDaemonServer(s, ds)
	reflection.Register(s)

	return s, nil
}
</code></pre>
<p>Chaos Daemon æä¾›äº†ä»¥ä¸‹ grpc è°ƒç”¨æ¥å£ï¼š</p>
<pre><code class=language-go>// ChaosDaemonClient is the client API for ChaosDaemon service.
//
// For semantics around ctx use and closing/ending streaming RPCs, please refer to https://godoc.org/google.golang.org/grpc#ClientConn.NewStream.
type ChaosDaemonClient interface {
	SetTcs(ctx context.Context, in *TcsRequest, opts ...grpc.CallOption) (*empty.Empty, error)
	FlushIPSets(ctx context.Context, in *IPSetsRequest, opts ...grpc.CallOption) (*empty.Empty, error)
	SetIptablesChains(ctx context.Context, in *IptablesChainsRequest, opts ...grpc.CallOption) (*empty.Empty, error)
	SetTimeOffset(ctx context.Context, in *TimeRequest, opts ...grpc.CallOption) (*empty.Empty, error)
	RecoverTimeOffset(ctx context.Context, in *TimeRequest, opts ...grpc.CallOption) (*empty.Empty, error)
	ContainerKill(ctx context.Context, in *ContainerRequest, opts ...grpc.CallOption) (*empty.Empty, error)
	ContainerGetPid(ctx context.Context, in *ContainerRequest, opts ...grpc.CallOption) (*ContainerResponse, error)
	ExecStressors(ctx context.Context, in *ExecStressRequest, opts ...grpc.CallOption) (*ExecStressResponse, error)
	CancelStressors(ctx context.Context, in *CancelStressRequest, opts ...grpc.CallOption) (*empty.Empty, error)
	ApplyIOChaos(ctx context.Context, in *ApplyIOChaosRequest, opts ...grpc.CallOption) (*ApplyIOChaosResponse, error)
	ApplyHttpChaos(ctx context.Context, in *ApplyHttpChaosRequest, opts ...grpc.CallOption) (*ApplyHttpChaosResponse, error)
	SetDNSServer(ctx context.Context, in *SetDNSServerRequest, opts ...grpc.CallOption) (*empty.Empty, error)
}
</code></pre>
<h3 id=ç½‘ç»œæ•…éšœ>ç½‘ç»œæ•…éšœ</h3>
<p>ä»æœ€åˆçš„ <a href=https://github.com/chaos-mesh/chaos-mesh/pull/41>#41</a> PR ä¸­ï¼Œå¯ä»¥æ¸…æ™°åœ°äº†è§£åˆ°ï¼ŒChaos Mesh çš„ç½‘ç»œé”™è¯¯æ³¨å…¥æ˜¯é€šè¿‡è°ƒç”¨ <code>pbClient.SetNetem</code> æ–¹æ³•ï¼Œå°†å‚æ•°å°è£…æˆè¯·æ±‚ï¼Œäº¤ç»™ Node ä¸Šçš„ Chaos Daemon å¤„ç†çš„ã€‚</p>
<p>ï¼ˆæ³¨ï¼šè¿™æ˜¯ 2019 å¹´åˆæœŸçš„ä»£ç ï¼Œéšç€é¡¹ç›®å‘å±•ï¼Œä»£ç ä¸­çš„å‡½æ•°å·²åˆ†æ•£åˆ°ä¸åŒçš„æ–‡ä»¶ä¸­ï¼‰</p>
<pre><code class=language-go>func (r *Reconciler) applyPod(ctx context.Context, pod *v1.Pod, networkchaos *v1alpha1.NetworkChaos) error {
	...
	pbClient := pb.NewChaosDaemonClient(c)

	containerId := pod.Status.ContainerStatuses[0].ContainerID

	netem, err := spec.ToNetem()
	if err != nil {
		return err
	}

	_, err = pbClient.SetNetem(ctx, &amp;pb.NetemRequest{
		ContainerId: containerId,
		Netem:       netem,
	})

	return err
}
</code></pre>
<p>åŒæ—¶åœ¨ <code>pkg/chaosdaemon</code> åŒ…ä¸­ï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ° Chaos Daemon å¤„ç†è¯·æ±‚çš„æ–¹æ³•ã€‚</p>
<pre><code class=language-go>func (s *Server) SetNetem(ctx context.Context, in *pb.NetemRequest) (*empty.Empty, error) {
	log.Info(&quot;Set netem&quot;, &quot;Request&quot;, in)

	pid, err := s.crClient.GetPidFromContainerID(ctx, in.ContainerId)

	if err != nil {
		return nil, status.Errorf(codes.Internal, &quot;get pid from containerID error: %v&quot;, err)
	}

	if err := Apply(in.Netem, pid); err != nil {
		return nil, status.Errorf(codes.Internal, &quot;netem apply error: %v&quot;, err)
	}

	return &amp;empty.Empty{}, nil
}

// Apply applies a netem on eth0 in pid related namespace
func Apply(netem *pb.Netem, pid uint32) error {
	log.Info(&quot;Apply netem on PID&quot;, &quot;pid&quot;, pid)

	ns, err := netns.GetFromPath(GenNetnsPath(pid))
	if err != nil {
		log.Error(err, &quot;failed to find network namespace&quot;, &quot;pid&quot;, pid)
		return errors.Trace(err)
	}
	defer ns.Close()

	handle, err := netlink.NewHandleAt(ns)
	if err != nil {
		log.Error(err, &quot;failed to get handle at network namespace&quot;, &quot;network namespace&quot;, ns)
		return err
	}

	link, err := handle.LinkByName(&quot;eth0&quot;) // TODO: check whether interface name is eth0
	if err != nil {
		log.Error(err, &quot;failed to find eth0 interface&quot;)
		return errors.Trace(err)
	}

	netemQdisc := netlink.NewNetem(netlink.QdiscAttrs{
		LinkIndex: link.Attrs().Index,
		Handle:    netlink.MakeHandle(1, 0),
		Parent:    netlink.HANDLE_ROOT,
	}, ToNetlinkNetemAttrs(netem))

	if err = handle.QdiscAdd(netemQdisc); err != nil {
		if !strings.Contains(err.Error(), &quot;file exists&quot;) {
			log.Error(err, &quot;failed to add Qdisc&quot;)
			return errors.Trace(err)
		}
	}

	return nil
}
</code></pre>
<p>æœ€ç»ˆä½¿ç”¨ <a href=https://github.com/vishvananda/netlink>vishvananda/netlink</a> åº“æ“ä½œ Linux ç½‘ç»œæ¥å£æ¥å®Œæˆå·¥ä½œã€‚</p>
<p>è‡³äºä¸ºä»€ä¹ˆæ²¡æœ‰è¯¦ç»†è¯´æ˜ä½¿ç”¨äº†ä»€ä¹ˆå‘½ä»¤ï¼Œè¿›è¡Œäº†å“ªäº›æ“ä½œï¼Œæ˜¯å› ä¸ºæˆ‘ä¹Ÿä¸ä¼šã€‚å¾…æˆ‘æ¶è¡¥å®Œç½‘ç»œçŸ¥è¯†åå†æ¥å›é¡¾å§ã€‚ä¸è¿‡è¿™é‡Œèƒ½å¤ŸçŸ¥é“ï¼ŒNetworkChaos æ··æ²Œç±»å‹ï¼Œæ“ä½œäº†Linux å®¿ä¸»æœºç½‘ç»œæ¥åˆ¶é€ æ··æ²Œï¼ŒåŒ…å« iptablesã€ipset ç­‰å·¥å…·ã€‚</p>
<p>åœ¨ Chaos Daemon çš„ Dockerfile ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¾èµ–çš„ Linux å·¥å…·é“¾ï¼š</p>
<pre><code class=language-dockerfile>RUN apt-get update &amp;&amp; \
    apt-get install -y tzdata iptables ipset stress-ng iproute2 fuse util-linux procps curl &amp;&amp; \
    rm -rf /var/lib/apt/lists/*
</code></pre>
<h3 id=å‹åŠ›æµ‹è¯•>å‹åŠ›æµ‹è¯•</h3>
<p>StressChaos ç±»å‹çš„æ··æ²Œä¹Ÿæ˜¯ç”± Chaos Daemon å®æ–½çš„ï¼ŒController Manager è®¡ç®—å¥½è§„åˆ™åå°±å°†ä»»åŠ¡ä¸‹å‘åˆ°å…·ä½“çš„ Daemon ä¸Šã€‚æ‹¼è£…çš„å‚æ•°å¦‚ä¸‹ï¼Œè¿™äº›å‚æ•°ä¼šç»„åˆæˆå‘½ä»¤æ‰§è¡Œçš„å‚æ•°ï¼Œé™„åŠ åˆ° <code>stress-ng</code> å‘½ä»¤åæ‰§è¡Œ<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>ã€‚</p>
<pre><code class=language-go>// Normalize the stressors to comply with stress-ng
func (in *Stressors) Normalize() (string, error) {
	stressors := &quot;&quot;
	if in.MemoryStressor != nil &amp;&amp; in.MemoryStressor.Workers != 0 {
		stressors += fmt.Sprintf(&quot; --vm %d --vm-keep&quot;, in.MemoryStressor.Workers)
		if len(in.MemoryStressor.Size) != 0 {
			if in.MemoryStressor.Size[len(in.MemoryStressor.Size)-1] != '%' {
				size, err := units.FromHumanSize(string(in.MemoryStressor.Size))
				if err != nil {
					return &quot;&quot;, err
				}
				stressors += fmt.Sprintf(&quot; --vm-bytes %d&quot;, size)
			} else {
				stressors += fmt.Sprintf(&quot; --vm-bytes %s&quot;,
					in.MemoryStressor.Size)
			}
		}

		if in.MemoryStressor.Options != nil {
			for _, v := range in.MemoryStressor.Options {
				stressors += fmt.Sprintf(&quot; %v &quot;, v)
			}
		}
	}
	if in.CPUStressor != nil &amp;&amp; in.CPUStressor.Workers != 0 {
		stressors += fmt.Sprintf(&quot; --cpu %d&quot;, in.CPUStressor.Workers)
		if in.CPUStressor.Load != nil {
			stressors += fmt.Sprintf(&quot; --cpu-load %d&quot;,
				*in.CPUStressor.Load)
		}

		if in.CPUStressor.Options != nil {
			for _, v := range in.CPUStressor.Options {
				stressors += fmt.Sprintf(&quot; %v &quot;, v)
			}
		}
	}
	return stressors, nil
}
</code></pre>
<p>Chaos Daemon æœåŠ¡ç«¯å¤„ç†å‡½æ•°ä¸­è°ƒç”¨ Go å®˜æ–¹åŒ… <code>os/exec</code> æ‰§è¡Œå‘½ä»¤ï¼Œå†å¤§æ®µè´´ä»£ç å°±æ²¡æœ‰æ„æ€äº†ï¼Œå…·ä½“å¯ä»¥é˜…è¯» <a href=https://github.com/chaos-mesh/chaos-mesh/blob/98af3a0e7832a4971d6b133a32069539d982ef0a/pkg/chaosdaemon/stress_server_linux.go#L33>pkg/chaosdaemon/stress_server_linux.go</a> æ–‡ä»¶ã€‚åŒåæ–‡ä»¶è¿˜æœ‰ä»¥ darwin ç»“å°¾çš„ï¼Œæ¨æµ‹æ˜¯ä¸ºäº†åœ¨ macOS ä¸Šå¼€å‘è°ƒè¯•æ–¹ä¾¿ã€‚</p>
<p>æ—¢ç„¶éƒ½åšäº†å…¼å®¹ï¼Œé‚£ä¸ºä»€ä¹ˆæ²¡æœ‰ windows ç‰ˆæœ¬çš„ï¼Œæ°”å†·æŠ–ï¼ˆä¸è¿‡æˆ‘ä¹Ÿä¸ç”¨ Windows è¿›è¡Œå¼€å‘è°ƒè¯•ï¼‰ã€‚</p>
<p>ä»£ç ä¸­ä½¿ç”¨ <a href=https://github.com/shirou/gopsutil>shirou/gopsutil</a> åŒ…è·å– PID è¿›ç¨‹çŠ¶æ€ï¼Œå¹¶è¯»å–äº† stdoutã€stderr ç­‰æ ‡å‡†è¾“å‡ºï¼Œè¿™ç§å¤„ç†æ¨¡å¼æˆ‘åœ¨ <a href=https://github.com/hashicorp/go-plugin>hashicorp/go-plugin</a> è§è¿‡ï¼Œgo-plugin åœ¨è¿™æ–¹é¢åšå¾—æ›´åŠ ä¼˜ç§€ã€‚æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç«  <a href=https://shoujo.ink/2021/09/dkron-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/>Dkron æºç åˆ†æ</a> ä¸­æåˆ°äº†å®ƒã€‚</p>
<h3 id=io-æ³¨å…¥>IO æ³¨å…¥</h3>
<p>å¼€ç¯‡å°±æåˆ°äº† Chaos Mesh ä½¿ç”¨äº†ç‰¹æƒå®¹å™¨ï¼Œç”¨äºæŒ‚è½½å®¿ä¸»æœºä¸Šçš„ FUSE è®¾å¤‡ <code>/dev/fuse</code>ã€‚</p>
<p>çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘é“å®šä»¥ä¸º Chaos Mesh æ˜¯ä½¿ç”¨ <a href=https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#mutatingadmissionwebhook>Mutating å‡†å…¥æ§åˆ¶å™¨</a>è¿›è¡Œ Sidecar å®¹å™¨çš„æ³¨å…¥ï¼ŒæŒ‚è½½ FUSE è®¾å¤‡ï¼Œæˆ–ä¿®æ”¹ Pod Volumes Mount ç­‰é…ç½®ï¼Œç„¶åå®ƒçš„å®ç°æ–¹å¼ä¸ç›´è§‚ä¸Šä¸åŒã€‚</p>
<p>ä»”ç»†çœ‹äº† <a href=https://github.com/chaos-mesh/chaos-mesh/pull/826>#826</a> PRï¼Œè¿™ä¸ª PR å¼•å…¥äº†æ–°çš„ IOChaos çš„å®ç°ï¼Œé¿å…ä½¿ç”¨ Sidecar æ³¨å…¥çš„æ–¹å¼ï¼Œè€Œé‡‡ç”¨ Chaos Daemon ç›´æ¥é€šè¿‡ runc å®¹å™¨åº•å±‚å‘½ä»¤æ“ä½œ Linux å‘½åç©ºé—´ï¼Œè¿è¡Œç”¨ Rust å¼€å‘çš„ <a href=https://github.com/chaos-mesh/toda>chaos-mesh/toda</a> FUSE ç¨‹åºï¼ˆä½¿ç”¨ <a href=https://pkg.go.dev/github.com/ethereum/go-ethereum/rpc>JSON-RPC 2.0</a> åè®®é€šä¿¡ï¼‰è¿›è¡Œå®¹å™¨ IO æ··æ²Œæ³¨å…¥ã€‚</p>
<p>å…³æ³¨æ–°çš„ IOChaos å®ç°ï¼Œå®ƒä¸ä¼šä¿®æ”¹ Pod èµ„æºï¼ŒIOChaos æ··æ²Œå®éªŒå®šä¹‰è¢«åˆ›å»ºæ—¶ï¼Œé’ˆå¯¹é€‰æ‹©å™¨ï¼ˆselector å­—æ®µï¼‰ç­›é€‰å‡ºçš„æ¯ä¸€ä¸ª Podï¼Œå¯¹åº”çš„ä¸€ä¸ª PodIoChaos èµ„æºä¼šè¢«åˆ›å»ºï¼ŒPodIoChaos çš„<a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/owners-dependents/>å±ä¸»å¼•ç”¨ï¼ˆOwner Referenceï¼‰</a>ä¸ºè¯¥ Podã€‚PodIoChaos åŒæ—¶ä¼šè¢«æ·»åŠ ä¸Šä¸€ç»„ <a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/finalizers/>Finalizers</a>ï¼Œç”¨äºåœ¨è¢«åˆ é™¤å‰é‡Šæ”¾ PodIoChaos èµ„æºã€‚</p>
<pre><code class=language-go>// Apply implements the reconciler.InnerReconciler.Apply
func (r *Reconciler) Apply(ctx context.Context, req ctrl.Request, chaos v1alpha1.InnerObject) error {
	iochaos, ok := chaos.(*v1alpha1.IoChaos)
	if !ok {
		err := errors.New(&quot;chaos is not IoChaos&quot;)
		r.Log.Error(err, &quot;chaos is not IoChaos&quot;, &quot;chaos&quot;, chaos)
		return err
	}

	source := iochaos.Namespace + &quot;/&quot; + iochaos.Name
	m := podiochaosmanager.New(source, r.Log, r.Client)

	pods, err := utils.SelectAndFilterPods(ctx, r.Client, r.Reader, &amp;iochaos.Spec)
	if err != nil {
		r.Log.Error(err, &quot;failed to select and filter pods&quot;)
		return err
	}

	r.Log.Info(&quot;applying iochaos&quot;, &quot;iochaos&quot;, iochaos)

	for _, pod := range pods {
		t := m.WithInit(types.NamespacedName{
			Name:      pod.Name,
			Namespace: pod.Namespace,
		})

		// TODO: support chaos on multiple volume
		t.SetVolumePath(iochaos.Spec.VolumePath)
		t.Append(v1alpha1.IoChaosAction{
			Type: iochaos.Spec.Action,
			Filter: v1alpha1.Filter{
				Path:    iochaos.Spec.Path,
				Percent: iochaos.Spec.Percent,
				Methods: iochaos.Spec.Methods,
			},
			Faults: []v1alpha1.IoFault{
				{
					Errno:  iochaos.Spec.Errno,
					Weight: 1,
				},
			},
			Latency:          iochaos.Spec.Delay,
			AttrOverrideSpec: iochaos.Spec.Attr,
			Source:           m.Source,
		})

		key, err := cache.MetaNamespaceKeyFunc(&amp;pod)
		if err != nil {
			return err
		}
		iochaos.Finalizers = utils.InsertFinalizer(iochaos.Finalizers, key)
	}
	r.Log.Info(&quot;commiting updates of podiochaos&quot;)
	err = m.Commit(ctx)
	if err != nil {
		r.Log.Error(err, &quot;fail to commit&quot;)
		return err
	}
	r.Event(iochaos, v1.EventTypeNormal, utils.EventChaosInjected, &quot;&quot;)

	return nil
}
</code></pre>
<p>åœ¨ PodIoChaos èµ„æºçš„æ§åˆ¶å™¨ä¸­ï¼ŒController Manager ä¼šå°†èµ„æºå°è£…æˆå‚æ•°ï¼Œè°ƒç”¨ Chaos Daemon æ¥å£è¿›è¡Œå®é™…å¤„ç†ã€‚</p>
<pre><code class=language-go>// Apply flushes io configuration on pod
func (h *Handler) Apply(ctx context.Context, chaos *v1alpha1.PodIoChaos) error {
	h.Log.Info(&quot;updating io chaos&quot;, &quot;pod&quot;, chaos.Namespace+&quot;/&quot;+chaos.Name, &quot;spec&quot;, chaos.Spec)
    ...
	res, err := pbClient.ApplyIoChaos(ctx, &amp;pb.ApplyIoChaosRequest{
		Actions:     input,
		Volume:      chaos.Spec.VolumeMountPath,
		ContainerId: containerID,

		Instance:  chaos.Spec.Pid,
		StartTime: chaos.Spec.StartTime,
	})
	if err != nil {
		return err
	}

	chaos.Spec.Pid = res.Instance
	chaos.Spec.StartTime = res.StartTime
	chaos.OwnerReferences = []metav1.OwnerReference{
		{
			APIVersion: pod.APIVersion,
			Kind:       pod.Kind,
			Name:       pod.Name,
			UID:        pod.UID,
		},
	}

	return nil
}
</code></pre>
<p>åœ¨ Chaos Daemon ä¸­å¤„ç† IOChaos çš„ä»£ç æ–‡ä»¶ <code>pkg/chaosdaemon/iochaos_server.go</code> ä¸­ï¼Œå®¹å™¨éœ€è¦è¢«æ³¨å…¥ä¸€ä¸ª FUSE ç¨‹åºï¼Œé€šè¿‡ <a href=https://github.com/chaos-mesh/chaos-mesh/issues/2305>#2305</a> Issueï¼Œå¯ä»¥äº†è§£åˆ°æ‰§è¡Œäº† <code>/usr/local/bin/nsexec -l -p /proc/119186/ns/pid -m /proc/119186/ns/mnt -- /usr/local/bin/toda --path /tmp --verbose info</code> å‘½ä»¤ï¼Œä»¥åœ¨ç‰¹å®šçš„ Linux å‘½åç©ºé—´ï¼ˆNamespaceï¼‰ä¸‹è¿è¡Œ toda ç¨‹åºï¼Œå³ä¸ Pod åœ¨åŒä¸€ä¸ªå‘½åç©ºé—´ä¸‹ã€‚</p>
<pre><code class=language-go>func (s *DaemonServer) ApplyIOChaos(ctx context.Context, in *pb.ApplyIOChaosRequest) (*pb.ApplyIOChaosResponse, error) {
	...
	pid, err := s.crClient.GetPidFromContainerID(ctx, in.ContainerId)
	if err != nil {
		log.Error(err, &quot;error while getting PID&quot;)
		return nil, err
	}

	args := fmt.Sprintf(&quot;--path %s --verbose info&quot;, in.Volume)
	log.Info(&quot;executing&quot;, &quot;cmd&quot;, todaBin+&quot; &quot;+args)

	processBuilder := bpm.DefaultProcessBuilder(todaBin, strings.Split(args, &quot; &quot;)...).
		EnableLocalMnt().
		SetIdentifier(in.ContainerId)

	if in.EnterNS {
		processBuilder = processBuilder.SetNS(pid, bpm.MountNS).SetNS(pid, bpm.PidNS)
	}

    ...
    // JSON RPC è°ƒç”¨
	client, err := jrpc.DialIO(ctx, receiver, caller)
	if err != nil {
		return nil, err
	}

	cmd := processBuilder.Build()
    procState, err := s.backgroundProcessManager.StartProcess(cmd)
	if err != nil {
		return nil, err
	}
	...
}
</code></pre>
<p>ä¸‹é¢è¿™æ®µä»£ç æœ€ç»ˆæ„å»ºäº†è¿è¡Œçš„å‘½ä»¤ï¼Œè€Œè¿™äº›å‘½ä»¤æ­£æ˜¯ <a href=https://github.com/opencontainers/runc>runc</a> åº•å±‚çš„ Namespace éš”ç¦»å®ç°<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>ï¼š</p>
<pre><code class=language-go>// GetNsPath returns corresponding namespace path
func GetNsPath(pid uint32, typ NsType) string {
	return fmt.Sprintf(&quot;%s/%d/ns/%s&quot;, DefaultProcPrefix, pid, string(typ))
}

// SetNS sets the namespace of the process
func (b *ProcessBuilder) SetNS(pid uint32, typ NsType) *ProcessBuilder {
	return b.SetNSOpt([]nsOption{{
		Typ:  typ,
		Path: GetNsPath(pid, typ),
	}})
}

// Build builds the process
func (b *ProcessBuilder) Build() *ManagedProcess {
	args := b.args
	cmd := b.cmd

	if len(b.nsOptions) &gt; 0 {
		args = append([]string{&quot;--&quot;, cmd}, args...)
		for _, option := range b.nsOptions {
			args = append([]string{&quot;-&quot; + nsArgMap[option.Typ], option.Path}, args...)
		}

		if b.localMnt {
			args = append([]string{&quot;-l&quot;}, args...)
		}
		cmd = nsexecPath
	}
    ...
}
</code></pre>
<h2 id=æ§åˆ¶å¹³é¢>æ§åˆ¶å¹³é¢</h2>
<p>Chaos Mesh æ˜¯ä¸€ä¸ªå¼€æºçš„æ··æ²Œå·¥ç¨‹ç³»ç»Ÿï¼Œä»¥ Apache 2.0 åè®®å¼€æºï¼Œç»è¿‡ä»¥ä¸Šåˆ†æçŸ¥é“å®ƒçš„èƒ½åŠ›ä¸°å¯Œï¼Œå¹¶ä¸”å®ƒçš„ç”Ÿæ€è‰¯å¥½ï¼Œç»´æŠ¤å›¢é˜Ÿå›´ç»•æ··æ²Œç³»ç»Ÿç ”å‘äº†ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿï¼ˆFUSEï¼‰<a href=https://github.com/chaos-mesh/toda>chaos-mesh/toda</a> ã€CoreDNS æ··æ²Œæ’ä»¶ <a href=https://github.com/chaos-mesh/k8s_dns_chaos>chaos-mesh/k8s_dns_chaos</a>ã€åŸºäº BPF çš„å†…æ ¸é”™è¯¯æ³¨å…¥ <a href=https://github.com/chaos-mesh/bpfki>chaos-mesh/bpfki</a> ç­‰ã€‚å¦‚æœèƒ½å¤Ÿå°†è¿™ä¸€å¥—æ··æ²Œå·¥ç¨‹ç³»ç»Ÿå¼•å…¥ä¼ä¸šå†…éƒ¨ï¼Œæƒ³å¿…é‚£æ˜¯éå¸¸å¥½å§ã€‚</p>
<p>ä¸‹è¿°å¦‚æœæˆ‘æƒ³è¦å»ºç«‹ä¸€ä¸ªé¢å‘ç»ˆç«¯ç”¨æˆ·çš„æ··æ²Œå·¥ç¨‹å¹³å°ï¼Œåœ¨æœåŠ¡ç«¯å®ç°çš„ä»£ç åº”è¯¥æ˜¯æ€æ ·çš„ã€‚ç¤ºä¾‹ä»…ä¸ºä¸€ç§å®è·µï¼Œå¹¶ä¸ä»£è¡¨æœ€ä½³å®è·µï¼Œå¦‚æœæƒ³çœ‹ Real World å¹³å°çš„å¼€å‘å®è·µçš„è¯ï¼Œå¯ä»¥å‚è€ƒ Chaos Mesh å®˜æ–¹çš„ <a href=https://github.com/chaos-mesh/chaos-mesh/tree/master/pkg/dashboard>Dashboard</a>ï¼Œå†…éƒ¨ä½¿ç”¨äº† <a href=https://github.com/uber-go/fx>uber-go/fx</a> ä¾èµ–æ³¨å…¥æ¡†æ¶å’Œ controller runtime çš„ manager æ¨¡å¼ã€‚</p>
<h3 id=è¦åšä»€ä¹ˆ>è¦åšä»€ä¹ˆï¼Ÿ</h3>
<p>
<figure class=image>
<img src=/2021/10/%E5%9C%A8-kubernetes-%E9%9B%86%E7%BE%A4%E5%88%B6%E9%80%A0%E6%B7%B7%E6%B2%8C/images/4_d0e6bfad2a.png alt="Chaos Mesh çš„åŸºæœ¬å·¥ä½œæµåŸç†å›¾" loading=lazy>
<figcaption>Chaos Mesh çš„åŸºæœ¬å·¥ä½œæµåŸç†å›¾</figcaption>
</figure></p>
<p>è¿™é‡Œæ ‡é¢˜è™½æ˜¯æ§åˆ¶å¹³é¢ï¼Œä½†æŸ¥çœ‹ä¸Šè¿° Chaos Mesh å·¥ä½œæµç¨‹å›¾ï¼Œå…¶å®æˆ‘ä»¬éœ€è¦åšçš„åªæ˜¯å®ç°ä¸€ä¸ªå°† YAML ä¸‹å‘åˆ° Kubernetes API çš„æœåŠ¡å™¨ï¼Œå¤æ‚çš„è§„åˆ™æ ¡éªŒã€è§„åˆ™ä¸‹å‘åˆ° Chaos Daemon çš„è¡Œä¸ºæ˜¯ç”± Chaos Controller Manager å®Œæˆçš„ã€‚æƒ³è¦ç»“åˆè‡ªå·±çš„å¹³å°ä½¿ç”¨ï¼Œåªéœ€è¦å¯¹æ¥ CRD èµ„æºåˆ›å»ºçš„è¿‡ç¨‹å°±è¶³å¤Ÿäº†ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ PingCAP å®˜æ–¹ç»™å‡ºçš„ç¤ºä¾‹ï¼š</p>
<pre><code class=language-go>import (
    &quot;context&quot;

    &quot;github.com/pingcap/chaos-mesh/api/v1alpha1&quot;
    &quot;sigs.k8s.io/controller-runtime/pkg/client&quot;
)

func main() {
    ...
    delay := &amp;chaosv1alpha1.NetworkChaos{
        Spec: chaosv1alpha1.NetworkChaosSpec{...},
    }
    k8sClient := client.New(conf, client.Options{ Scheme: scheme.Scheme })
    k8sClient.Create(context.TODO(), delay)
    k8sClient.Delete(context.TODO(), delay)
}
</code></pre>
<p>Chaos Mesh å·²ç»æä¾›äº†æ‰€æœ‰çš„ CRD èµ„æºå®šä¹‰å¯¹åº”çš„ APIï¼Œæˆ‘ä»¬ä½¿ç”¨ Kubernetes <a href=https://github.com/kubernetes/community/tree/master/sig-api-machinery>API Machinery SIG</a> å¼€å‘çš„ <a href=https://github.com/kubernetes-sigs/controller-runtime>controller-runtime</a> æ¥ç®€åŒ–ä¸ Kubernetes API çš„äº¤äº’ã€‚</p>
<h3 id=å®æ–½æ··æ²Œ>å®æ–½æ··æ²Œ</h3>
<p>ä¾‹å¦‚æˆ‘ä»¬æƒ³é€šè¿‡ç¨‹åºè°ƒç”¨çš„æ–¹å¼ï¼Œåˆ›å»ºä¸€ä¸ª PodKill èµ„æºï¼Œè¯¥èµ„æºè¢«å‘é€åˆ° Kubernetes API Server åï¼Œä¼šç»ç”± Chaos Controller Manager çš„ <a href=https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#validatingadmissionwebhook/>Validating å‡†å…¥æ§åˆ¶å™¨</a>ï¼Œè¿›è¡Œæ•°æ®æ ¡éªŒï¼Œè‹¥æ•°æ®æ ¼å¼éªŒè¯å¤±è´¥ï¼Œä¼šåœ¨åˆ›å»ºæ—¶è¿”å›é”™è¯¯ã€‚å…·ä½“å‚æ•°å¯ä»¥æŸ¥é˜…å®˜æ–¹æ–‡æ¡£<a href=https://chaos-mesh.org/zh/docs/simulate-pod-chaos-on-kubernetes/#%E4%BD%BF%E7%94%A8-yaml-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E5%AE%9E%E9%AA%8C>ä½¿ç”¨ YAML é…ç½®æ–‡ä»¶åˆ›å»ºå®éªŒ</a>ã€‚</p>
<p><code>NewClient</code> åˆ›å»ºäº†ä¸€ä¸ª K8s API Clientï¼Œå¯ä»¥å‚è€ƒ<a href=https://pkg.go.dev/sigs.k8s.io/controller-runtime@v0.10.2/pkg/client#example-New>å®¢æˆ·ç«¯åˆ›å»ºç¤ºä¾‹</a>ã€‚</p>
<pre><code class=language-go>package main

import (
	&quot;context&quot;
	&quot;controlpanel&quot;
	&quot;log&quot;

	&quot;github.com/chaos-mesh/chaos-mesh/api/v1alpha1&quot;
	&quot;github.com/pkg/errors&quot;
	metav1 &quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;
)

func applyPodKill(name, namespace string, labels map[string]string) error {
	cli, err := controlpanel.NewClient()
	if err != nil {
		return errors.Wrap(err, &quot;create client&quot;)
	}

	cr := &amp;v1alpha1.PodChaos{
		ObjectMeta: metav1.ObjectMeta{
			GenerateName: name,
			Namespace:    namespace,
		},
		Spec: v1alpha1.PodChaosSpec{
			Action: v1alpha1.PodKillAction,
			ContainerSelector: v1alpha1.ContainerSelector{
				PodSelector: v1alpha1.PodSelector{
					Mode: v1alpha1.OnePodMode,
					Selector: v1alpha1.PodSelectorSpec{
						Namespaces:     []string{namespace},
						LabelSelectors: labels,
					},
				},
			},
		},
	}

	if err := cli.Create(context.Background(), cr); err != nil {
		return errors.Wrap(err, &quot;create podkill&quot;)
	}

	return nil
}
</code></pre>
<p>è¿è¡Œç¨‹åºçš„æ—¥å¿—è¾“å‡ºä¸ºï¼š</p>
<pre><code class=language-bash>I1021 00:51:55.225502   23781 request.go:665] Waited for 1.033116256s due to client-side throttling, not priority and fairness, request: GET:https://***
2021/10/21 00:51:56 apply podkill
</code></pre>
<p>é€šè¿‡ kubectl æŸ¥çœ‹ PodKill èµ„æºçš„çŠ¶æ€ï¼š</p>
<pre><code class=language-bash>$ k describe podchaos.chaos-mesh.org -n dev podkillvjn77
Name:         podkillvjn77
Namespace:    dev
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
API Version:  chaos-mesh.org/v1alpha1
Kind:         PodChaos
Metadata:
  Creation Timestamp:  2021-10-20T16:51:56Z
  Finalizers:
    chaos-mesh/records
  Generate Name:     podkill
  Generation:        7
  Resource Version:  938921488
  Self Link:         /apis/chaos-mesh.org/v1alpha1/namespaces/dev/podchaos/podkillvjn77
  UID:               afbb40b3-ade8-48ba-89db-04918d89fd0b
Spec:
  Action:        pod-kill
  Grace Period:  0
  Mode:          one
  Selector:
    Label Selectors:
      app:  nginx
    Namespaces:
      dev
Status:
  Conditions:
    Reason:
    Status:  False
    Type:    Paused
    Reason:
    Status:  True
    Type:    Selected
    Reason:
    Status:  True
    Type:    AllInjected
    Reason:
    Status:  False
    Type:    AllRecovered
  Experiment:
    Container Records:
      Id:            dev/nginx
      Phase:         Injected
      Selector Key:  .
    Desired Phase:   Run
Events:
  Type    Reason           Age    From          Message
  ----    ------           ----   ----          -------
  Normal  FinalizerInited  6m35s  finalizer     Finalizer has been inited
  Normal  Updated          6m35s  finalizer     Successfully update finalizer of resource
  Normal  Updated          6m35s  records       Successfully update records of resource
  Normal  Updated          6m35s  desiredphase  Successfully update desiredPhase of resource
  Normal  Applied          6m35s  records       Successfully apply chaos for dev/nginx
  Normal  Updated          6m35s  records       Successfully update records of resource
</code></pre>
<p>æ§åˆ¶é¢è¿˜è‡ªç„¶è€Œç„¶è¦æœ‰æŸ¥è¯¢å’Œè·å– Chaos èµ„æºçš„åŠŸèƒ½ï¼Œæ–¹ä¾¿å¹³å°ç”¨æˆ·æŸ¥çœ‹åˆ°æ‰€æœ‰çš„æ··æ²Œè¯•éªŒçš„å®æ–½çŠ¶æ€ï¼Œå¯¹å…¶è¿›è¡Œç®¡ç†ã€‚å½“ç„¶ï¼Œè¿™é‡Œæ— éæ˜¯è°ƒç”¨ REST API å‘é€ Get/List è¯·æ±‚ï¼Œä½†åœ¨å®è·µä¸Šç»†èŠ‚éœ€è¦ç•™æ„ï¼Œæ•å¸å°±å‘ç”Ÿè¿‡ Controller æ¯æ¬¡è¯·æ±‚å…¨é‡çš„èµ„æºæ•°æ®ï¼Œé€ æˆ K8s API Server çš„è´Ÿè½½å¢é«˜ã€‚</p>
<p>è¿™é‡Œååˆ†æ¨èé˜…è¯» <a href=https://zoetrope.github.io/kubebuilder-training/controller-runtime/client.html>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½¿ã„æ–¹</a>ï¼Œè¿™ç¯‡ controller runtime ä½¿ç”¨æ•™ç¨‹ï¼Œæåˆ°äº†å¾ˆç»†èŠ‚çš„åœ°æ–¹ã€‚ä¾‹å¦‚ controller runtime é»˜è®¤ä¼šä»å¤šä¸ªä½ç½®è¯»å– kubeconfigï¼Œflagã€ç¯å¢ƒå˜é‡ã€å†æ˜¯è‡ªåŠ¨æŒ‚è½½åœ¨ Pod ä¸­çš„ Service Accountï¼Œ<a href=https://github.com/armosec/kubescape>armosec/kubescape</a> <a href=https://github.com/armosec/kubescape/pull/21>#21</a> PR ä¹Ÿæ˜¯åˆ©ç”¨äº†è¯¥ç‰¹æ€§ã€‚è¿™ç¯‡æ•™ç¨‹è¿˜åŒ…æ‹¬äº†å¦‚ä½•åˆ†é¡µã€æ›´æ–°ã€è¦†ç›–å¯¹è±¡ç­‰å¸¸ç”¨çš„æ“ä½œï¼Œæˆ‘ç›®å‰è¿˜æ²¡æœ‰çœ‹åˆ°æœ‰å“ªç¯‡ä¸­æ–‡ã€è‹±æ–‡æ•™ç¨‹æœ‰è¿™ä¹ˆè¯¦ç»†ã€‚</p>
<p>Get/List è¯·æ±‚ç¤ºä¾‹ï¼š</p>
<pre><code class=language-go>package controlpanel

import (
	&quot;context&quot;

	&quot;github.com/chaos-mesh/chaos-mesh/api/v1alpha1&quot;
	&quot;github.com/pkg/errors&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;
)

func GetPodChaos(name, namespace string) (*v1alpha1.PodChaos, error) {
	cli := mgr.GetClient()

	item := new(v1alpha1.PodChaos)
	if err := cli.Get(context.Background(), client.ObjectKey{Name: name, Namespace: namespace}, item); err != nil {
		return nil, errors.Wrap(err, &quot;get cr&quot;)
	}

	return item, nil
}

func ListPodChaos(namespace string, labels map[string]string) ([]v1alpha1.PodChaos, error) {
	cli := mgr.GetClient()

	list := new(v1alpha1.PodChaosList)
	if err := cli.List(context.Background(), list, client.InNamespace(namespace), client.MatchingLabels(labels)); err != nil {
		return nil, err
	}

	return list.Items, nil
}
</code></pre>
<p>ç¤ºä¾‹ä¸­ä½¿ç”¨äº† managerï¼Œè¯¥æ¨¡å¼ä¸‹ä¼šå¯ç”¨ cache æœºåˆ¶ï¼Œé¿å…é‡å¤è·å–å¤§é‡æ•°æ®ã€‚</p>
<p>
<figure class=image>
<img src=/2021/10/%E5%9C%A8-kubernetes-%E9%9B%86%E7%BE%A4%E5%88%B6%E9%80%A0%E6%B7%B7%E6%B2%8C/images/cache.png alt loading=lazy>
</figure></p>
<ol>
<li>è·å– Pod</li>
<li>åˆæ¬¡è·å–å…¨é‡æ•°æ®ï¼ˆListï¼‰</li>
<li>Watch æ•°æ®å˜åŒ–æ—¶æ›´æ–°ç¼“å­˜</li>
</ol>
<h3 id=æ··æ²Œç¼–æ’>æ··æ²Œç¼–æ’</h3>
<p>å°±å¦‚åŒ CRI å®¹å™¨è¿è¡Œæ—¶æä¾›äº†å¼ºå¤§çš„åº•å±‚éš”ç¦»èƒ½åŠ›ï¼Œèƒ½å¤Ÿæ”¯æ’‘å®¹å™¨çš„ç¨³å®šè¿è¡Œï¼Œè€Œæƒ³è¦æ›´å¤§è§„æ¨¡ã€æ›´å¤æ‚çš„åœºæ™¯å°±éœ€è¦å®¹å™¨ç¼–æ’ä¸€æ ·ï¼ŒChaos Mesh æä¾›äº† Schedule å’Œ Workflow åŠŸèƒ½ã€‚<a href=https://chaos-mesh.org/zh/docs/define-scheduling-rules/>Schedule</a> èƒ½å¤Ÿæ ¹æ®è®¾å®šçš„ Cron æ—¶é—´å®šæ—¶ã€é—´éš”åœ°è§¦å‘æ•…éšœï¼Œ<a href=https://chaos-mesh.org/zh/docs/create-chaos-mesh-workflow/>Workflow</a> èƒ½åƒ Argo Workflow ä¸€æ ·ç¼–æ’å¤šä¸ªæ•…éšœè¯•éªŒã€‚</p>
<p>å½“ç„¶ï¼ŒChaos Controller Manager æ›¿æˆ‘ä»¬åšäº†å¤§éƒ¨åˆ†å·¥ä½œï¼Œæ§åˆ¶é¢æ‰€éœ€è¦çš„è¿˜æ˜¯ç®¡ç†è¿™äº› YAML èµ„æºï¼Œå”¯ä¸€éœ€è¦è€ƒè™‘çš„æ˜¯è¦ç»™ç”¨æˆ·æä¾›æ€æ ·çš„åŠŸèƒ½ã€‚</p>
<h3 id=å¹³å°åŠŸèƒ½>å¹³å°åŠŸèƒ½</h3>
<p>å‚è€ƒ Chaos Mesh Dashboardï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘å¹³å°è¯¥æä¾›å“ªäº›åŠŸèƒ½ç»™ç»ˆç«¯ç”¨æˆ·ã€‚</p>
<p>
<figure class=image>
<img src=/2021/10/%E5%9C%A8-kubernetes-%E9%9B%86%E7%BE%A4%E5%88%B6%E9%80%A0%E6%B7%B7%E6%B2%8C/images/image-20211021030337926-16347566199512.png alt loading=lazy>
</figure></p>
<p>å¯èƒ½çš„å¹³å°åŠŸèƒ½ç‚¹ï¼š</p>
<ul>
<li>æ··æ²Œæ³¨å…¥
<ul>
<li>Pod å´©æºƒ</li>
<li>ç½‘ç»œæ•…éšœ</li>
<li>è´Ÿè½½æµ‹è¯•</li>
<li>IO æ•…éšœ</li>
</ul>
</li>
<li>äº‹ä»¶è·Ÿè¸ª</li>
<li>å…³è”å‘Šè­¦</li>
<li>æ—¶åºé¥æµ‹</li>
</ul>
<h2 id=å‚é˜…èµ„æ–™>å‚é˜…èµ„æ–™</h2>
<p>æœ¬æ–‡æ—¢æ˜¯ä¸ºå…¬å¸å¼•å…¥æ–°æŠ€æœ¯è¿›è¡Œè¯•æ¢ï¼ŒåŒæ—¶ä¹Ÿæ˜¯è‡ªæˆ‘å­¦ä¹ çš„è®°å½•ï¼Œæ­¤å‰æ¥è§¦çš„å­¦ä¹ ææ–™åŠæ’°å†™æœ¬æ–‡æ—¶æŸ¥é˜…çš„èµ„æ–™ï¼Œè¾ƒä¸ºä¼˜ç§€çš„éƒ¨åˆ†åˆ—åœ¨è¿™é‡Œï¼Œä»¥ä¾¿å¿«é€ŸæŸ¥é˜…ã€‚</p>
<ul>
<li><a href=https://qiankunli.github.io/2020/08/10/controller_runtime.html>controller-runtimeæºç åˆ†æ</a></li>
<li><a href=https://github.com/zoetrope/kubebuilder-training>ã¤ãã£ã¦å­¦ã¶Kubebuilder</a>ï¼ˆæ—¥æ–‡æ•™ç¨‹ï¼‰</li>
<li><a href=https://book.kubebuilder.io/>Kubebuilder Book</a> / <a href=https://cloudnative.to/kubebuilder/>ä¸­æ–‡ç‰ˆ</a></li>
<li><a href=https://www.huweihuang.com/kubernetes-notes/code-analysis/kube-controller-manager/sharedIndexInformer.html>kube-controller-manageræºç åˆ†æï¼ˆä¸‰ï¼‰ä¹‹ Informeræœºåˆ¶</a></li>
<li><a href=https://segmentfault.com/a/1190000020359577>kubebuilder2.0å­¦ä¹ ç¬”è®°â€”â€”è¿›é˜¶ä½¿ç”¨</a></li>
<li><a href=https://www.cnblogs.com/charlieroro/p/11112526.html>client-goå’Œgolangæºç ä¸­çš„æŠ€å·§</a></li>
</ul>
<section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p><a href=https://pingcap.com/zh/blog/chaos-mesh>Chaos Mesh - è®©åº”ç”¨è·Ÿæ··æ²Œåœ¨ Kubernetes ä¸Šå…±èˆ</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:2 role=doc-endnote>
<p><a href=https://xie.infoq.cn/article/655c0893ed150ff65f2b7a16f>è‡ªåˆ¶æ–‡ä»¶ç³»ç»Ÿ â€”â€” 02 å¼€å‘è€…çš„ç¦éŸ³ï¼ŒFUSE æ–‡ä»¶ç³»ç»Ÿ</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:3 role=doc-endnote>
<p><a href=http://www.freeoa.net/product/apptool/stress-ng_3456.html>ç³»ç»Ÿå‹åŠ›æµ‹è¯•å·¥å…·-stress-ng</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:4 role=doc-endnote>
<p><a href=https://www.jianshu.com/p/a73f984f53b5>RunC æºç é€šè¯»æŒ‡å—ä¹‹ NameSpace</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
</ol>
</section>
</div>
<footer class=post-footer>
<div class=post-meta>
<time datetime=" 2021-10-21" itemprop=datePublished>Oct 21, 2021</time>
</div>
</footer>
</article>
<script src=https://cdn.jsdelivr.net/npm/tocbot/dist/tocbot.min.js></script>
<aside class=typeface-sans lang=zh-hans>
<nav class=toc></nav>
</aside>
<script>tocbot.init({tocSelector:'.toc',contentSelector:'article',headingSelector:'h1, h2, h3, h4, h5',hasInnerContainers:!0,collapseDepth:"3",positionFixedSelector:".toc",headingsOffset:10})</script>
</div><script src=https://cdn.jsdelivr.net/npm/prismjs@1.24.1/prism.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/prismjs@1.24.1/plugins/filter-highlight-all/prism-filter-highlight-all.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/prismjs@1.24.1/plugins/autoloader/prism-autoloader.min.js></script>
<script>Prism.plugins.filterHighlightAll.add(function(a){return a.language!=="mermaid"})</script>
<script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script>
<script>mermaid.init({startOnLoad:!0},"pre code.language-mermaid",function(){const a=document.querySelectorAll('code.language-mermaid');for(const c of a){c.style.backgroundColor='initial';const b=c.parentNode;b.style.border='none',b.style.textAlign='center',window.darkmode&&!window.darkmode.isActivated()&&(b.style.backgroundColor='initial')}})</script>
</div>
</main><footer class=site-footer>
<div class=wrapper>
<div class=social-links>
<a class="social-link social-github" href=https://github.com/mayocream><svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="currentcolor" d="M12 2A10 10 0 002 12c0 4.42 2.87 8.17 6.84 9.5C9.34 21.58 9.5 21.27 9.5 21 9.5 20.77 9.5 20.14 9.5 19.31 6.73 19.91 6.14 17.97 6.14 17.97c-.46-1.16-1.11-1.47-1.11-1.47C4.12 15.88 5.1 15.9 5.1 15.9 6.1 15.97 6.63 16.93 6.63 16.93 7.5 18.45 8.97 18 9.54 17.76 9.63 17.11 9.89 16.67 10.17 16.42c-2.22-.25-4.55-1.11-4.55-4.92.0-1.11.38-2 1.03-2.71C6.55 8.54 6.2 7.5 6.75 6.15c0 0 .84-.27 2.75 1.02C10.29 6.95 11.15 6.84 12 6.84s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02C17.8 7.5 17.45 8.54 17.35 8.79 18 9.5 18.38 10.39 18.38 11.5c0 3.82-2.34 4.66-4.57 4.91C14.17 16.72 14.5 17.33 14.5 18.26c0 1.34.0 2.42.0 2.74.0.27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0012 2z"/></svg>
</a>
<a class="social-link social-rss" href=/index.xml target=_blank><svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="currentcolor" d="M6.18 15.64a2.18 2.18.0 012.18 2.18C8.36 19 7.38 20 6.18 20 5 20 4 19 4 17.82a2.18 2.18.0 012.18-2.18M4 4.44A15.56 15.56.0 0119.56 20H16.73A12.73 12.73.0 004 7.27V4.44M4 10.1A9.9 9.9.0 0113.9 20H11.07A7.07 7.07.0 004 12.93V10.1z"/></svg>
</a>
</div>
<div class=credits>
Theme KAGAMI by Kamikat
</div>
</div>
</footer><script>(function(a){for(var a=Array.prototype.slice.call(document.getElementsByClassName('baseline-fix')),b=0,c;b!=a.length;b++)c=a[b],c.innerHTML=c.innerHTML.replace(/[\u2000-\u206eâ¸€-\u2e7eâº€-\u2efeâ¼€-\u2fdeâ¿°-\u2ffe\u3000-ã€¾\u3040-ã‚ã‚ -ãƒ¾\u3100-\u312e\u3130-ã†ã†-ã†ã† -\u31beã‡€-\u31eeã‡°-ã‡¾ãˆ€-ã‹¾ãŒ€-ã¾ã€-\u4dbeä¸€-\u9ffe\ua960-\ua97eê°€-\ud7ae\ud7b0-\ud7feï¤€-\ufafeï¸°-ï¹\uff00-ï¿®]|[\ud840-\ud868\ud86a-\ud86c][\udc00-\udfff]|\ud82c[\udc00-\udcfe]|\ud869[\udc00-\udede\udf00-\udfff]|\ud86d[\udc00-\udf3e\udf40-\udfff]|\ud86e[\udc00-\udc1e]|\ud87e[\udc00-\ude1e]/g,function(a){return'<span class="baseline-fix-block">'+a+'<'+'/span>'}),c.classList.remove('baseline-fix')})(Array.prototype.slice.call(document.getElementsByClassName('baseline-fix')))</script>
<script type=text/javascript>const resize=function(){this.width=.5*(this.naturalWidth||this.width)};Array.prototype.forEach.call(document.querySelectorAll('.half-size, .retina2x'),function(a){a.naturalWidth?resize.call(a):a.onload=resize})</script>
<script src=https://cdn.jsdelivr.net/npm/twemoji@13.1.0/dist/twemoji.min.js></script>
<script>twemoji.parse(document.body,{folder:'svg',ext:'.svg'})</script>
</body>